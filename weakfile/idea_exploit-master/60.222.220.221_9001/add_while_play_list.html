<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>直播编排</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="js/dialog/jquery.ui.all.css"/>

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.bgiframe-2.1.2.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.core.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.widget.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.mouse.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.draggable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.position.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.resizable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.dialog.js"></script>
	<script type="text/javascript" src="js/ref_encode.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/encoder.js" ></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/time2.js" ></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript">
		var FLV_FileIsNotAllowedToEmpty ; //  FLV 文件不允许为空 !
		var VideoStartTimeFormatIsNotCorrect ; //  视频开始时间格式不正确
		var VideoDurationIsNotCorrect ; //  视频持续时间格式不正确
		var FailedToGetData ; // 获取数据失败
		var SelectVideo ; // 选择视频
		var Add ; // 添加
		var UpwardShift ; // 上移
		var DownwardMovement ; // 下移
		var Remove ; // 移除
		var SelectMedia ;// 选择媒体
		var DataNotEmpty;
		var TimeError;
		var objSub ="";
		var openStatus;
		var getresolution = "-1";
		var maxId = 0;
		var liveId;
		var host = window.location.hostname;
		var port = window.location.port;
		(function($){
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			};
		})(jQuery);

		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');
			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#OpenTranscoding').html($.i18n.prop('VideoTranscoding'));
					$('#open_Transfer').html($.i18n.prop('Open'));
					$('#close_1').html($.i18n.prop('Close'));
					$('#open_1').html($.i18n.prop('Open'));
					$('#close_Transfer').html($.i18n.prop('Close'));
					$('#transfer_button').val($.i18n.prop('CarouselConfiguration'));
					$('#cli_button').val($.i18n.prop('SliceConfiguration'));
					$('#video_start').html($.i18n.prop('Type'));
					$('#video_path').html($.i18n.prop('VideoPath'));
					$('#video_duration').html($.i18n.prop('VideoDuration'));
					$('#SelectVideo').val($.i18n.prop('VideoOnDemand'));
					$('#add').attr("title",$.i18n.prop('Add'));
					$('#Remove').attr("title",$.i18n.prop('Remove'));
					$('#Upward').attr("title",$.i18n.prop('UpwardShift'));
					$('#down').attr("title",$.i18n.prop('DownwardMovement'));
					$('#td_1').html($.i18n.prop('Name'));
					$('#td_3').html($.i18n.prop('Time'));
					$('#td_4').html($.i18n.prop('Name'));
					$("#mydialogform").val($.i18n.prop('Determine'));
					$("#mydialogform_1").val($.i18n.prop('Cancel'));
					$("#selectVideo").val($.i18n.prop('SelectVideo'));
					FLV_FileIsNotAllowedToEmpty = $.i18n.prop('FLV_FileIsNotAllowedToEmpty') ;
					VideoStartTimeFormatIsNotCorrect = $.i18n.prop('VideoStartTimeFormatIsNotCorrect') ;
					VideoDurationIsNotCorrect = $.i18n.prop('VideoDurationIsNotCorrect') ;
					FailedToGetData = $.i18n.prop('FailedToGetData') ;
					SelectVideo = $.i18n.prop('SelectVideo') ;
					SelectMedia = $.i18n.prop('SelectMedia') ;
					DataNotEmpty = $.i18n.prop('DataNotEmpty') ;
					TimeError = $.i18n.prop('TimeError') ;

				}
			});
			liveId = $.getUrlParam("id");
			$.ajax({
				type:"GET",
				url:locationHref+"/rest/admin/lives/"+liveId,//获取一个直播频道
				success: function (data) {
					objSub = data;
					var listItem = data.listItem;
					var transfId = listItem.transfId;
					openStatus = transferInfo(transfId);
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}

			})
		});


		function transferInfo(transfId)
		{
			var tranStatus;
			$.ajax({
				type: "GET",
				async:false,
				url: locationHref+"/rest/admin/transfer/"+transfId+"/transferPlan",//获取转码方案
				success: function(transferData)
				{
					var tranObj = transferData;
					if(tranObj != "")
					{
						tranStatus = tranObj.vTransfer;
					}
				},
				error:function()
				{

				}
			})

			return tranStatus;
		}

		function addWhileList()
		{
			var flag = true;
			var live = objSub;
			var listItem = live.listItem;
			var transfId = listItem.transfId;
			var whileType = listItem.type;
			var whileMode = listItem.mode;
			var mvlist = listItem.mvlist;
			var itemId,itemname,type,value,media_time;
			var arr = new Array();
			$("#main_body").find(".item").each(function(e) {
				$(this).find("input").each(function (f) {
					if (f == 0) {
						itemId = $(this).val();
					}
					else if (f == 1) {
						itemname = $(this).val();
					}
					else if (f == 2) {
						type = $(this).val();
					}
					else if (f == 3) {
						value = $(this).val();
						if(value == "")
						{
							flag = false;
						}
					}
					else if(f == 5)
					{
						media_time = $(this).val();
					}
				})
				var items = new ItemsWhilePlay(itemId,itemname,type,value,media_time);
				arr[e] = items;
			})

			var mvMaxID = 0;
			var mvname = $("#name").val();
			var startTime = $("#startTime").val();
			var stopTime = $("#stopTime").val();
			var mvlistInfo;
			if(mvlist != "")
			{
				for(var i=0;i<mvlist.length;i++)
				{
					var mvID = parseInt(mvlist[i].listId);
					if(mvID > mvMaxID)
					{
						mvMaxID = mvID;
					}
				}
				mvMaxID += 1;
				mvlistInfo = new MvList(mvMaxID+"",mvname,startTime,stopTime,arr);
				mvlist[mvlist.length] = mvlistInfo;
			}
			else
			{
				mvlist = new Array();
				mvlistInfo = new MvList(mvMaxID+"",mvname,startTime,stopTime,arr);
				mvlist[0] = mvlistInfo;
			}
			var listItemSub = new PlayWhileItem(mvlist,transfId,whileType,whileMode);

			//频道
			var alias = live.alias;
			var appName = live.appName;
			var autoClosePull = live.autoClosePull;
			var dataPath = live.dataPath;
			var delaySeconds = live.delaySeconds;
			var enableHLS = live.enableHLS;
			var enableRTP = live.enableRTP;
			var enableTS = live.enableTS;
			var flvKeyframe = live.flvKeyframe;
			var format = live.format;
			var forwardUrls = live.forwardUrls;
			var hlsStatus = live.hlsStatus;
			var id = live.id;
			var intervalTime = live.intervalTime;
			var ip = live.ip;
			var keepPlaybackDays = live.keepPlaybackDays;
			var lazyPull = live.lazyPull;
			var lazyPush = live.lazyPush;
			var liveProperty = live.liveProperty;
			var liveStatus = live.liveStatus;
			var name = live.name;
			var outputMode = live.outputMode;
			var outputs = live.outputs;
			var playback = live.playback;
			var publishStatus = live.publishStatus;
			var push = live.push;
			var recordAppend = live.recordAppend;
			var recordEnabled = live.recordEnabled;
			var recordStatus = live.recordStatus;
			var recordType = live.recordType;
			var replaces = live.replaces;
			var right = live.right;
			var splitFileSize = live.splitFileSize;
			var timeToApend = live.timeToApend;
			var tsAddress = live.tsAddress;
			var tsStatus = live.tsStatus;
			var type1 = live.type;
			var pullStream = live.pullStream;
			var transferInfo = live.transferInfo;

			var liveInfo = new LiveChannelInfoWhilePlay(alias,appName,autoClosePull,dataPath,delaySeconds,enableHLS,enableRTP,enableTS,flvKeyframe,format,forwardUrls,hlsStatus,id,intervalTime,ip,keepPlaybackDays,lazyPull,lazyPush,liveProperty,liveStatus,
						name,outputMode,outputs,playback,publishStatus,push,recordAppend,recordEnabled,recordStatus,recordType,replaces,right,splitFileSize,timeToApend,tsAddress,tsStatus,type1,listItemSub,pullStream,transferInfo);

			//alert(stringify(liveInfo))
			if(flag == true && arr.length != 0)
			{
				$.ajax({
					type:"PUT",
					url:locationHref+"/rest/admin/lives/"+liveId,//编辑一个直播频道
					async: false,
					data: stringify(liveInfo),
					dataType:"json",
					success:function(data)
					{
						window.top.art.dialog({id:'addWhileList'}).close();
					},
					error:function(data)
					{
						var errorObj = data;
						var status = data.status;
						var statusText = data.statusText
						if(status == 401 || status == 400)
						{
							top.location.href = "login.html";
						}
					}

				});
			}
			else
			{
				window.top.art.dialog({id:"tishi",content:DataNotEmpty+"!",time:1});
			}
		}

		function m_add(obj)
		{
			maxId += 1;
			var content = $("#main_body").find(".item").first().clone();
			$(content).find("input[type='text']").val("");
			$(content).find("input[name='type']").val("file");
			$(content).find("input[name='time']").val("");
			$(content).find("input[type='button']").show();
			$(content).find("input[id='itemid']").val(maxId);
			$(obj).parent("div").after(content);
		}
		function m_remove(obj)
		{
			var id =  $(obj).parent("div").parent("div").attr("id");
			//if(id != "templ")
			{
				$(obj).parent("div").remove();
			}
		}
		function m_up(obj)
		{
			$(obj).parent("div").insertBefore($(obj).parent("div").prev());
			$(obj).parent("div").find("input").css("color","#990000")
			setTimeout(function(){
				$(obj).parent("div").find("input").css("color","#000")
			},800)
		}
		function m_down(obj)
		{
			$(obj).parent("div").insertAfter($(obj).parent("div").next());

			$(obj).parent("div").find("input").css("color","#990000")
			setTimeout(function(){
				$(obj).parent("div").find("input").css("color","#000")
			},800)

		}
		var path_url = "";
		//选择视频
		function chooseDialog(obj)
		{
			window.top.art.dialog
			(
					{
						id:'choose',iframe:"/media_while_choose.html?type="+openStatus+"&path="+path_url, title:SelectVideo, width:'800', height:'520', lock:true
						//id:'choose',iframe:"/media_while_choose.html?type="+openStatus, title:'选择视频', width:'800', height:'520', lock:true
					},
					function()
					{
						var d = window.top.art.dialog({id:'choose'}).data.iframe;
						var form = d.document.getElementById('dosubmit');
						form.click();
						var mediapath = d.document.getElementById('media_path').value;
						var check_flag = d.document.getElementById('check_flag').value;
						var mediatime = d.document.getElementById('media_time').value;
						if(mediapath !=null && mediapath!="" && check_flag == "true")
						{
							path_url = mediapath;
							var itemvalue_show = mediapath.substr(mediapath.lastIndexOf('/')+1,mediapath.length);
							var itemname_show = itemvalue_show.substr(0,itemvalue_show.lastIndexOf('.'))
							$(obj).prev("input").prev("input").prev("input").prev("input").prev("input").val(itemname_show);//别名显是
							$(obj).prev("input").prev("input").prev("input").val(mediapath);//显示视频路径赋值

							$(obj).prev("input").prev("input").val(itemvalue_show);
							$(obj).prev("input").val(mediatime);
							window.top.art.dialog({id:'choose'}).close();
						}

						return false;
					},
					function()
					{
						window.top.art.dialog({id:'24fsf5'}).close()
					}
			);void(0);
		}
	</script>
	<style type="text/css">
		.title{height:20px}
		.title .t{width: 70px;text-align: center;}
		.title .i{width:323px;text-align:center}
		.item{height:30px;width:850px;}
		.item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
		.item a:hover{text-decoration:none;}
		.f{float: left;}
		.c{text-align: center}
		.fname{display:block;width:75px;height:25px;line-height:25px;float:left;margin-left:26px;text-align:center;}
		.ftstart{display:block;width:65px;height:25px;line-height:25px;float:left;text-align:center;}
		.id{display:block;width:75px;height:25px;line-height:25px;float:left;text-align:center;}
		.fpath{display:block;width:300px;height:25px;line-height:25px;float:left;text-align:center;}
		.ftime{display:block;width:110px;height:25px;line-height:25px;float:left;text-align:center;}
		.item-name{width:75px;}
		.item-path{width:300px;}
		.item-time{width:110px;}
		.item-type{width:60px;}
		.ui-dialog-titlebar{
			background: rgba(0, 0, 0, 0) -moz-linear-gradient(center top , #3580cf, #85b2e3) repeat scroll 0 0;
			box-shadow: none;
			border:none;
			color:#fff;
			border-bottom-style: none;
			background:url('js/dialog/dialog/images/dialog_bar_bg.jpg') repeat-x;
		}
	</style>
</head>

<body>
<div class="pad-10">
	<div class="common-form">
		<form id="myform" method="post" action="" name="myform">

			<table width="100%" class="table_form">
				<tbody>
				<tr>
					<td id="td_1">名称:</td>
					<td><input id="name" name="name" value="" class="input-text" type="text" size="10"></td>
				</tr>
				<tr>
					<td id="td_3">时间</td>
					<td>
						<input type="text" id="startTime" name="startTime" class="input-text" value="" size="10" onclick="_SetTime2(this)" readonly="readonly">-
						<input type="text" id="stopTime" name="stopTime" value=""  class="input-text"  size="10" onclick="_SetTime2(this)" readonly="readonly">
					</td>
				</tr>
				<tr>
					<td colspan="2">
						<div style="float: left">
							<span class="id" id="td_4">名称</span>
							<span class="ftstart" id="video_start">类型</span>
							<span class="fpath" id="video_path">视频路径</span>
							<span class="ftime" id="video_duration">视频时长</span>
						</div>
						<div id="items">
							<div id="main_body">
								<div class='item'>
									<div class='f c'>
										<input type="hidden" id="itemid" value="0" size="10" class='input-text' readonly="readonly"/>
										<input type="text" id="itemname" value="" size="10" class='input-text item-name'/>
										<input type='text' name='type' value='file' size='10' class='input-text item-type'  style="background-color: #90a2bc;" readonly="readonly">
										<input type='hidden' id="flv" name='flv' class='input-text item-path' value='' size='50'>
										<input type='text' id="flv" name='flv' class='input-text item-path' value='' size='50' readonly="readonly">
										<input type='text' id="time" name='time' class='input-text item-time' value='' size='15' readonly="readonly">
										<input type="button" class="button"  onclick="chooseDialog(this)" id="selectVideo" value="选择视频" style="margin-left:18px;"/><br/>
									</div>
										<a href='javascript:;' onclick='m_add(this)' title='添加' id="add">+</a>
										<a href='javascript:;' onclick='m_remove(this)' title='移除' id="Remove">-</a>
										<a href='javascript:;' onclick='m_up(this)' title='上移' style='font-size:10px;' id="Upward">U</a>
										<a href='javascript:;' onclick='m_down(this)' title='下移' style='font-size:10px;' id="down">D</a>
								</div>
							</div>
						</div> <!-- end items -->
					</td>
				</tr>
				</tbody>
			</table>
			<input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
		</form>
	</div>
</div>
</body>
</html>
