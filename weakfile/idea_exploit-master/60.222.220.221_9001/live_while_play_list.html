<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>直播编排</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="js/dialog/jquery.ui.all.css"/>

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.bgiframe-2.1.2.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.core.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.widget.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.mouse.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.draggable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.position.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.resizable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.dialog.js"></script>
	<script type="text/javascript" src="js/ref_encode.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/encoder.js" ></script>
	<script type="text/javascript" src="js/time.js" ></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript">
		var FLV_FileIsNotAllowedToEmpty ; //  FLV 文件不允许为空 !
		var VideoStartTimeFormatIsNotCorrect ; //  视频开始时间格式不正确
		var VideoDurationIsNotCorrect ; //  视频持续时间格式不正确
		var FailedToGetData ; // 获取数据失败
		var SelectVideo ; // 选择视频
		var Add ; // 添加
		var UpwardShift ; // 上移
		var DownwardMovement ; // 下移
		var Remove ; // 移除
		var SelectMedia ;// 选择媒体
		var objSub ="";
		var openStatus;
		var getresolution = "-1";
		var maxId = 0;
		var host = window.location.hostname;
		var port = window.location.port;
		(function($){
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			};
		})(jQuery);

		var whileLiveId = $.getUrlParam("id");
		var EditList;
		var AddList
		var Delete;
		var Edit;
		var PlayingNow;
		var Manualmode;
		var Timingmode;
		var Topplayer;
		$(function(){
			Init_license(authorization);
			$.ajaxSetup({ cache: false });
			var Languages = $.cookie('internationalization');
			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#OpenTranscoding').html($.i18n.prop('VideoTranscoding'));
					$('#open_Transfer').html($.i18n.prop('Open'));
					$('#close_1').html($.i18n.prop('Close'));
					$('#open_1').html($.i18n.prop('Open'));
					$('#close_Transfer').html($.i18n.prop('Close'));
					$('#transfer_button').val($.i18n.prop('CarouselConfiguration'));
					$('#cli_button').val($.i18n.prop('SliceConfiguration'));
					$('#video_path').html($.i18n.prop('VideoPath'));
					$('#SelectVideo').val($.i18n.prop('VideoOnDemand'));
					$('#add').attr("title",$.i18n.prop('Add'));
					$('#Remove').attr("title",$.i18n.prop('Remove'));
					$('#Upward').attr("title",$.i18n.prop('UpwardShift'));
					$('#down').attr("title",$.i18n.prop('DownwardMovement'));
					$('#td_1').html($.i18n.prop('Sort'));
					$('#td_3').html($.i18n.prop('Name'));
					$('#td_4').html($.i18n.prop('Time'));
					$('#td_5').html($.i18n.prop('Operation'));
					$("#addList").html($.i18n.prop('AddList'));
					$("#sort").val($.i18n.prop('Topplayer'))
					$("#mydialogform").val($.i18n.prop('Determine'));
					$("#mydialogform_1").val($.i18n.prop('Cancel'));
					FLV_FileIsNotAllowedToEmpty = $.i18n.prop('FLV_FileIsNotAllowedToEmpty') ;
					VideoStartTimeFormatIsNotCorrect = $.i18n.prop('VideoStartTimeFormatIsNotCorrect') ;
					VideoDurationIsNotCorrect = $.i18n.prop('VideoDurationIsNotCorrect') ;
					FailedToGetData = $.i18n.prop('FailedToGetData') ;
					SelectVideo = $.i18n.prop('SelectVideo') ;
					SelectMedia = $.i18n.prop('SelectMedia') ;
					Delete = $.i18n.prop('Delete') ;
					AddList = $.i18n.prop('AddList') ;
					EditList = $.i18n.prop('EditList') ;
					Edit = $.i18n.prop('Edit') ;
					PlayingNow = $.i18n.prop('PlayingNow') ;
					Manualmode = $.i18n.prop('Manualmode') ;
					Timingmode = $.i18n.prop('Timingmode') ;
					Topplayer =  $.i18n.prop('Topplayer') ;

				}
			});
			var liveId = $.getUrlParam("id");
			$.ajax({
				type:"GET",
				url:locationHref+"/rest/admin/lives/"+liveId,//获取一个直播频道
				success: function (data) {
					objSub = data;
					var obj = data;
					init_whole_page(data);
					//checkA(openStatus);

				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
					else if(status == 409)
					{
						window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
					}
				}
			})
		});

		function checkA(status) {
			if (openStatus == "false") {
				$("#asize").hide();
			}
		}

		function init_whole_page(obj)
		{
			var object = obj;
			var objPlayItem = "";
			try
			{
				objPlayItem = object.listItem;
			}
			catch(e)
			{
				window.top.art.dialog({id:"mesg",content:FailedToGetData +" !",time:1});
				return ;
			}
			var transfId = objPlayItem.transfId;
			var childItem = objPlayItem.mvlist;
			if(childItem != '')
			{
				var dom = "";
				for(var j=0;j<childItem.length;j++)
				{
					var listId = childItem[j].listId;
					var mvName = childItem[j].name;
					var startTime = childItem[j].startTime;
					var stopTime = childItem[j].stopTime;
					var items = childItem[j].items;

					dom+='<tr>';
					if(j == 0)
					{
						dom+='<td align="center"><span style="color: green;">'+PlayingNow+'</span></td>';
					}
					else
					{
						dom+='<td align="center"><input type="button" value="'+Topplayer+'" size="2" id="sort" name="sort" onclick="topPlayList('+listId+')"></td>';
					}
					//dom+='<td align="center">'+listId+'</td>';
					dom+='<td align="center" >'+mvName+'</td>';
					dom+='<td align="center" >'+startTime+'-'+stopTime+'</td>';
					var update = '<a href="javascript:;" onclick="updateList(\''+listId+'\')" class="ext_btn ext_btn_submit ext_btn_size">'+Edit+'</a>&nbsp';
					var del = '<a href="javascript:;" onclick="delList(\''+listId+'\')" class="ext_btn_red ext_btn_size">'+Delete+'</a>&nbsp';
					dom+='<td align="center">';
					dom+=''+update+'';
					dom+=''+del+'';
					dom+='</td>';
					dom+='</tr>';
					$("#main_body").html(dom);
				}
			}
		}

		//添加播放列表
		function addList()
		{
			window.top.art.dialog
			(
					{
						id:'addWhileList',iframe:'add_while_play_list.html?id='+whileLiveId, title:AddList, width:'850', height:'400', lock:true,window:'top'
					},
					function(){
						var d = window.top.art.dialog({id:'addWhileList'}).data.iframe;
						d.addWhileList();
						window.location.reload();
						return false;
					},
					function()
					{
						window.top.art.dialog({id:'addWhileList'}).close();
					}
			);void(0);
		}

		//编辑播放列表
		function updateList(listId)
		{
			window.top.art.dialog
			(
					{
						id:'editWhileList',iframe:'edit_while_play_list.html?id='+whileLiveId+"&listId="+listId, title:EditList, width:'850', height:'400', lock:true,window:'top'
					},
					function(){
						var d = window.top.art.dialog({id:'editWhileList'}).data.iframe;
						d.editWhileList();
						window.location.reload();
						return false;
					},
					function()
					{
						window.top.art.dialog({id:'editWhileList'}).close();
					}
			);void(0);
		}

		//删除播放列表
		function delList(belistId)
		{
			window.top.art.dialog
			(
					{
						id:'del',content:Delete, title:Delete,lock:true
					},
					function(){
						delListById(belistId);
						window.top.art.dialog({id:'del'}).close()
						window.location.reload();
						return true;
					},
					function()
					{
						window.top.art.dialog({id:'del'}).close()
					}
			)
		}
		function delListById(belistId)
		{
			var liveObj = objSub;
			var alias = liveObj.alias;
			var appName = liveObj.appName;
			var autoClosePull = liveObj.autoClosePull;
			var dataPath = liveObj.dataPath;
			var delaySeconds = liveObj.delaySeconds;
			var enableHLS = liveObj.enableHLS;
			var enableRTP = liveObj.enableRTP;
			var enableTS = liveObj.enableTS;
			var flvKeyframe = liveObj.flvKeyframe;
			var format = liveObj.format;
			var forwardUrls = liveObj.forwardUrls;
			var hlsStatus = liveObj.hlsStatus;
			var liveId = liveObj.id;
			var intervalTime = liveObj.intervalTime;
			var ip = liveObj.ip;
			var keepPlaybackDays = liveObj.keepPlaybackDays;
			var lazyPull = liveObj.lazyPull;
			var liveProperty = liveObj.liveProperty;
			var liveStatus = liveObj.liveStatus;
			var name = liveObj.name;
			var outputMode = liveObj.outputMode;
			var outputs = liveObj.outputs;
			var playback = liveObj.playback;
			var publishStatus = liveObj.publishStatus;
			var push = liveObj.push;
			var recordAppend = liveObj.recordAppend;
			var recordEnabled = liveObj.recordEnabled;
			var recordStatus = liveObj.recordStatus;
			var recordType = liveObj.recordType;
			var replaces = liveObj.replaces;
			var right = liveObj.right;
			var splitFileSize = liveObj.splitFileSize;
			var timeToApend = liveObj.timeToApend;
			var tsAddress = liveObj.tsAddress;
			var tsStatus = liveObj.tsStatus;
			var type1 = liveObj.type;
			var objPlayItem = liveObj.listItem;
			var pullStream = liveObj.pullStream;
			var transferInfo = liveObj.transferInfo;
			var transfId = objPlayItem.transfId;
			var whileType = objPlayItem.type;
			var whileMode = objPlayItem.mode;
			var mvlist = objPlayItem.mvlist;
			var array = new Array();
			if(mvlist != '')
			{
				var count = 0;
				for(var i=0;i<mvlist.length;i++)
				{
					var listId = mvlist[i].listId;
					var items = mvlist[i].items;
					var mvname = mvlist[i].name;
					var startTime = mvlist[i].startTime;
					var stopTime = mvlist[i].stopTime;
					if(parseInt(belistId) != parseInt(listId))
					{
						var listMv = new MvList(listId,mvname,startTime,stopTime,items);
						array[count] = listMv;
						count++;
					}
				}
			}
			var listItem = new PlayWhileItem(array,transfId,whileType,whileMode);
			var liveinfo = new LiveChannelInfoEditWhile(alias,appName,autoClosePull,dataPath,delaySeconds,enableHLS,enableRTP,enableTS,flvKeyframe,format,forwardUrls,hlsStatus,liveId,intervalTime,ip,keepPlaybackDays,lazyPull,liveProperty,liveStatus,
					name,outputMode,outputs,playback,publishStatus,push,recordAppend,recordEnabled,recordStatus,recordType,replaces,right,splitFileSize,timeToApend,tsAddress,tsStatus,type1,listItem,pullStream,transferInfo);
			//alert(stringify(liveinfo));
			$.ajax({
				type:"PUT",
				url:locationHref+"/rest/admin/lives/"+liveId,//编辑一个直播频道
				async: false,
				data: stringify(liveinfo),
				dataType:"json",
				success:function(data)
				{
					window.location.reload();

				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
					else if(status == 409)
					{
						window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
					}
				}
			});
		}

		//置顶播放
		function topPlayList(beforedId)
		{
			var liveObj = objSub;
			var alias = liveObj.alias;
			var appName = liveObj.appName;
			var autoClosePull = liveObj.autoClosePull;
			var dataPath = liveObj.dataPath;
			var delaySeconds = liveObj.delaySeconds;
			var enableHLS = liveObj.enableHLS;
			var enableRTP = liveObj.enableRTP;
			var enableTS = liveObj.enableTS;
			var flvKeyframe = liveObj.flvKeyframe;
			var format = liveObj.format;
			var forwardUrls = liveObj.forwardUrls;
			var hlsStatus = liveObj.hlsStatus;
			var liveId = liveObj.id;
			var intervalTime = liveObj.intervalTime;
			var ip = liveObj.ip;
			var keepPlaybackDays = liveObj.keepPlaybackDays;
			var lazyPull = liveObj.lazyPull;
			var liveProperty = liveObj.liveProperty;
			var liveStatus = liveObj.liveStatus;
			var name = liveObj.name;
			var outputMode = liveObj.outputMode;
			var outputs = liveObj.outputs;
			var playback = liveObj.playback;
			var publishStatus = liveObj.publishStatus;
			var push = liveObj.push;
			var recordAppend = liveObj.recordAppend;
			var recordEnabled = liveObj.recordEnabled;
			var recordStatus = liveObj.recordStatus;
			var recordType = liveObj.recordType;
			var replaces = liveObj.replaces;
			var right = liveObj.right;
			var splitFileSize = liveObj.splitFileSize;
			var timeToApend = liveObj.timeToApend;
			var tsAddress = liveObj.tsAddress;
			var tsStatus = liveObj.tsStatus;
			var type1 = liveObj.type;
			var objPlayItem = liveObj.listItem;
			var pullStream = liveObj.pullStream;
			var transferInfo = liveObj.transferInfo;
			var transfId = objPlayItem.transfId;
			var whileType = objPlayItem.type;
			var whileMode = objPlayItem.mode;
			var mvlist = objPlayItem.mvlist;
			var array_old;
			var array_one;
			var old_index;
			if(mvlist != '')
			{
				for(var i=0;i<mvlist.length;i++)
				{
					var listId = mvlist[i].listId;
					var items = mvlist[i].items;
					var mvname = mvlist[i].name;
					var startTime = mvlist[i].startTime;
					var stopTime = mvlist[i].stopTime;
					var listMv = new MvList(listId,mvname,startTime,stopTime,items);
					if(beforedId == listId)
					{
						old_index = i;
						array_old = listMv;
					}
				}
				array_one = mvlist[0];
			}

			mvlist.splice(0,1,array_old);
			mvlist.splice(old_index,1,array_one);

			var listItem = new PlayWhileItem(mvlist,transfId,whileType,whileMode);

			var liveinfo = new LiveChannelInfoEditWhile(alias,appName,autoClosePull,dataPath,delaySeconds,enableHLS,enableRTP,enableTS,flvKeyframe,format,forwardUrls,hlsStatus,liveId,intervalTime,ip,keepPlaybackDays,lazyPull,liveProperty,liveStatus,
					name,outputMode,outputs,playback,publishStatus,push,recordAppend,recordEnabled,recordStatus,recordType,replaces,right,splitFileSize,timeToApend,tsAddress,tsStatus,type1,listItem,pullStream,transferInfo);
			//alert(stringify(liveinfo));
			$.ajax({
				type:"PUT",
				url:locationHref+"/rest/admin/lives/"+liveId,//编辑一个直播频道
				async: false,
				data: stringify(liveinfo),
				dataType:"json",
				success:function(data)
				{
					window.location.reload();

				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
					else if(status == 409)
					{
						window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
					}
				}

			});
		}

	</script>
</head>

<body>
<div class="pad-10">
	<div class="common-form">
		<div class="content-menu ib-a  line-x" >
			<a href="javascript:;" onclick="addList()" id="addList" class="ext_btn ext_btn_success">添加列表</a>
		</div>
		<form id="myform" method="post" action="" name="myform">
			<div class="table-list">
				<table width="100%" class="list_table" id="mytable">
					<thead>
					<tr>
						<th align="center" id="td_1">排序</th>
						<!--<th align="center">id</th>-->
						<th align="center" id="td_3">名称</th>
						<th align="center" id="td_4">时间</th>
						<th align="center" id="td_5">操作</th>
					</tr>
					</thead>
					<tbody id="main_body">

					</tbody>
				</table>
			</div>
			<input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
		</form>
	</div>
</div>
</body>
</html>
