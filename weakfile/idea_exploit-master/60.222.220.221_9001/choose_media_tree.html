<!DOCTYPE html>
<html style="height: 98%;">
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="/css/ztree/zTreeStyle.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="css/dialog.css">
    <script type="text/javascript" src="js/dialog.js"></script>
    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="/css/ztree/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="js/add_edit_live.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/bean.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
    <script type="text/javascript">
        $.getUrlParam = function(name)
        {
            var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r!=null) return unescape(r[2]); return null;
        }
        var beforeId = $.getUrlParam("beforeId");
        var beforeName = decodeURI($.getUrlParam("beforeName"));
        var beforeVisible = $.getUrlParam("beforeVisible");
        var beforeVipLevel = $.getUrlParam("beforeVipLevel");
        var beforeBPublic = $.getUrlParam("beforeBPublic");

        $(function(){
            Init_license(authorization);
            $.ajaxSetup({ cache: false });
            init_tree();
        })

        var setting = {
            data: {
                key: {
                    name:"name",
                    children:"subNames",
                    title:"name",
                    url:"url"
                }
            },
            callback: {
                onClick: zTreeOnClick
            }
        };


        function zTreeOnClick(event, treeId, treeNode)
        {
            $("#treeDemo").find("a").each(function(i){
                $(this).removeClass("curSelectedNode");
            })

            $("#"+treeNode.tId+"_a").addClass("curSelectedNode");
        }

        var zNodes = new Array();
        function init_tree()
        {
            $.ajax({
                type: "GET",
                async: false,
                url: locationHref+"/rest/admin/vodTypes",//获取所有媒体分类
                success: function(data)
                {
                    var obj = data;
                    if(obj != "")
                    {
                        var MainCategoryInfo;
                        var count = 0;
                        for(var i=0;i<obj.length;i++)
                        {
                            var id = obj[i].id;
                            var name = obj[i].name;
                            var visible = obj[i].visible;
                            var bPublic = obj[i].bPublic;
                            var vipLevel = obj[i].vipLevel;
                            var subNames = obj[i].subNames;
                            var subNameInfo = null;
                            var url = "/choose_media_library.html?id="+id+'&name='+encodeURIComponent(encodeURIComponent(name))+'&visible='+visible;
                            url+="&beforeId="+beforeId+"&beforeName="+beforeName+"&beforeVisible="+beforeVisible+"&beforeVipLevel="+beforeVipLevel+"&beforeBPublic="+beforeBPublic;
                            var subArray = new Array();
                            if(subNames != "")
                            {
                                for(var j=0;j<subNames.length;j++)
                                {
                                    var subid = subNames[j].id;
                                    var subName = subNames[j].name;
                                    var subvisible = subNames[j].visible;
                                    var subBPublic = subNames[j].bPublic;
                                    var subVipLevel = subNames[j].vipLevel;
                                    var suburl = "/choose_media_library.html?id="+subid+'&name='+encodeURIComponent(encodeURIComponent(subName))+'&visible='+subvisible;
                                    suburl+="&beforeId="+beforeId+"&beforeName="+beforeName+"&beforeVisible="+beforeVisible+"&beforeVipLevel="+beforeVipLevel+"&beforeBPublic="+beforeBPublic;
                                    subNameInfo = new SubCategory(subName,suburl,subBPublic,subVipLevel);
                                    subArray[j] = subNameInfo;
                                }
                            }
                            var catOpen = true;
                            if(i == 0)
                            {
                                MainCategoryInfo = new MainCategoryOpen(name,catOpen,subArray,url);
                            }
                            else
                            {
                                MainCategoryInfo = new MainCategory(name,subArray,url);
                            }
                            if(id == "" || id.indexOf("lu_") != "-1")
                            {
                                zNodes[count] = MainCategoryInfo;
                                count++;
                            }
                        }
                    }
                },
                error:function(data)
                {
                    var errorObj = data;
                    var status = data.status;
                    var statusText = data.statusText
                    if(status == 401 || status == 400)
                    {
                        top.location.href = "login.html";
                    }
                }
            })
        }

        $(document).ready(function(){
            $.fn.zTree.init($("#treeDemo"), setting, zNodes);
            var treeObj=$.fn.zTree.getZTreeObj("treeDemo");
            //treeObj.expandAll(true);  展开折叠所有节点  true  false
            //拿到所有树节点
            var nodes = treeObj.transformToArray(treeObj.getNodes());
            //var nodes = treeObj.getNodes();
            //for循环逐个修改树节点属性
            if(nodes != "" && nodes != null)
            {
                for(var i = 0;i<nodes.length;i++)
                {
                    //更新节点
                    nodes[i].target="media_right";
                    treeObj.updateNode(nodes[i]);
                }
                $("#treeDemo_1_a").addClass("curSelectedNode");
                window.open(nodes[0].url, "media_right");
            }
        });
    </script>
</head>

<body style="height: 100%;">
    <div class="pad-10" id="content" style="height: 100%;">
        <div style="width: 15%;height: 98%;border: 1px solid #c2d1d8;float: left;">
            <ul id="treeDemo" class="ztree"></ul>
        </div>
        <div style="width: 84%;height: 100%;float: left;">
            <iframe name="media_right" id="media_right" src="" frameborder="no" scrolling="yes" width="100%" height="100%" allowtransparency="true"></iframe>
        </div>
    </div>
</body>
</html>