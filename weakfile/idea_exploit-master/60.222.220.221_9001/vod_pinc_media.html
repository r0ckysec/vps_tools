<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title></title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="js/dialog/jquery.ui.all.css"/>

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script src="js/dialog/jquery.bgiframe-2.1.2.js"></script>
	<script src="js/dialog/jquery.ui.core.js"></script>
	<script src="js/dialog/jquery.ui.widget.js"></script>
	<script src="js/dialog/jquery.ui.mouse.js"></script>
	<script src="js/dialog/jquery.ui.draggable.js"></script>
	<script src="js/dialog/jquery.ui.position.js"></script>
	<script src="js/dialog/jquery.ui.resizable.js"></script>
	<script src="js/dialog/jquery.ui.dialog.js"></script>
	<script src="js/ref_encode.js"></script>
	<script src="js/jquery.form.js"></script>
	<script src="js/encoder.js" ></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript" src="js/player.js" charset="utf-8"></script>
	<script type="text/javascript" src="ckplayer/ckplayer.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/time2.js" ></script>
	<script type="text/javascript" src="js/changStatus.js" ></script>
	<script type="text/javascript" src="ckplayer/ckplayer.js" charset="utf-8"></script>
	<script type="text/javascript">
		var InformationIsNotCorrect ;
		var PleaseSelectTranscodingScheme;
		var addTransfer;
		var PleaseInputVideoName;
		var DoNotSameName;
		var SelectDemandClassification;
		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');

			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#information').html($.i18n.prop('EssentialInformation'));
					$('#td_1').html($.i18n.prop('VideoTitle'));
					$('#td_2').html($.i18n.prop('TranscodingScheme'));
					$('#dosubmit').val($.i18n.prop('Determine'));
					$('#video_Continued').html($.i18n.prop('StartTime'));
					$('#video_start').html($.i18n.prop('EndTime'));
					$('#td_3').html($.i18n.prop('VODCategory'));
					InformationIsNotCorrect = $.i18n.prop('InformationIsNotCorrect');
					PleaseSelectTranscodingScheme = $.i18n.prop('PleaseSelectTranscodingScheme') ;
					addTransfer = $.i18n.prop('AddTransfer') ;
					PleaseInputVideoName = $.i18n.prop('PleaseInputVideoName') ;
					DoNotSameName = $.i18n.prop('DoNotSameName') ;
					SelectDemandClassification = $.i18n.prop('SelectDemandClassification') ;
				}
			});
			createTfServerSelect("tfServerOuter");
			createTfServerSelect_type("tfServerOuter_type");
		});

		(function($){
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			}
		})(jQuery);

		var beforeName = decodeURI($.getUrlParam("name"));
		var beforePlayUrl = decodeURI($.getUrlParam("url"));
		var beforePath = decodeURI($.getUrlParam("path"));
		
		function auto_set_time(obj)
		{	
			var time = $("#curtime").text();
			var tformat = parseSecond(time)
			$(obj).val(tformat)	;	
		}

		//将秒数格式化为00:00:00
		function parseSecond(seconds)
		{
			  var sec_num = parseInt(seconds);
			  var hours   = Math.floor(sec_num / 3600);
			  var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
			  var seconds = sec_num - (hours * 3600) - (minutes * 60);

			  if (hours   < 10) {hours   = "0"+hours;}
			  if (minutes < 10) {minutes = "0"+minutes;}
			  if (seconds < 10) {seconds = "0"+seconds;}
			  if(hours === "00")
			  {
				var time = "00:"+minutes+':'+seconds;
			  }
			  else
			  {
				 var time = hours+':'+minutes+':'+seconds;
			  }
			  return time;
		}


		/**
		 *  将00:00:00转换为秒数
		 */
		function parseSecondToTime(str)
		{

			var hour = parseInt(str.substring(0,str.indexOf(":")));

			var minute = parseInt(str.substring(str.indexOf(":")+1,str.lastIndexOf(":")));
			var second = parseInt(str.substring(str.lastIndexOf(":")+1));

			var total_second = hour* 3600 + minute * 60 + second;

			return total_second;

		}

	</script>
</head>

<body>
	<div class="pad-10">
		<div width="100%">
			<div class="video-outer">
				<div id="main_player" style="width: 400px;height: 300px;float: left;display: inline;"></div>
				<script type="text/javascript">
					var format;
					var beforeNameNull;
					var player
					$(function(){
						$("#mediaName").text(beforeName);
						beforeNameNull = beforeName.substr(0,beforeName.lastIndexOf("."));
						$("#newMediaName").val(beforeNameNull);
						format = beforeName.substr(beforeName.lastIndexOf("."),beforeName.length);

						var headEndTime = "";
						var tailStartTime = "";
						if(beforePlayUrl.substr(beforePlayUrl.lastIndexOf(".")+1,beforePlayUrl.length) == 'm3u8')
						{
							var flashvars={
								f : '/ckplayer/m3u8.swf',//插件地址
								a : beforePlayUrl, //文件地址
								s : 4,
								p : 1,
								g : headEndTime,
								j : tailStartTime,
								loaded : 'loadedHandler',//当播放器加载完成后发送该js函数loaded
								wh:'16:9'
							};
							var params= {bgcolor:'#FFF',allowFullScreen:true,allowScriptAccess:'always',wmode:'transparent'};
							var video=[beforePlayUrl];
							CKobject.embed('/ckplayer/ckplayer.swf','main_player' ,'main_player_object','100%','100%',false, flashvars ,video, params);
						}
						else
						{
							var flashvars = get_flash_var(beforePlayUrl, "", "", "", "", headEndTime,tailStartTime, "", "", "", "","",3)
							CKobject.embed('ckplayer/ckplayer.swf','main_player','main_player_object','100%','100%',false,flashvars,null,null);
							//player = embed_live_player(beforePlayUrl,"","","",null,"","","","","","",false,true);
						}
					})
/*
					function loadedHandler() {
						player.addListener('time', timeHandler); //监听播放时间
					}
					function timeHandler(t)
					{
						$("#curtime").text(t)
					}*/
					function loadedHandler()
					{
						if(CKobject.getObjectById('main_player_object').getType())
						{
							CKobject.getObjectById('main_player_object').addListener('time',timeHandler);
						}
						else
						{
							CKobject.getObjectById('main_player_object').addListener('time','timeHandler');
						}
					}
					function timeHandler(t)
					{
						$("#curtime").text(t)
					}

					function pincMedia()
					{
						var tf_se = $("#tf_select").val();
						if(tf_se == "-1")
						{
							tf_se = "";
						}
						var tf_select_id = $("#tf_select_id").val();
						if(tf_select_id == "-1")
						{
							tf_select_id = "";
						}
						var url = beforePath;
						var path = url.substr(0,url.lastIndexOf("/"));
						var newName = $("#newMediaName").val();
						var outFile1 = path + "/" + newName+format;
						var outFile = outFile1.replaceAll("/","\\");
						var startTime = parseSecondToTime($("#startTime").val());
						var stopTime = parseSecondToTime($("#endTime").val());
						var waterMark = "";
						var waterWidth = 0;
						var waterHeight = 0;
						var tranfers_info = new transfer(tf_se,startTime,stopTime,url,outFile,waterMark,waterWidth,waterHeight,tf_select_id);

						//alert(stringify(tranfers_info))
						if(newName == "")
						{
							window.top.art.dialog({id:"mesg",content:PleaseInputVideoName+"!",time:1});
						}
						else
						{
							if(newName == beforeNameNull)
							{
								window.top.art.dialog({id:"mesg",content:DoNotSameName+"!",time:1});
							}
							else
							{
								$.ajax({
									type: "POST",
									url: locationHref+"/rest/admin/transfer",//视频转码
									async: false,
									data: stringify(tranfers_info),
									success:function(data)
									{
										window.top.art.dialog({id:'pinc'}).close();

									},
									error:function(data)
									{
										var errorObj = data;
										var status = data.status;
										var statusText = data.statusText
										if(status == 401 || status == 400)
										{
											top.location.href = "login.html";
										}
										else if(status == 409)
										{
											window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
										}
									}
								});
							}
						}
					}
				</script>
				<div style="display:none" id="curtime" style="float:left" ></div>
			</div>
			<div class="common-form" style="display: inline;float: left; margin-left: 20px; max-width: 450px;height: 290px;overflow-y:auto;overflow-x:hidden;">
				<form id="myform" method="post" action="" name="myform">
					<table width="100%" class="table_form">
						<tbody>
							<tr>
								<td colspan="2"><div style="display:inline; font-size:14px; font-weight:bold"><span id="td_1">视频标题</span>:<span id="mediaName"></span></div></td>
							</tr>
							<tr>
								<td id="newTitle">新视频标题</td>
								<td>
									<input type="text" name="newMediaName" id="newMediaName" class="input-text" size="20" value="">
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<span id="td_2">转码方案 </span> :<div id="tfServerOuter" style="display:inline;"></div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<span id="td_3">点播分类 </span> :<div id="tfServerOuter_type" style="display:inline;"></div>
								</td>
							</tr>
							<tr>
								<td colspan="2">
									<style type="text/css">
										.title{height:20px}
										.title .t{width: 120px;text-align: center;}
										.title .i{width:203px;text-align:center}
										.item{height:30px;}
										.item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
										.item a:hover{text-decoration:none;}
										.f{float: left;}
										.c{text-align: center}
									</style>
									<script type="text/javascript">
										function m_add(obj)
										{
											var content = $("#templ").html();
											var begin = $(obj).parent("div").parent("div").attr("id");
											if(begin=="templ")
											{
												$("#templ").after(content);
											}
											else
											{
												$(obj).parent("div").after(content);
											}
										}
										function m_remove(obj)
										{
											var id =  $(obj).parent("div").parent("div").attr("id");
											if(id != "templ")
											{
												$(obj).parent("div").remove();
											}
										}
									</script>
									<div class="title">
										<div class="f t" id="video_Continued">开始时间</div>
										<div class="f t" id="video_start">结束时间</div>
									</div>
									<div id="items">
										<div id="templ">
											<div class="item">
												<div class="f">
													<input type="text" class="input-text" value="" id="startTime"  name="startTime" size="20" onfocus="auto_set_time(this)" >
												</div>
												<div class="f">
													<input type="text" class="input-text" value="" id="endTime" name="endTime" size="20" onfocus="auto_set_time(this)">
												</div>
											</div><!-- end item -->
										</div><!-- end templ -->
									</div> <!-- end items -->
								</td>
							</tr>
						</tbody>
					</table>
				</form>
			</div>
		</div>
	</div>
</body>
</html>
