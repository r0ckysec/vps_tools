<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<title>使用jquery.qrcode生成二维码</title>
	<link rel="stylesheet" type="text/css" href="css/main.css" />
	<style type="text/css">
	.demo{width:400px; margin:40px auto 0 auto; min-height:250px;}
	.demo p{line-height:30px}
	#code{margin-top:10px}
	</style>
	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/jquery.qrcode.min.js"></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript">
		(function($){
			$.ajaxSetup({ cache: false });
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			}
			Init_license(authorization);
		})(jQuery);

		var startObj = "";
		var liveObj ="";
		var rtmp_port ="";
		var rtsp_port ="";
		var http_port ="";
		var appName ="";
		var name ="";
		var liveId = $.getUrlParam("id");
		var subName = $.getUrlParam("name");
		$.ajax({
			type:"GET",
			url:locationHref+"/rest/admin/lives/"+liveId,//获取一个直播频道
			success: function (data) {
				liveObj = data;
				var object = data;
				appName = object.appName;
				name = object.name;
				if(subName != '' && subName != "undefined")
				{
					$.ajax({
						type: "GET",
						url: locationHref+"/rest/admin/system/startupInfo",//获取端口配置
						success: function (data) {
							startObj = data;
							var object = JSON.parse(data);
							var rtmp_port = object.port;
							var rtsp_port = object.rtsp_port;
							var http_port = object.http_port;

							var rtmp_play_url = "rtmp://"+host+":"+rtmp_port+"/"+appName+"/"+name+"/"+subName;
							var rtsp_play_url = "rtsp://"+host+":"+rtsp_port+"/"+appName+"/"+name+"/"+subName;
							var hls_play_url = "http://"+host+":"+http_port+"/"+"hls"+"/"+appName+"/"+name+"/"+subName+"/stream.m3u8";
							var rtmpurl = replace_url(rtmp_play_url);
							var rtspurl = replace_url(rtsp_play_url);
							var httpurl = replace_url(hls_play_url);
							getqrcode("rtmp",rtmpurl);
							$("#rtmptext").text(rtmpurl);

							getqrcode("rtsp",rtspurl);
							$("#rtsptext").text(rtspurl);

							getqrcode("http",httpurl);
							$("#httptext").text(httpurl);

						},
						error:function(data)
						{
							var errorObj = data;
							var status = data.status;
							var statusText = data.statusText
							if(status == 401 || status == 400)
							{
								top.location.href = "login.html";
							}
						}

					})
				}
				else if(subName == "undefined")
				{
					$.ajax({
						type: "GET",
						url: locationHref+"/rest/admin/system/startupInfo",//获取端口配置
						success: function (data) {
							startObj = data;
							var object = data;
							var rtmp_port = object.port;
							var rtsp_port = object.rtsp_port;
							var http_port = object.http_port;

							var rtmp_play_url = "rtmp://"+host+":"+rtmp_port+"/"+appName+"/"+name;
							var rtsp_play_url = "rtsp://"+host+":"+rtsp_port+"/"+appName+"/"+name;
							var hls_play_url = "http://"+host+":"+http_port+"/"+"hls"+"/"+appName+"/"+name+"/stream.m3u8";

							var rtmpurl = replace_url(rtmp_play_url);
							var rtspurl = replace_url(rtsp_play_url);
							var httpurl = replace_url(hls_play_url);

							getqrcode("rtmp",rtmpurl);
							$("#rtmptext").text(rtmpurl);

							getqrcode("rtsp",rtspurl);
							$("#rtsptext").text(rtspurl);

							getqrcode("http",httpurl);
							$("#httptext").text(httpurl);

						},
						error:function(data)
						{
							var errorObj = data;
							var status = data.status;
							var statusText = data.statusText
							if(status == 401 || status == 400)
							{
								top.location.href = "login.html";
							}
						}

					})
				}
			},
			error:function(data)
			{
				var errorObj = data;
				var status = data.status;
				var statusText = data.statusText
				if(status == 401 || status == 400)
				{
					top.location.href = "login.html";
				}
			}

		})


		var id = $.getUrlParam("id");
		var host = window.location.hostname;
		var port = window.location.port;

		function replace_url(url)
		{
			var host = window.location.hostname;
			var before = url.substr(0,url.indexOf("//")+2);
			var after = "";

			if(url.substring(before.length).lastIndexOf(":") != -1)
			{
				after = url.substr(url.lastIndexOf(":"));
			}
			else
			{
				var temp = url.substring(before.length);
				after = temp.substring(temp.indexOf("/"));
			}

			return (before+host+after);
		}

		function toUtf8(str) {
			var out, i, len, c;
			out = "";
			len = str.length;
			for(i = 0; i < len; i++) {
				c = str.charCodeAt(i);
				if ((c >= 0x0001) && (c <= 0x007F)) {
					out += str.charAt(i);
				} else if (c > 0x07FF) {
					out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));
					out += String.fromCharCode(0x80 | ((c >>  6) & 0x3F));
					out += String.fromCharCode(0x80 | ((c >>  0) & 0x3F));
				} else {
					out += String.fromCharCode(0xC0 | ((c >>  6) & 0x1F));
					out += String.fromCharCode(0x80 | ((c >>  0) & 0x3F));
				}
			}
			return out;
		}

		function getqrcode(divid,url){
			var documentId = "#"+divid;
			var qrMode = {
				width: 139,
				height:139,
				text: url
			}
			if(navigator.appName.indexOf("Microsoft") != -1){
				//IE
				if(navigator.appVersion.match(/8./i)=="8."){
					//ie8
					qrMode = {
						render: "table",
						width: 139,
						height:139,
						text: url
					}
				}
			}
			$(documentId).qrcode(qrMode);
		}
	</script>
</head>

<body>

<div >
  <div class="aui_outer">
    <table class="aui_border">
      <tbody>
			<tr>
              <table class="aui_dialog">
                <tbody>
                 <tr>
                    <td class="aui_icon" style="display: none;"><div class="aui_iconBg" style="background: transparent none repeat scroll 0% 0%;"></div></td>
                    <td class="aui_main" style="width: 500px; height: 349px;"><div class="aui_content" style="padding: 20px 25px;">
                        <div style="float:left;margin-bottom:10px;text-align: center; width:180px;">
                          <div id="rtmp"></div>
                          <div id="rtmptext" style="font-size:12px;width:140px;"></div>
                        </div>
                        <div style="float:right;margin-bottom:10px;text-align: center; width:180px;">
                          <div id="rtsp"></div>
                          <div id="rtsptext" style="font-size:12px;width:140px;"></div>
                        </div>
                        <div style="float:left;margin-bottom:10px;text-align: center; width:180px;">
                          <div id="http"></div>
                          <div id="httptext" style="font-size:12px;width:140px;"></div>
                        </div>
                      </div></td>
                  </tr>
                </tbody>
              </table>
        </tr>
        
      </tbody>
    </table>
  </div>
</div>


</body>
</html>