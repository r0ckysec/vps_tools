<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>直播编排</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="js/dialog/jquery.ui.all.css"/>

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.bgiframe-2.1.2.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.core.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.widget.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.mouse.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.draggable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.position.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.resizable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.dialog.js"></script>
	<script type="text/javascript" src="js/ref_encode.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/encoder.js" ></script>
	<script type="text/javascript" src="js/time.js" ></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript">
		var VideoStartTimeFormatIsNotCorrect ; //  视频开始时间格式不正确
		var VideoDurationIsNotCorrect ; //  视频持续时间格式不正确
		var FailedToGetData ; // 获取数据失败
		var SelectVideo ; // 选择视频
		var Add ; // 添加
		var UpwardShift ; // 上移
		var DownwardMovement ; // 下移
		var Remove ; // 移除
		var SelectMedia ;// 选择媒体
		var EditList;
		var AddList
		var Delete;
		var Edit;
		var host = window.location.hostname;
		var port = window.location.port;
		(function($){
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			};
		})(jQuery);

		var liveId = $.getUrlParam("id");
		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');
			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#td_1').html($.i18n.prop('Sort'));
					$('#td_6').html($.i18n.prop('Status'));
					$('#td_3').html($.i18n.prop('Name'));
					$('#td_4').html($.i18n.prop('Time'));
					$('#td_5').html($.i18n.prop('Operation'));
					$("#mydialogform").val($.i18n.prop('Determine'));

					$('#add').attr("title",$.i18n.prop('Add'));
					$('#Remove').attr("title",$.i18n.prop('Remove'));
					$('#Upward').attr("title",$.i18n.prop('UpwardShift'));
					$('#down').attr("title",$.i18n.prop('DownwardMovement'));
					$("#addList").html($.i18n.prop('AddList'));
					$("#subStream").val($.i18n.prop('Determine'));
					$("#maxStream").html($.i18n.prop('MaxStream'));


					VideoStartTimeFormatIsNotCorrect = $.i18n.prop('VideoStartTimeFormatIsNotCorrect') ;
					VideoDurationIsNotCorrect = $.i18n.prop('VideoDurationIsNotCorrect') ;
					FailedToGetData = $.i18n.prop('FailedToGetData') ;
					SelectVideo = $.i18n.prop('SelectVideo') ;
					SelectMedia = $.i18n.prop('SelectMedia') ;
					Delete = $.i18n.prop('Delete') ;
					AddList = $.i18n.prop('AddList') ;
					EditList = $.i18n.prop('EditList') ;
					Edit = $.i18n.prop('Edit') ;

				}
			});


			$.ajax({
				type: "GET",
				url: locationHref+"/rest/admin/lives/"+liveId+"/replaceRate",//获取一个直播频道的插播
				success: function (data)
				{
					var obj = data;
					if(obj != '')
					{
						var max = obj.maxRate/1024;
						$("#stream_set").val(max);
					}
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}
			})

			$.ajax({
				type: "GET",
				url:locationHref+"/rest/admin/lives/"+liveId+"/replace",//获取一个直播频道的插播
				success: function (data)
				{
					var obj;
					try
					{
						obj = data;
					}
					catch(e)
					{
						window.top.art.dialog({id:"mesg",content:FailedToGetData +" !",time:1});
						return ;
					}
					var dom ='';
					var count = 0;
					if(obj != '')
					{
						for(var i=0;i<obj.length;i++)
						{
							var listId = obj[i].listId;
							var name = obj[i].name;
							var startTime = obj[i].startTime;
							var stopTime = obj[i].stopTime;
							var list_status = obj[i].status;
							var list_str;
							if(list_status == false || list_status == undefined)
							{
								list_str = '<font id="font'+i+'" style="font-size:14px;font-weight: bold; color: red">×</font>';
							}
							else
							{
								list_str = '<font id="font'+i+'" style="font-size:14px;font-weight: bold; color: green">√</font>';
							}
							var items = obj[i].items;
							if(items != '')
							{
								for(var j=0;j<items.length;j++)
								{
									var itemName = items[j].name;
									var id = items[j].id;
									var status = items[j].status;
									var value = items[j].value;
									var type = items[j].type;
								}
							}
							count++;
							var update = '<a href="javascript:;" onclick="updateList(\''+liveId+'\',\''+listId+'\')" class="ext_btn ext_btn_submit ext_btn_size">'+Edit+'</a>&nbsp';
							var del = '<a href="javascript:;" onclick="delList(\''+liveId+'\',\''+listId+'\')" class="ext_btn_red ext_btn_size">'+Delete+'</a>&nbsp';
							dom += '<tr>';
							dom+='<td align="center">'+count+'</td>';
							dom+='<td align="center" >'+name+'</td>';
							dom+='<td align="center" >'+startTime+'-'+stopTime+'</td>';
							dom+='<td align="center" >'+list_str+'</td>';
							dom+='<td align="center">';
							dom+=''+update+'';
							dom+=''+del+'';
							dom+='</td>';
							dom+='</tr>';
							dom += '</tr>';
						}
						$("#main_body").append(dom);
					}
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}

			})
		});

		//添加列表
		function addList()
		{
			window.top.art.dialog
			(
					{
						id:'addReplaceList',iframe:'add_replace_list.html?id='+liveId, title:AddList, width:'850', height:'400', lock:true,window:'top'
					},
					function(){
						var d = window.top.art.dialog({id:'addReplaceList'}).data.iframe;
						d.addReplaceList();
						window.location.reload();
						return false;
					},
					function()
					{
						window.top.art.dialog({id:'addReplaceList'}).close();
					}
			);void(0);
		}
		//编辑播放列表
		function updateList(id,listId)
		{
			window.top.art.dialog
			(
					{
						id:'editReplaceList',iframe:'edit_replace_list.html?id='+liveId+"&listId="+listId, title:EditList, width:'850', height:'400', lock:true,window:'top'
					},
					function(){
						var d = window.top.art.dialog({id:'editReplaceList'}).data.iframe;
						d.editReplaceList();
						window.location.reload();
						return false;
					},
					function()
					{
						window.top.art.dialog({id:'editReplaceList'}).close();
					}
			);void(0);
		}
		//删除播放列表
		function delList(id,listId)
		{
			window.top.art.dialog
			(
					{
						id:'del',content:Delete, title:Delete,lock:true
					},
					function(){
						delListById(id,listId);
						window.top.art.dialog({id:'del'}).close()
						window.location.reload();
						return true;
					},
					function()
					{
						window.top.art.dialog({id:'del'}).close()
					}
			)
		}

		function delListById(id,listId)
		{
			$.ajax({
				type:"DELETE",
				url:locationHref+"/rest/admin/lives/"+id+"/replace/"+listId,//删除一个直播频道的插播
				async: false,
				success:function(data)
				{
					window.location.reload();
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}
			});
		}

		function StreamInfo(liveId,maxRate)
		{
			this.liveId = liveId;
			this.maxRate = maxRate;
		}

		function setStream()
		{
			var stream_val = $("#stream_set").val();
			var stream_info = new StreamInfo(parseInt(liveId),parseInt(stream_val)*1024);
			$.ajax({
				type:"PUT",
				url: locationHref+"/rest/admin/lives/"+liveId+"/replaceRate",//修改直播频道的最大码流
				async: false,
				data: stringify(stream_info),
				dataType:"json",
				success:function(data)
				{
					window.location.reload();
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}
			});
		}

	</script>
</head>

<body>
<div class="pad-10">
	<div class="common-form">
		<div class="content-menu ib-a  line-x" >
			<a href="javascript:;" onclick="addList()" id="addList" class="ext_btn ext_btn_success">添加列表</a>
			<span style="font-weight: bold;color: #ff231c;" id="maxStream">最大码流:</span>
			<select id="stream_set">
				<option value="8192">8M</option>
				<option value="4096">4M</option>
				<option value="2048">2M</option>
				<option value="1024">1M</option>
				<option value="512">512K</option>
			</select>
			<input type="button" onclick="setStream()"  id="subStream" name="subStream" value="确定">
		</div>
		<form id="myform" method="post" action="" name="myform">
			<div class="table-list">
				<table width="100%" class="list_table" id="mytable">
					<thead>
					<tr>
						<th align="center" id="td_1">排序</th>
						<th align="center" id="td_3">名称</th>
						<th align="center" id="td_4">时间</th>
						<th align="center" id="td_6">状态</th>
						<th align="center" id="td_5">操作</th>
					</tr>
					</thead>
					<tbody id="main_body">

					</tbody>
				</table>
			</div>
			<input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
		</form>
	</div>
</div>
</body>
</html>
