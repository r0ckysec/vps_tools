<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">

    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="css/sp.css" rel="stylesheet" type="text/css" />
    <link href="css/reset.css" rel="stylesheet" type="text/css" />
    <link href="css/system.css" rel="stylesheet" type="text/css" />
    <link href="css/table_form.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
    <script type="text/javascript" src="js/add_edit_live.js"></script>
    <script type="text/javascript" src="js/bean.js"></script>
    <script type="text/javascript">

        $(function(){
            Init_license(authorization);
            var Languages = $.cookie('internationalization');

            if ( Languages == null || Languages == "" )
            {
                Languages = 'zh' ;
            }
            jQuery.i18n.properties({
                name : 'strings', //资源文件名称
                path : '/i18n/', //资源文件路径
                mode : 'map', //用Map的方式使用资源文件中的值
                language : Languages,
                encoding : 'UTF-8', // 必须写 否则中文乱码
                callback : function() {//加载成功后设置显示内容
                    $('#information').html($.i18n.prop('EssentialInformation'));
                    //$('#td_1').html($.i18n.prop('ApplyName'));
                }
            });
        });



        (function($){
            $.getUrlParam = function(name)
            {
                var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r!=null) return unescape(r[2]); return null;
            }
        })(jQuery);
        var before_group_array = $.getUrlParam("gourp");//选中分组数组  只有机顶盒可以操作,devType只能是1
        var before_id = $.getUrlParam("id");
        var before_name = $.getUrlParam("name");

        $(function(){
            $.ajax({
                type: "GET",
                url: locationHref+"/rest/admin/lives",//获取所有直播频道
                success: function (data)
                {
                    var obj = data;
                    if(obj != "")
                    {
                        var dom = "<option value='-1'>取消插播</option>";
                        for(var i=0;i<obj.length;i++)
                        {
                            var liveId = obj[i].id;
                            var appName = obj[i].appName;
                            var liveName = obj[i].name;
                            var name = appName+"/"+liveName;
                            dom += "<option value='"+liveId+"'>"+name+"</option>";
                        }
                        $("#emergency").append(dom);
                    }
                    getGroupLive();
                },
                error:function(data)
                {
                    var errorObj = data;
                    var status = data.status;
                    var statusText = data.statusText
                    if(status == 401 || status == 400)
                    {
                        top.location.href = "login.html";
                    }
                }
            })
        })

        function getGroupLive()
        {
            if(before_group_array.length == 1 && before_id != '0')
            {
                $.ajax({
                    type: "GET",
                    url: locationHref+"/rest/admin/termGroup/1/"+before_id+"/getGroup",//获取所有直播频道
                    success: function (data)
                    {
                        var obj = data;
                        if(obj != "")
                        {
                            var subtitle = obj.subtitle;
                            var forcedLiveId = subtitle.forcedLiveId;
                            $("#emergency").val(forcedLiveId);
                        }
                    },
                    error:function(data)
                    {
                        var errorObj = data;
                        var status = data.status;
                        var statusText = data.statusText
                        if(status == 401 || status == 400)
                        {
                            top.location.href = "login.html";
                        }
                    }
                })
            }
        }

        function emergencyReplace()//紧急插播
        {
            var energency_val = $("#emergency").val();
            if(before_group_array != "" || before_group_array != null)
            {
                var group_arr = before_group_array.split(",");
                //alert(stringify(group_arr))
                if(group_arr != "" || group_arr != null)
                {
                    var count = 0;
                    var group_array_final = new Array();
                    for(var i=0;i<group_arr.length;i++)
                    {
                        var groupId = group_arr[i];
                        if(groupId == "-1" || groupId == "0")
                        {

                        }
                        else
                        {
                            group_array_final[count] = groupId;
                            count++;
                        }
                    }
                    //alert(stringify(group_array_final))

                    if(group_arr.length == 1)//只选择一个选项
                    {
                        $.ajax({
                            type: "PUT",
                            url: locationHref+"/rest/admin/termGroup/forceLiveId/group/"+group_arr[0]+"/"+energency_val,//设置一个分组插播
                            async: false,
                            success: function (data)
                            {

                            },
                            error:function(data)
                            {
                                var errorObj = data;
                                var status = data.status;
                                var statusText = data.statusText
                                if(status == 401 || status == 400)
                                {
                                    top.location.href = "login.html";
                                }
                            }
                        })
                    }
                    else
                    {
                        if(group_arr.indexOf('-1') != -1)//包含 所有分组
                        {
                            $.ajax({
                                type: "PUT",
                                url: locationHref+"/rest/admin/termGroup/forceLiveId/all/"+energency_val,//设置全部分组插播
                                async: false,
                                success: function (data)
                                {

                                },
                                error:function(data)
                                {
                                    var errorObj = data;
                                    var status = data.status;
                                    var statusText = data.statusText
                                    if(status == 401 || status == 400)
                                    {
                                        top.location.href = "login.html";
                                    }
                                }
                            })
                        }
                        else //多个分组
                        {
                            $.ajax({
                                type: "PUT",
                                url: locationHref+"/rest/admin/termGroup/forceLiveId/groups/"+energency_val,//设置全部分组插播
                                async: false,
                                data: stringify(group_array_final),
                                success: function (data)
                                {

                                },
                                error:function(data)
                                {
                                    var errorObj = data;
                                    var status = data.status;
                                    var statusText = data.statusText
                                    if(status == 401 || status == 400)
                                    {
                                        top.location.href = "login.html";
                                    }
                                }
                            })
                        }
                    }
                }
            }
        }
    </script>
</head>

<body>

<div class="pad-10">
    <div class="common-form">
        <form id="myform" method="post" action="" name="myform">
            <input type="hidden" name="dialog" value="add">
            <fieldset>
                <legend id="information">基本信息</legend>
                <table width="100%" class="table_form">
                    <tbody>
                        <tr>
                            <td width="80" id="td_1">紧急插播频道</td>
                            <td>
                                <select id="emergency">

                                </select>
                            </td>
                        </tr>
                        <!--<tr>
                            <td width="80" id="td_2">频道地址</td>
                            <td>
                                <input type="text" id="alias" class="input-text" name="alias" value="">
                            </td>
                        </tr>-->
                    </tbody>
                </table>
            </fieldset>
            <input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
        </form>
    </div>
</div>

</body>
</html>
