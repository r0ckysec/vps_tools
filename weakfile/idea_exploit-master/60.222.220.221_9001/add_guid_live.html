<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="css/sp.css" rel="stylesheet" type="text/css" />
    <link href="css/reset.css" rel="stylesheet" type="text/css" />
    <link href="css/system.css" rel="stylesheet" type="text/css" />
    <link href="css/table_form.css" rel="stylesheet" type="text/css" />
    <link href="css/zh-cn-system.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="js/jquery.json-2.4.js"></script>
    <script type="text/javascript" src="js/jquery.corner.js"></script>
    <script type="text/javascript" src="js/admin_common.js"></script>
    <script type="text/javascript" src="js/dialog.js"></script>
    <script type="text/javascript" src="js/jbase64.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
    <script type="text/javascript" src="js/ref_encode.js"></script>
    <script type="text/javascript" src="js/jquery.form.js"></script>
    <script type="text/javascript" src="js/encoder.js" ></script>
    <script type="text/javascript" src="js/add_edit_live.js"></script>
    <script type="text/javascript" src="js/bean.js"></script>
    <script type="text/javascript" src="js/changStatus.js"></script>
    <style type="text/css">
        .title{height:20px}
        .title .t{width: 70px;text-align: center;}
        .title .i{width:323px;text-align:center}
        .item{height:30px;width:850px;}
        .item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
        .item a:hover{text-decoration:none;}
        .f{float: left;}
        .c{text-align: center}
        .fname{display:block;width:75px;height:25px;line-height:25px;float:left;margin-left:26px;text-align:center;}
        .ftstart{display:block;width:77px;height:25px;line-height:25px;float:left;margin-left:10px;text-align:center;}
        .ftduration{display:block;width:77px;height:25px;line-height:25px;float:left;margin-left:10px;text-align:center;}
        .fpath{display:block;width:370px;height:25px;line-height:25px;float:left;margin-left:8px;text-align:center;}
        .ui-dialog-titlebar{
            background: rgba(0, 0, 0, 0) -moz-linear-gradient(center top , #3580cf, #85b2e3) repeat scroll 0 0;
            box-shadow: none;
            border:none;
            color:#fff;
            border-bottom-style: none;
            background:url('js/dialog/dialog/images/dialog_bar_bg.jpg') repeat-x;
        }
    </style>
    <script type="text/javascript">
        var PleaseSelectTranscodingScheme;
        var addTransfer;
    $(function(){
        Init_license(authorization);
        var Languages = $.cookie('internationalization');
        if ( Languages == null || Languages == "" )
        {
            Languages = 'zh' ;
        }
        jQuery.i18n.properties({
            name : 'strings', //资源文件名称
            path : '/i18n/', //资源文件路径
            mode : 'map', //用Map的方式使用资源文件中的值
            language : Languages,
            encoding : 'UTF-8', // 必须写 否则中文乱码
            callback : function() {//加载成功后设置显示内容
                $('#tab_setting_1').html($.i18n.prop('BasicConfiguration'));
                $('#tab_setting_2').html($.i18n.prop('AdvancedConfiguration'));
                $('#tab_setting_3').html($.i18n.prop('VideoConfiguration'));

                $('#td_1').html($.i18n.prop('ApplyName')+":");
                $('#td_2').html($.i18n.prop('LiveChannelName')+":");
                $('#td_3').html($.i18n.prop('Alias'));
                $('#td_5').html($.i18n.prop('VideoStoragePath')+":("+$.i18n.prop('FormatSuchAs')+":e:/data)");
                $('#td_5_1').html($.i18n.prop('FormattingTips'));
                $('#dataPathSelect').val($.i18n.prop('SelectPath'));
                $('#td_6').html($.i18n.prop('SubStreamCreationMethod'));
                $('#td_6_1').html($.i18n.prop('PullMode'));
                $('#td_6_2').html($.i18n.prop('PushMode'));
                $('#td_8').html($.i18n.prop('StreamReleaseMode'));
                $('#td_8_1').html($.i18n.prop('StreamReleaseMode_1'));
                $('#td_8_2').html($.i18n.prop('StreamReleaseMode_2'));
                $('#td_8_3').html($.i18n.prop('StreamReleaseMode_3'));
                $('#td_8_4').html($.i18n.prop('StreamReleaseMode_4'));
                $('#td_21').html($.i18n.prop('Enable')+" HLS");
                $('#td_21_1').html($.i18n.prop('Disable'));
                $('#td_21_2').html($.i18n.prop('Enable'));
                $('#td_22').html($.i18n.prop('Enable')+" TS");
                $('#td_22_1').html($.i18n.prop('Disable'));
                $('#td_22_2').html($.i18n.prop('Enable'));
                $('#td_23').html("TS " + $.i18n.prop('Address'));
                $('#td_23_1').html($.i18n.prop('FormatSuchAs')+": 234.2.5.7:9000");
                $('#td_24').html($.i18n.prop('RecordFileProcessing')+":");
                $('#td_24_1').html($.i18n.prop('RecordFileProcessing_1'));
                $('#td_24_2').html($.i18n.prop('RecordFileProcessing_2'));
                $('#td_24_3').html($.i18n.prop('RecordFileProcessing_3'));
                $('#td_25').html($.i18n.prop('Videotape')+":");
                $('#td_25_1').html($.i18n.prop('AllowVideo'));
                $('#td_25_2').html($.i18n.prop('DoNotAllowVideo'));
                $('#td_26').html($.i18n.prop('VideoMode'));
                $('#td_26_1').html($.i18n.prop('Manual'));
                $('#td_26_2').html($.i18n.prop('Timing'));
                $('#td_26_3').html($.i18n.prop('StreamingVideo'));
                $('#td_27').html($.i18n.prop('VideoFileMode'));
                $('#td_27_1').html($.i18n.prop('VideoFileMode_1'));
                $('#td_27_2').html($.i18n.prop('VideoFileMode_2'));
                $('#td_28').html($.i18n.prop('HowLongInAdditionalDevascularization'));
                $("#td_28_1").html($.i18n.prop('Company')+"("+$.i18n.prop('Second')+")");
                $('#td_29').html($.i18n.prop('HowLongIsTheVideoFile'));
                $("#td_29_1").html($.i18n.prop('Company')+"("+$.i18n.prop('Minute')+")");
                $('#td_30').html($.i18n.prop('VideoFormat'));
                $('#td_31').html($.i18n.prop('HowMuchIsTheVideoFile'));
                $("#td_31_1").html($.i18n.prop('Company')+"("+$.i18n.prop('M')+")");
                $('#td_32').html($.i18n.prop('SegmentMode'));
                $("#td_32_1").html($.i18n.prop('Time'));
                $("#td_32_2").html($.i18n.prop('Much'));
                $("#td_33").html($.i18n.prop('DelaySeconds'));
                $('#transfer_button').val($.i18n.prop('GuidTransSetting'));
                $('#OpenTranscoding').html($.i18n.prop('TransSetting'));
                $('#close_1').html($.i18n.prop('Close'));
                $('#open_1').html($.i18n.prop('Open'));
                $("#transcodingScheme").html($.i18n.prop('TranscodingScheme'));

                addTransfer = $.i18n.prop('AddTransfer') ;
                PleaseSelectTranscodingScheme = $.i18n.prop('PleaseSelectTranscodingScheme') ;
            }
        });
        createTfServerSelect("tfServerOuter");
    });

    String.prototype.replaceAll  = function(s1,s2){
        return this.replace(new RegExp(s1,"gm"),s2);
    }

    function addGuidLive()
    {
        var tf_se = $("#tf_select").val();
        if(tf_se == "-1" || tf_se == undefined)
        {
            tf_se = "";
        }
        var pitems = new PlayGuidItem(null,tf_se);

        var appName = $("#appName").val();
        var name = $("#liveName").val();
        var dataPath = $("#dataPath").val();
        var right = 5;
        var alias = $("#alias").val();
        var outputMode = parseInt($("#outputMode").val());
        var keepPlaybackDays = 0;
        var liveProperty = parseInt($("#liveProperty").val());
        var enableHLS = $("#enableHLS").val();
        var hlsStatus = false;
        var tsStatus = false;
        if(enableHLS == "true")
        {
            enableHLS = true;
            hlsStatus = true;
        }
        else
        {
            enableHLS = false;
            hlsStatus = false;
        }
        var enableTS = $("#enableTS").val();
        if(enableTS == "true")
        {
            enableTS = true;
            tsStatus = true;
        }
        else
        {
            enableTS = false;
            tsStatus = false;
        }
        var tsAddress = $("#tsAddress").val();
        var flvKeyframe = parseInt($("#flvKeyframe").val());
        var recordEnabled = $("#recordEnabled").val();
        if(recordEnabled == "true")
        {
            recordEnabled  = true;
        }
        else
        {
            recordEnabled = false;
        }
        var recordType = parseInt($("#recordType").val());
        var splitFileSize = parseInt($("#splitFileSize").val());
        var intervalTime = parseInt($("#intervalTime").val());
        var format = $("#format").val();
        var delaySeconds = parseInt($("#delaySeconds").val());
        var timeToApend = parseInt($("#timeToApend").val());
        var items = pitems;

        if(tf_se == undefined)
        {
            window.top.art.dialog({id:"mesg",content:PleaseSelectTranscodingScheme+"!",time:1});
        }
        else
        {
            if(alias != null && appName != null && name != null && alias != "" && appName != "" && name != ""  && dataPath != "")
            {
                var live = new LiveChannelInfoGuid(alias,appName,dataPath,delaySeconds,enableHLS,enableTS,flvKeyframe,format,hlsStatus,intervalTime,keepPlaybackDays,liveProperty,
                        name,outputMode,recordEnabled,recordType,right,splitFileSize,timeToApend,tsAddress,tsStatus,items);
                //alert(stringify(live));
                $.ajax({
                    type:"POST",
                    url:locationHref+"/rest/admin/lives",//添加直播频道
                    async: false,
                    data: stringify(live),
                    dataType:"json",
                    success:function(data)
                    {
                        var appName = $("#appName").val();
                        var dataPath = $("#dataPath").val();
                        var dataPathStr = dataPath.replace(/\\/g, "/");
                        var dataPath1 = dataPathStr.substring(0,dataPathStr.indexOf("/")-1);
                        var dataPath2 = dataPathStr.substring(dataPathStr.indexOf("/")+1,dataPathStr.length);
                        var name = dataPath1+dataPath2;
                        name = name.replaceAll("/","");
                        var alias = name;
                        var vodInfo = new VodInfoGuid(name,alias,dataPath,false,false);
                        $.ajax({
                            type: "POST",
                            url: locationHref+"/rest/admin/vodPaths",//添加虚拟目录
                            async: false,
                            data: stringify(vodInfo),
                            success:function(data)
                            {

                            },
                            error:function(data)
                            {
                                var errorObj = data;
                                var status = data.status;
                                var statusText = data.statusText
                                if(status == 401 || status == 400)
                                {
                                    top.location.href = "login.html";
                                }
                            }
                        });
                        window.top.art.dialog({id:'addGuid'}).close();
                    },
                    error:function(data)
                    {
                        var errorObj = data;
                        var status = data.status;
                        var statusText = data.statusText
                        if(status == 401 || status == 400)
                        {
                            top.location.href = "login.html";
                        }
                    }
                });
            }

        }

    }

        $(function(){
            $("input[@type=radio][name=transferStatus]").change(function(){
                var id = $(this).attr("id");
                if(id=="open")
                {
                    $("#transferPlan").show();
                }
                else
                {
                    $("#transferPlan").hide();
                    $("#tf_select").val("-1");
                }
            })
        })
    </script>
</head>
<body>

<form action="" method="post" onsubmit="return check()" >
    <!-- 隐藏字段 -->
    <input type="hidden" name="dialog" value="add">

    <div class="pad-10">
        <div class="col-tab">
            <ul class="tabBut cu-li">
                <li onclick="SwapTab('setting','on','',5,1);" class="on" id="tab_setting_1">基本配置</li>
                <li onclick="SwapTab('setting','on','',5,2);" class="" id="tab_setting_2" >高级配置</li>
                <li onclick="SwapTab('setting','on','',5,3);" class="" id="tab_setting_3" >录像配置</li>
            </ul>
            <div class="contentList pad-10" id="div_setting_1"><!-- 直播基本配置 -->
                <table width="100%" class="table_form ">
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_1">应用名称：</td>
                        <td align="left" ><input class="input-text lh25" type="text" id="appName" name="appName" size="56" ></td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_2">直播频道名称：</td>
                        <td align="left" ><input class="input-text" type="text" id="liveName" name="liveName" size="56"></td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_3">别名：</td>
                        <td align="left" ><input class="input-text" type="text" id="alias" name="alias" size="56" value=""></td>
                    </tr>
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_5">录像存放路径:(格式如:e:/data)
                        <td align="left" >
                            <input class="input-text" type="text" id="dataPath" name="dataPath" readonly size="47" value="">
                            <input type="button" class="button" id="dataPathSelect" name="dataPathSelect" onclick="selectPath()" value="选择路径"/>
                          <!--  <br/><span id="td_5_1">同一应用名称下(如:live)确保dataPath一致!</span>-->
                        </td>
                    </tr>
                    <tr>
                        <td id="transStatus">转码状态</td>
                        <td>
                            <input type="radio" id="open" name="transferStatus" value="true">开启
                            <input type="radio" id="close" name="transferStatus" value="false" checked="checked">关闭
                        </td>
                    </tr>
                    <tbody id="transferPlan" style="background:#DDDDDD;display:none;">
                    <tr>
                        <td>
                            <span id="transcodingScheme">转码方案 </span> :
                        </td>
                        <td>
                            <div id="tfServerOuter" style="display:inline;"></div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="contentList pad-10 hidden" id="div_setting_2"><!-- 直播高级配置 -->
                <table width="100%" class="table_form ">

                    <tr valign="bottom" height="16">
                        <td align="left" id="td_6">子码流创建方式：</td>
                        <td align="left" >
                            <select class="select" size="1" name="outputMode" id="outputMode">
                                <option value="1" id="td_6_1">拉方式</option>
                                <option value="0" id="td_6_2">推方式</option>
                            </select>
                        </td>
                    </tr>
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_8">流发布方式</td>
                        <td align="left" >
                            <select class="select" size="1" name="liveProperty" id="liveProperty">
                                <option value="0" id="td_8_1">允许推流;允许发布;允许录像</option>
                                <option value="1" id="td_8_2">允许推流;不允许发布;不允许录像</option>
                                <option value="2" id="td_8_3">允许推流;不允许发布;允许录像</option>
                                <option value="3" id="td_8_4">不允许推流;不允许发布;不允许录像</option>
                            </select>
                        </td>
                    </tr>
                    <tbody id="hls_oper">
                        <tr  valign="bottom" height="16">
                            <td align="left" id="td_21">启用HLS</td>
                            <td align="left" >
                                <select class="select" size="1" name="enableHLS" id="enableHLS">
                                    <option value="false" id="td_21_1">禁用</option>
                                    <option value="true" id="td_21_2">启用</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                    <tbody id="ts_oper">
                        <tr  valign="bottom" height="16">
                            <td align="left" id="td_22">启用TS</td>
                            <td align="left" >
                                <select class="select" size="1" name="enableTS" id="enableTS">
                                    <option value="false" id="td_22_1">禁用</option>
                                    <option value="true" id="td_22_2">启用</option>
                                </select>
                            </td>
                        </tr>
                        <tr valign="bottom" height="16">
                            <td align="left" id="td_23">TS地址</td>
                            <td align="left" >
                                <input class="input-text" type="text" name="tsAddress" id="tsAddress" value="234.4.5.6:9000">
                                <span style="color:#990000" id="td_23_1">&nbsp;&nbsp;格式如:234.2.5.7:9000</span>
                            </td>
                        </tr>
                    </tbody>
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_33">延时直播</td>
                        <td align="left" >
                            <input class="input-text" type="text" name="delaySeconds" id="delaySeconds" value="0">
                        </td>
                    </tr>
                </table>
            </div>

            <div class="contentList pad-10 hidden" id="div_setting_3" ><!-- 流录像配置 -->
                <table width="100%" class="table_form">
                    <tr valign="bottom" height="16">
                        <td align="left" width="20%" id="td_24">录制文件处理：</td>
                        <td align="left" >
                            <select class="select" size="1" name="flvKeyframe" id="flvKeyframe">
                                <option value="0" id="td_24_1">不生成索引信息</option>
                                <option value="1" selected="selected" id="td_24_2">边录制边生成索引</option>
                                <option value="2"  id="td_24_3">录制结束后生成索引</option>
                            </select>
                        </td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_25">录像：</td>
                        <td align="left" >
                            <select class="select"  name="recordEnabled" id="recordEnabled">
                                <option value="true" selected="selected"  id="td_25_1">允许录像</option>
                                <option value="false" id="td_25_2">不允许录像</option>
                            </select>
                        </td>
                    </tr>

                    <tr valign="bottom" height="16">
                        <td align="left" id="td_26">录像方式：</td>
                        <td align="left" >
                            <select class="select" size="1" name="recordType" id="recordType">
                                <option value="0" selected="selected"  id="td_26_1">手动</option>
                                <option value="1" id="td_26_2">定时</option>
                                <option value="2" id="td_26_3">当有直播流时自动录像</option>
                            </select>
                        </td>
                    </tr>
                    <tbody id="append_time_outer">
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_28">断流多久内追加:</td>
                        <td align="left" >
                            <input class="input-text" type="text" name="timeToApend" id="timeToApend" value="5">&nbsp;&nbsp;<span id="td_28_1">单位(秒)</span>
                        </td>
                    </tr>
                    </tbody>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_32">分段方式：</td>
                        <td align="left" >
                            <select class="select" size="1" name="splitRecord" id="splitRecord" onchange="record_type(this.value)">
                                <option value="time" id="td_32_1">时间</option>
                                <option value="much" id="td_32_2">大小</option>
                            </select>
                        </td>
                    </tr>
                    <tbody id="time_type">
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_29">录像文件间隔多久分段:</td>
                        <td align="left" >
                            <input class="input-text" type="text" name="intervalTime" id="intervalTime" value="240">&nbsp;&nbsp;<span id="td_29_1">单位(分)</span>
                        </td>
                    </tr>
                    </tbody>
                   <tbody id="much_type" style="display: none">
                   <tr valign="bottom" height="16">
                       <td align="left" id="td_31">录像文件多大分段:</td>
                       <td align="left" >
                           <input class="input-text" type="text" name="splitFileSize" id="splitFileSize" value="0">&nbsp;&nbsp;<span id="td_31_1">单位(兆)</span>
                       </td>
                   </tr>
                   </tbody>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_30" >录像格式：</td>
                        <td align="left" >
                            <select class="select" name="format" id="format">
                                <option value="flv" selected="selected" >FLV</option>
                                <option value="mp4" >MP4</option>
                                <option value="m3u8" >M3U8</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="bk15"></div>
            <input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
        </div>
    </div>
</form>
<!--table_form_off-->


<script language="JavaScript">

    function SwapTab(name,cls_show,cls_hide,cnt,cur){
        for(i=1;i<=cnt;i++){
            if(i==cur){
                $('#div_'+name+'_'+i).show();
                $('#tab_'+name+'_'+i).attr('class',cls_show);
            }else{
                $('#div_'+name+'_'+i).hide();
                $('#tab_'+name+'_'+i).attr('class',cls_hide);
            }
        }
    }
    function load_file_list(id) {
        if(id=='') return false;
        $.getJSON('?m=admin&amp;c=category&amp;a=public_tpl_file_list&amp;style='+id+'&amp;catid=&amp;type=1', function(data){$('#page_template').html(data.page_template);});
    }
    //--&gt;
</script></body>


</html>
