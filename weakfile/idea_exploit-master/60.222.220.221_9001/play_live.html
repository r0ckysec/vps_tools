<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="off">
<head>
	<title>直播播放</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<head>
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>

	<style type="text/css">
		body {
			text-align: center
		}

		#center {
			margin: 0 auto
		}

		#source {
			width: 960px;
			height: 100px;
			background: #e6e6e6;
			overflow: auto;
			margin: 0 auto;
			word-break: break-all;
		}

		#tips {
			width: 960px;
			height: 30px;
			line-height: 30px;
			text-align: left;
			font-size: 12px;
			color: #3c3c3c;
			padding: 0px;
			margin:0px auto;
		}
	</style>
	<script type="text/javascript">
		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');

			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#tips').html($.i18n.prop('CodePrompt'));
				}
			});
		});

		(function($){
			$.ajaxSetup({ cache: false });
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			}
		})(jQuery);

		var startObj = "";
		var liveObj ="";
		var rtmp_port ="";
		var rtsp_port ="";
		var http_port ="";
		var appName ="";
		var name ="";
		var liveId = $.getUrlParam("id");
		var substream = $.getUrlParam("substream");
		var host = window.location.hostname;

		var right = $.getUrlParam("right");//if right equal 3 than play is time shift live
		$.ajax({
			type:"GET",
			url:locationHref+"/rest/admin/lives/"+liveId,//获取一个直播频道
			success: function (data) {
				liveObj = data;
				var object = data;
				appName = object.appName;
				name = object.name;
				if(substream != null)
				{
					$.ajax({
						type: "GET",
						url: locationHref+"/rest/admin/system/startupInfo",//获取端口配置
						success: function (data) {
							startObj = data;
							var object = data;
							var rtmp_port = object.port;

							var rtmp_play_url = "rtmp://"+host+":"+rtmp_port+"/"+appName+"/"+name+"/"+substream;
							var url = replace_url(rtmp_play_url);
							embed_flash_player("center",url,"960px","550px","",right);

							$("title").text(url);

						},
						error:function()
						{
							top.location.href = "login.html";
						}
					})

				}
				else
				{
					$.ajax({
						type: "GET",
						url: locationHref+"/rest/admin/system/startupInfo",//获取端口配置
						success: function (data) {
							startObj = data;
							var object = data;
							var rtmp_port = object.port;

							var rtmp_play_url = "rtmp://"+host+":"+rtmp_port+"/"+appName+"/"+name;
							var url = replace_url(rtmp_play_url);
							embed_flash_player("center",url,"960px","550px","",right);
							$("title").text(url);

						},
						error:function()
						{
							top.location.href = "login.html";
						}
					})
				}
			},
			error: function ()
			{

			}
		})

		$(function(){
			setTimeout(function(){
				copy_player();
			},2000)


		})

		function copy_player()
		{
			var count = 0;
			var player = $("#center").html();
			$("#source").val(player);


			document.getElementById("source").onselect= function()
			{
				if(count==0)
				{
					var clipBoardContent= document.getElementById("source").innerText;
					window.clipboardData.setData("Text",clipBoardContent);
					alert("复制代码成功！");
					count++;
				}
			}

		}

		function replace_url(url)
		{
			var host = window.location.hostname;
			var before = url.substr(0,url.indexOf("//")+2);
			var after = "";

			if(url.substring(before.length).lastIndexOf(":") != -1)
			{
				after = url.substr(url.lastIndexOf(":"));
			}
			else
			{
				var temp = url.substring(before.length);
				after = temp.substring(temp.indexOf("/"));
			}

			return (before+host+after);
		}


		function embed_flash_player(id,play_url,width,height,player_type,streamType)
		{
			var host = window.location.hostname;
			var port = window.location.port;
			var dom = "";


			//初使化播放器的宽度和高度
			if(width == undefined || height == undefined ||width == "" || height == "" )
			{
				width = 400;
				height = 300;
			}
			//初使化播放器的类型
			if(player_type == undefined || player_type =="")
			{
				player_type = "ckplayer";
			}
			else
			{
				player_type = "default";

			}

			//初使化swfpath路径
			var ckplayer_swfpath = "";
			var default_swfpath = "";
			if(port == "")
			{
				ckplayer_swfpath = "http://"+host+"/ckplayer/ckplayer.swf";
				default_swfpath = "http://"+host+"/StrobeMediaPlayback.swf";
			}
			else
			{
				ckplayer_swfpath = "http://"+host+":"+port+"/ckplayer/ckplayer.swf";
				default_swfpath = "http://"+host+":"+port+"/StrobeMediaPlayback.swf";
			}
			//初使化CKPLAYER播放视频类型
			var videoType = 1;//flv is 1,mp4 is 2
			if(play_url.indexOf(".mp4") != -1)
			{
				videoType = 2;
			}
			if(play_url.indexOf(".flv") == -1)
			{
				videoType = 2;
			}

			if(streamType == "3")
			{
				streamType = 3;
			}
			else
			{
				streamType = 1;
			}

			if(player_type == "ckplayer" )
			{
				dom = get_ckplayer_dom(play_url,ckplayer_swfpath,videoType,width,height,streamType);
			}
			else if(player_type == "default")
			{
				dom = get_default_player_dom(play_url,default_swfpath,streamType,width,height);
			}

			$("#"+id).empty();
			$("#"+id).html(dom);
		}

		function get_ckplayer_dom(play_url,swfpath,videoType,width,height,streamType)
		{
			dom = "<object style='background:#000'  width='"+width+"' height='"+height+"' align='middle' name='StrobeMediaPlayback_object'  id='StrobeMediaPlayback_object' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=10,0,0,0' type='application/x-shockwave-flash' classid='clsid:d27cdb6e-ae6d-11cf-96b8-444553540000' pluginspage='http://www.macromedia.com/go/getflashplayer'>";
			dom+="<param name='movie' value='"+swfpath+"' />";
			dom+="<param name='quality' value='high' />";
			dom+="<param name='bgcolor' value='#000000' />";
			dom+="<param name='allowfullscreen' value='true' />";
			dom+="<param name='flashvars'	value='f="+play_url+"&s=0&c=0&e=1&v=80&p=1&h=3&wh=16:9&h="+videoType+"&lv="+streamType+"' />";
			dom+="<embed style='background:#000' src='"+swfpath+"' width='"+width+"' height='"+height+"' align='middle' id='StrobeMediaPlayback_embed' quality='high'";
			dom+="bgcolor='#000000' name='StrobeMediaPlayback_embed' allowfullscreen='true'";
			dom+="pluginspage='http://www.adobe.com/go/getflashplayer' ";
			dom+="flashvars='f="+play_url+"&s=0&e=1&p=1&wh=16:9&h="+videoType+"&lv="+streamType+"";
			dom+="type='application/x-shockwave-flash'>";
			dom+="</embed>";
			dom+="</object>";
			return dom;

		}

		/**
		 * 获取默认FLASH播放器的DOM元素
		 * @param play_url
		 * @param swfpath
		 * @param streamType  vod为点播  live为直播
		 * @param width
		 * @param height
		 * @returns {string|*}
		 */
		function get_default_player_dom(play_url,swfpath,streamType,width,height)
		{
			play_url = play_url.replace("|","/");
			var swfpath = "/StrobeMediaPlayback.swf";
			dom = "<object style='background:#000' wmode='transparent' width='"+width+"' height='"+height+"'  id='StrobeMediaPlayback_object_' type='application/x-shockwave-flash' classid='clsid:d27cdb6e-ae6d-11cf-96b8-444553540000'>";
			dom+="<param name='movie' value='"+swfpath+"' />";
			dom+="<param name='quality' value='high' />";
			dom+="<param name='bgcolor' value='#000000' />";
			dom+="<param name='allowfullscreen' value='true' />";
			dom+="<param name='flashvars'	value='&src="+play_url+"&autoHideControlBar=true&streamType="+streamType+"&autoPlay=true' />";
			dom+="<embed style='background:#000' wmode='transparent' src='"+swfpath+"' width='"+width+"' height='"+height+"' id='StrobeMediaPlayback_embed' quality='high'";
			dom+="bgcolor='#000000' name='StrobeMediaPlayback' allowfullscreen='true'";
			dom+="pluginspage='http://www.adobe.com/go/getflashplayer'";
			dom+="flashvars='&src="+play_url+"&autoHideControlBar=true&streamType="+streamType+"&autoPlay=true'";
			dom+="type='application/x-shockwave-flash'>";
			dom+="</embed>";
			dom+="</object>";
			return dom;
		}

	</script>
</head>

	<body>
		<div id="center" style="width:960px;height: 550px;">

		</div>
		<p id="tips">tips：把下述代码嵌入到您的网页中即可观看本视频,若复制失败，请手工(全选)ctrl+a(复制)ctrl+c</p>
		<textarea id="source"></textarea>
	
	</body>
</html>
