<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>点播媒体列表</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="css/common.css">
	<link rel="stylesheet" href="css/main.css">
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/jquery.corner.js"></script>
	<script type="text/javascript" src="js/admin_common.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script type="text/javascript" src="js/jquery.zclip.min.js"></script>
	<script type="text/javascript" src="js/player.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/cookie.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript" src="js/media.js"></script>
	<script type="text/javascript">
		var FailedToGetData ;
		var VideoPlay ;
		var Watch ;
		var InSearch ;
		var VideoCapture ;
		var ReferenceAddress ;
		var HomePage;
		var PreviousPage ;
		var NextPage ;
		var Shadowe ;
		var InTotal ;
		var Page ;
		var NumberOfData ;
		var BuildingPage ;
		var　UploadMedia ;
		var Screenshot ;
		var TranscodingConfiguration;
		var MediaMerge;
		var Repair;
		var Download;
		var Jump;
		var Tagging;
		var SubTitle;
		var Advert;
		var Clip;
		var Contain;
		var Transfer;
		var BreakHeadToEnd;
		var Address;
		var MediaTime;
		var MediaType;
		var Resolution;
		var Edit;
		var Delete;
		var NoSelectVideo;
		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');

			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#th_1').html($.i18n.prop('MediaCover'));
					$('#th_2').html($.i18n.prop('MediaNick'));
					$('#th_3').html($.i18n.prop('MediaType'));
					$('#th_4').html($.i18n.prop('Resolution'));
					$('#th_5').html($.i18n.prop('MediaTime'));
					$('#netMedia').val($.i18n.prop('NetMedia'));
					$('#allVodCat').val($.i18n.prop('VODCategory'));
					$('#allMediaCat').val($.i18n.prop('AllMediaCat'));
					$('#allCutImg').val($.i18n.prop('AllCutImg'));
					$('#allTransfer').val($.i18n.prop('AllTransfer'));
					$('#allDelete').val($.i18n.prop('AllDelete'));
					$('#Search').val($.i18n.prop('Search'));
					$('#upload').val($.i18n.prop('uploadMediaInfo'));
					$('#all').html($.i18n.prop('All'));
					$('#admin').html($.i18n.prop('AdminUpload'));
					$('#user').html($.i18n.prop('UserUpload'));
					$('#net').html($.i18n.prop('NetUpload'));
					$('#record').html($.i18n.prop('Record'));
					$('#type').html($.i18n.prop('Type'));
					$('#searchKey').html($.i18n.prop('Operation'));

					Screenshot = $.i18n.prop('Screenshot') ;
					TranscodingConfiguration = $.i18n.prop('TranscodingConfiguration') ;
					MediaMerge = $.i18n.prop('MediaMerge') ;
					FailedToGetData = $.i18n.prop('FailedToGetData') ;
					VideoPlay = $.i18n.prop('VideoPlay') ;
					Screenshot = $.i18n.prop('Screenshot') ;
					Watch = $.i18n.prop('Watch') ;
					BuildingPage = $.i18n.prop('BuildingPage') ;
					InSearch = $.i18n.prop('InSearch') ;
					VideoCapture = $.i18n.prop('VideoCapture') ;
					ReferenceAddress = $.i18n.prop('ReferenceAddress') ;
					HomePage = $.i18n.prop('HomePage') ;
					PreviousPage = $.i18n.prop('PreviousPage') ;
					NextPage = $.i18n.prop('NextPage') ;
					Shadowe = $.i18n.prop('Shadowe') ;
					InTotal = $.i18n.prop('InTotal') ;
					Page = $.i18n.prop('Page') ;
					NumberOfData = $.i18n.prop('NumberOfData') ;
					BuildingPage = $.i18n.prop('BuildingPage') ;
					UploadMedia　=　$.i18n.prop('UploadMedia') ;
					Repair = $.i18n.prop('Repair');
					Download = $.i18n.prop('Download');
					Jump = $.i18n.prop('Jump');
					Tagging = $.i18n.prop('Tagging');
					SubTitle = $.i18n.prop('SubTitle');
					Advert = $.i18n.prop('Advert');
					Clip = $.i18n.prop('Clip');
					Contain = $.i18n.prop('Contain');
					Transfer = $.i18n.prop('Transfer');
					BreakHeadToEnd = $.i18n.prop('BreakHeadToEnd');
					Address = $.i18n.prop('Address');
					MediaTime = $.i18n.prop('MediaTime');
					MediaType = $.i18n.prop('MediaType');
					Resolution = $.i18n.prop('Resolution');
					Edit = $.i18n.prop('Edit');
					Delete = $.i18n.prop('Delete');
					NoSelectVideo = $.i18n.prop('NoSelectVideo');
				}
			});
			query();
		});

		$.getUrlParam = function(name)
		{
			var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
			var r = window.location.search.substr(1).match(reg);
			if (r!=null) return unescape(r[2]); return null;
		}
		var beforeId = $.getUrlParam("id");
		var beforeName = decodeURI($.getUrlParam("name"));//媒体点播分类
		var beforeVisible = $.getUrlParam("visible");

		var vodbeforeId = $.getUrlParam("beforeId");
		var vodbeforeName = decodeURI($.getUrlParam("beforeName"));//点播媒体分类
		var vodbeforeVisible = $.getUrlParam("beforeVisible");
		var vodVipLevel = $.getUrlParam("beforeVipLevel");
		var vodBPublic = $.getUrlParam("beforeBPublic");

		var host = window.location.hostname;
		var port = window.location.port;
		var currentPage =1;
		var currentPageCount =10;

		var vodInfo;

		//初始化查询
		function query(){

			if(beforeId == null)
			{
				beforeId = "";
			}
			if(beforeId == "")
			{
				$("#allMediaCat").css("display","inline");
				$("#allDelete").css("display","none");
			}
			else
			{
				$("#allMediaCat").css("display","none");
				$("#allDelete").css("display","inline");
			}
			init_library_medias(currentPage,currentPageCount);
		}

		//初始化
		function init_library_medias(currentPage,pageCount)
		{
			if(beforeId == null)
			{
				beforeId = "";
			}

			$("#main_body").empty();
			window.top.art.dialog({id:"wait",content:BuildingPage+"...<img width=20 src='images/loading.gif'>"});

			var search_url;
			var search_key = $("#key").val();
			if(search_key == "")
			{
				search_url = locationHref + "/rest/admin/vodTypes/" + beforeId + "/" + pageCount + "/" + currentPage+"/get";//获取指定分类媒体信息
			}
			else
			{
				if(beforeId == "")
				{
					search_url = locationHref+"/rest/admin/vodTypes/"+pageCount+"/"+currentPage+"/"+search_key+"/search";//从所有媒体中搜索媒体信息
				}
				else
				{
					search_url = locationHref + "/rest/admin/vodTypes/" + beforeId + "/" + pageCount + "/" + currentPage+"/"+search_key+"/search";//从媒体分类中搜索媒体信息
				}
			}

			$.ajax({
				type:"GET",
				url: search_url,
				async: false,
				success:function(data){
					//var number = $.parseJSON(data);
					var obj = data;
					var length =obj.total;
					var item = obj.items;
					if(item != "")
					{
						for(var i=0;i<item.length;i++)
						{
							var fileId = item[i].fileId;
							var imageurl = "'images/video.jpg'";
							var allName = item[i].name;
							var name = allName.substr(allName.lastIndexOf("/")+1,allName.length);
							var imgName;
							var imgResolution;
							var cfg = item[i].cfg;
							var bitrate;
							var frameRate;
							var duration = "";
							var format = "";
							var resolution = "";
							if(cfg != "" || cfg != undefined)
							{
								frameRate = cfg.frameRate;
								bitrate = cfg.bitrate;
								duration = cfg.duration;
								format = cfg.format;
								resolution = cfg.resolution;
								if(duration == undefined || format == undefined || resolution == undefined)
								{
									duration = "";
									format = "";
									resolution = "";
								}
								var img = cfg.img;
								if(img != "")
								{
									for(var k=0;k<img.length;k++)
									{
										imgName = img[k].name;
										imgResolution = img[k].resolution;
									}
								}
							}

							var dom = '<tr>';
							dom += '<td align="center">';
							dom += '<input type="checkbox" class="inputcheckbox"  name="mediainfoIds" value="' + fileId +'" path="'+allName+'">';
							dom += '</td>';
							dom+= '<td align="left">';
							dom+= '<img width="100px" height="80px" src="data:image/jpeg;base64,'+imgName+'" onerror="javascript:this.src='+imageurl+'"/>';
							dom+= '</td>';
							dom+= '<td align="center">';
							dom+= ''+name+'</td>';
							dom+= '<td align="center">';
							dom+= ''+format+'</td>';
							dom+= '<td align="center">';
							dom+= ''+resolution+'</td>';
							dom+= '<td align="center">';
							dom+= ''+duration+'</td>';
							dom+= '</tr>';
							$("#main_body").append(dom);
						}
					}


					var pages = Math.ceil(length/pageCount);
					var page_dom = '<div class="pager Library_Page" >';
					page_dom+='<span class="Library_Page_1">'+InTotal+'<font color="red">'+pages+'</font>&nbsp;'+Page+',<font color="red">'+length+'</font>'+NumberOfData+'&nbsp;&nbsp;</span>';
					page_dom+='<a href="javascript:void(0)"  onclick="init_library_medias(1,'+pageCount+')">'+HomePage+'</a>';//首页
					if(currentPage-1>0)
					{
						page_dom+='<a href="javascript:void(0)" onclick="init_library_medias('+(currentPage-1)+','+pageCount+')">'+PreviousPage+'</a>';//上一页
					}
					var page_arr = calculatePageIndex(currentPage,pages,5);
					for(var i=page_arr[0];i<=page_arr[1];i++)
					{
						if(i == currentPage)
						{
							page_dom+='<a href="javascript:void(0)" style="background-color: #3EAFE0" class="Library_Page_NoPage">'+i+'</a>';
						}
						else
						{
							page_dom+='<a href="javascript:void(0)" onclick="init_library_medias('+i+','+pageCount+')" class="Library_Page_NoPage">'+i+'</a>';
						}
					}
					if(currentPage+1<=pages)
					{
						page_dom+='<a href="javascript:void(0)" onclick="init_library_medias('+(currentPage+1)+','+pageCount+')">'+NextPage+'</a>';//下一页
					}
					page_dom+='<a href="javascript:void(0)" onclick="init_library_medias('+pages+','+pageCount+')">'+Shadowe+'</a>';//尾页
					page_dom+='</div>';
					$("#pager_outer").html(page_dom)
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}
			})
			window.top.art.dialog({id:"wait"}).close();
		}

		//分页
		function calculatePageIndex(currentPage,totalPage,viewPageCount)
		{
			var startPage = 0 ;
			var endPage = 0;
			var arr = new Array();
			// 如果总页面小于 页面 分页显示页数
			if (totalPage <= viewPageCount) {
				startPage = 1;
				endPage = totalPage;
				arr[0] = startPage;
				arr[1] = endPage;

				return arr;
			}

			//计算出中间值
			var n = Math.ceil(viewPageCount/2)-1;
			startPage = currentPage - n;

			//如果当前页己经小于起始页
			if (startPage <= 1) {
				startPage = 1;
				// 因为两个边界的页码数也要显示
				endPage = startPage + (viewPageCount - 1);
				arr[0] = startPage;
				arr[1] = endPage;

				return arr;
			}

			endPage = currentPage + n;

			//前页页面显示的值是积数 还是偶数
			if (viewPageCount % 2 == 0) {
				startPage += 1;
			}
			if (endPage > totalPage) {
				endPage = totalPage;
				// 因为两个边界的页码数也要显示
				startPage = totalPage - (viewPageCount - 1);
			}
			arr[0] = startPage;
			arr[1] = endPage;

			return arr;
		}

		function addMediaToCategory()
		{
			if(!checkSelect("mediainfoIds"))
			{
				window.top.art.dialog({id:'dg_test34243', content:NoSelectVideo+'!',time:0.5});
				return false;
			}
			else
			{
				var ids = document.getElementsByName("mediainfoIds");
				var count = 0;
				var array = new Array();
				//var str = "";
				//拼接以ID和@组合而成的字符串
				for(var i=0;i<ids.length;i++) {
					//如果多选框没有选中 , 让其选中
					if (ids[i].checked == true && i != 0) {
						var media = new MediaObject(ids[i].value,"");
						array[count] = media;
						count++;
					}
				}

				var arry_str = stringify(array);

				var id = vodbeforeId;
				var name = vodbeforeName;
				var visible = vodbeforeVisible;
				if(visible == "true")
				{
					visible = true;
				}
				else
				{
					visible = false;
				}
				var vodBPublic = vodBPublic;
				if(vodBPublic == "true")
				{
					vodBPublic = true;
				}
				else
				{
					vodBPublic = false;
				}
				var vodVipLevel = parseInt(vodVipLevel);
				var bean = JSON.parse(arry_str);
				//var mediaToCategory = new MediaToCategory(name,visible,bean);
				var mediaToCategory = new MediaToCategoryVod(name,visible,bean,vodBPublic,vodVipLevel);

				//alert(stringify(mediaToCategory))
				$.ajax({
					 type: "PUT",
					 async: false,
					 url: locationHref+"/rest/admin/vodTypes/"+id+"/"+2+"/put",//编辑一个点播分类 添加文件到分类
					 data: stringify(mediaToCategory),
					 success: function(data) {

					 },
					error:function(data)
					{
						var errorObj = data;
						var status = data.status;
						var statusText = data.statusText
						if(status == 401 || status == 400)
						{
							top.location.href = "login.html";
						}
					}
				 })
			}
		}

	</script>
</head>

<body>
<div class="pad-10" id="content" >
	<div class="content-menu" >
		<form action="#" method="post">
			<table width="100%" cellspacing="0" class="search-form">
				<tbody>
				<tr>
					<td id="searchKey" width="40" style="color: red;font-weight:bold;">
						操作
					</td>
					<td>
						<input type="text" class="input-text" name="key" id="key" value="">
						<input type="button" value="搜索" class="button" onclick="init_library_medias(currentPage,currentPageCount)" id="Search">
					</td>
				</tr>
				</tbody>
			</table>
		</form>
	</div>

	<form name="myform" id="myform" action="#" method="post">
		<input type="hidden" id="media_path" value=""/>

		<div class="table-list">
			<table width="100%" class="list_table">
				<thead>
				<tr>
					<th width="5%">
						<input value="" id="check_box" name="mediainfoIds" onclick="selectall('mediainfoIds');" type="checkbox">
					</th>
					<th id="th_1">媒体封面</th>
					<th id="th_2">媒体昵称</th>
					<th id="th_3">文件类型</th>
					<th id="th_4">分辨率</th>
					<th id="th_5">播放时间</th>
				</tr>
				</thead>
				<tbody id="main_body">
				</tbody>
			</table>
		</div>
		<div>
			<div style="float: right;" id="pager_outer">

			</div>
		</div>
		<input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
	</form>
</div>
</body>
</html>
