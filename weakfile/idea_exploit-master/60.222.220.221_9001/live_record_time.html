<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/jquery.corner.js"></script>
	<script type="text/javascript" src="js/admin_common.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/time2.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<style type="text/css">

	</style>
	<script type="text/javascript">
		var moduleObject = "";
		var BuildingPage ;
		var NoVideo;
		var BeingVideo;
		var Remove;
		var AddRecord;
		var UploadMedia;
		(function($){
			Init_license(authorization);
			$.ajaxSetup({ cache: false });
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			}
		})(jQuery);
		var liveId = $.getUrlParam("id");
		var timeRight = $.getUrlParam("right");

		$(function(){
			var Languages = $.cookie('internationalization');

			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#td_1').html($.i18n.prop('SerialNumber'));
					$('#td_2').html($.i18n.prop('Status'));
					$('#td_3').html($.i18n.prop('TaskName'));
					$('#td_4').html($.i18n.prop('StartTime'));
					$('#td_5').html($.i18n.prop('EndTime'));
					$('#category_div').html($.i18n.prop('CategoryModule'));
					$('#td_6').html($.i18n.prop('Date'));
					$('#td_7').html($.i18n.prop('Operation'));

					$("#back").html($.i18n.prop('Back'));
					$("#addRecord").html($.i18n.prop('AddRecord'));
					$("#subRecord").html($.i18n.prop('SubRecord'));
					$("#refresh").html($.i18n.prop('RefreshStatus'));
					$("#back1").html($.i18n.prop('Back'));
					$("#addRecord1").html($.i18n.prop('AddRecord'));
					$("#subRecord1").html($.i18n.prop('SubRecord'));

					BuildingPage = $.i18n.prop('BuildingPage') ;
					NoVideo = $.i18n.prop('NoVideo') ;
					BeingVideo = $.i18n.prop('BeingVideo') ;
					AddRecord = $.i18n.prop('AddRecord') ;
					Remove = $.i18n.prop('Remove') ;
					UploadMedia = $.i18n.prop('UploadMedia') ;
				}
			});

			init_whole_page(liveId);
		});



		function init_whole_page(liveId)
		{
			$.ajaxSetup({ cache: false });
			window.top.art.dialog({id:"wait",content:BuildingPage+"...<img width=20 src='images/loading.gif'>"});
			$("#liveId").val(liveId);
			//直播
			if(timeRight == 1)
			{
				$("#category_div").show();
				$.ajax({
					type: "GET",
					url: locationHref+"/rest/admin/lives/"+liveId+"/timeRecord",//获取定时录像配置
					success: function(data)
					{
						var record_obj = data;
						if(record_obj != '')
						{
							var count = 0;
							for(var i=0;i<record_obj.length;i++)
							{
								var rid = record_obj[i].id;
								var name = record_obj[i].name;
								var startTime = record_obj[i].startTime;
								var endTime = record_obj[i].endTime;
								var daysOfWeek = record_obj[i].daysOfWeek;
								var recordName = record_obj[i].recordName;
								var moduleIdGet = record_obj[i].m_moduleId;
								//var moduleNameGet = record_obj[i].m_moduleName;
								var channelIdGet = record_obj[i].m_channelId;
								//var channelNameGet = record_obj[i].m_channelName;
								var date = new Date();
								var hours = date.getHours()+"";
								if(hours < 10)
								{
									hours = 0+hours;
								}
								var min = date.getMinutes()+"";
								if(min < 10)
								{
									min = 0+min;
								}
								var second = date.getSeconds()+"";
								if(second < 10)
								{
									second = 0+second;
								}
								var record_status_str = NoVideo;
								var date1 = hours+":"+min+":"+second;
								if(date1 >=startTime && date1 <= endTime)
								{
									record_status_str = "<font color='#990000'>"+BeingVideo+"</font>";
								}
								var dom = '<tr height="16" id="40">';
								dom+='<td align="center">'+(count)+'</td>';
								dom+='<td align="center">'+record_status_str+'</td>';
								dom+='<td align="center" ><input type="text" name="name[]" value="'+name+'" size="13" class="input-text"/></td>';
								dom+='<td align="center"><input type="text" name="startTime[]" value="'+startTime+'" onclick="_SetTime2(this)" readonly size="13" class="input-text"/></td>';
								dom+='<td align="center"><input type="text" name="endTime[]" value="'+endTime+'" onclick="_SetTime2(this)" readonly size="13" class="input-text"/></td>';
								dom+='<td align="center" id="addCategory_'+count+'" name="addSize"></td>';
								dom+='<td align="center"><input type="text" name="daysOfWeek[]" value="'+daysOfWeek+'" size="13" class="input-text"><input type="hidden" name="recordName[]" value="'+recordName+'" size="13" class="input-text"/></td>';
								dom+='<td align="center">';
								dom+='<a href="javascript:;" onclick="addRecord(this)" class="sp_a_but_cir sp_a_but_padding btn btn-info">'+AddRecord+'</a>&nbsp;';
								dom+='<a href="javascript:;" onclick="removeRecord(this)" class="sp_a_but_cir sp_a_but_padding btn btn-danger">'+Remove+'</a>';
								dom+='</td>';
								dom+='</tr>';

								$("#record_main_body").append(dom);

								//直播
								if(timeRight == 1)
								{
									$("#category_div").show();
									init_vodtypes(moduleObject,moduleIdGet,channelIdGet,count);
								}
								else
								{
									$("#addCategory_"+count).hide();
								}
								count++;
							}
						}

						window.top.art.dialog({id:"wait"}).close();
					}
				})
			}
			else
			{

			}
			window.top.art.dialog({id:"wait"}).close();
		}

		function  init_vodtypes(moduleObj,moduleIdGet,channelIdGet,count)
		{
			if(moduleObject != '')
			{
				$.ajaxSetup({ cache: false });
				$("#addCategory_" + count).append('<select name="moduleId" id="module_' + count+'" onchange="changeType(this.value,'+count+')"></select><select  name="channelId" id="channel_' + count+'" style="width:80px;" ></select>');
				for(var k=0;k<moduleObj.length;k++)
				{

					var moduleId = moduleObj[k].id;
					var moduleName = moduleObj[k].name;
					if(moduleName == "媒体库" || moduleId.indexOf("lu_") != "-1")
					{}
					else
					{
						var channel = moduleObj[k].subNames;
						if(channel != '')
						{
							for (var j = 0; j < channel.length; j++)
							{
								var channelId = channel[j].id;
								var channelName = channel[j].name;
								if (moduleIdGet == moduleId) {
									if (channelIdGet == channelId) {
										$("#channel_" + count).append("<option value='" + channelId + "'  title='"+channelName+"'  selected='selected'>" + channelName + "</option>");
									}
									else {
										$("#channel_" + count).append("<option value='" + channelId + "'  title='"+channelName+"' >" + channelName + "</option>");
									}
								}
							}
						}
						if (moduleIdGet == moduleId) {
							$("#module_" + count).append("<option value='" + moduleId + "'  title='"+moduleName+"'  selected='selected'>" + moduleName + "</option>");
						}
						else {
							$("#module_" + count).append("<option value='" + moduleId + "'  title='"+moduleName+"' >" + moduleName + "</option>");
						}
					}
				}

			}
			else
			{
				$.ajaxSetup({ cache: false });
				$.ajax({
					type: "GET",
					url: locationHref+"/rest/admin/vodTypes",//获取点播分类
					success: function (data)
					{
						moduleObject = data;
						moduleObj = data;
						$("#addCategory_" + count).append('<select name="moduleId" id="module_' + count+'" onchange="changeType(this.value,'+count+')"></select><select  name="channelId" id="channel_' + count+'" style="width:80px;" ></select>');
						for(var k=0;k<moduleObj.length;k++)
						{

							var moduleId = moduleObj[k].id;
							var moduleName = moduleObj[k].name;
							if(moduleName == "媒体库" || moduleId.indexOf("lu_") != "-1")
							{}
							else
							{
								var channel = moduleObj[k].subNames;
								if(channel != '')
								{
									for (var j = 0; j < channel.length; j++)
									{
										var channelId = channel[j].id;
										var channelName = channel[j].name;
										if (moduleIdGet == moduleId) {
											if (channelIdGet == channelId) {
												$("#channel_" + count).append("<option value='" + channelId + "' title='"+channelName+"'  selected='selected'>" + channelName + "</option>");
											}
											else {
												$("#channel_" + count).append("<option value='" + channelId + "' title='"+channelName+"' >" + channelName + "</option>");
											}
										}
									}
								}
								if (moduleIdGet == moduleId) {
									$("#module_" + count).append("<option value='" + moduleId + "' title='"+moduleName+"' selected='selected'>" + moduleName + "</option>");
								}
								else {
									$("#module_" + count).append("<option value='" + moduleId + "' title='"+moduleName+"' >" + moduleName + "</option>");
								}
							}
						}
					},
					error: function ()
					{
						$("#category_div").hide();
						$("#addCategory_" + count).hide();
					}
				})
			}

		}

		function changeType(id,size)
		{
			$.ajaxSetup({ cache: false });
			$("#channel_" + size).empty();
			if(timeRight == 1)
			{
				$("#category_div").show();
				$.ajax({
					type: "GET",
					url: locationHref+"/rest/admin/vodTypes",//获取点播分类
					success: function (data) {
						var moduleObj = data;
						var moduleId;
						var moduleName
						var channelId;
						var channelName;
						for (var i = 0; i < moduleObj.length; i++) {
							moduleId = moduleObj[i].id;
							moduleName = moduleObj[i].name;
							if(moduleName == "媒体库" || moduleId.indexOf("lu_") != "-1")
							{}
							else
							{
								var channel = moduleObj[i].subNames;
								if(channel != '')
								{
									for (var j = 0; j < channel.length; j++) {
										channelId = channel[j].id;
										channelName = channel[j].name;
										if (id == moduleId) {
											$("#channel_" + size).append("<option value='" + channelId + "' title='"+channelName+"' >" + channelName + "</option>");
										}
									}
								}
							}
						}
					},
					error:function()
					{
						$("#category_div").hide();
						$("#addCategory_" + size).hide();
					}
				})
			}
			else
			{
				$("#addCategory_" + size).hide();
			}
		}


		function addRecord(obj)
		{
			var size = 1;
			var name_size = "";
			var size_count = 0
			$("[name='addSize']").each(function(){
				name_size = $(this).attr("id");
				var  splitId = parseInt(name_size.substr(name_size.indexOf("_")+1,name_size.length));
				if(splitId>size_count)
				{
					size_count = splitId;
				}
			})

			//alert(typeof(name_size) == "undefined");

			if(name_size != "")
			{
				size = size_count+1;
			}

			var name = size+""+size+""+size;
			var dom ='<tr height="16" id="40">\
				<td align="center">'+size+'</td>\
				<td align="center" >'+NoVideo+'</td>\
				<td align="center"><input type="text" name="name[]" value="'+name+'" size="13" class="input-text"/></td>\
				<td align="center"><input type="text" name="startTime[]" value="" onclick="_SetTime2(this)" readonly size="13" class="input-text"/></td>\
				<td align="center"><input type="text" name="endTime[]" value="" onclick="_SetTime2(this)" readonly size="13" class="input-text"/></td>\
				<td align="center" id="addCategory_'+size+'" name="addSize"></td>\
				<td align="center"><input type="text" name="daysOfWeek[]" value="1,2,3,4,5,6,7" size="13" class="input-text"><input type="hidden" name="recordName[]" value="" size="13" class="input-text"/></td>\
				<td align="center">\
					<a href="javascript:;" onclick="addRecord(this)" class="sp_a_but_cir sp_a_but_padding btn btn-info">'+AddRecord+'</a>\
					<a href="javascript:;" onclick="removeRecord(this)" class="sp_a_but_cir sp_a_but_padding btn btn-danger">'+Remove+'</a>\
				</td>\
				</tr>\
				';
			if(obj == undefined)
			{
				$("#record_main_body").append(dom);
			}
			else
			{
				$(obj).parent().parent().after(dom);
			}

			if(timeRight == 1)
			{
				$("#category_div").show();
				$("#addCategory_" + size).append('<select name="moduleId" id="module_' + size+'" onchange="changeType(this.value,'+size+')"></select><select name="channelId" id="channel_' + size+'" style="width:80px;" ></select>');
				$.ajax({
					type: "GET",
					url: locationHref+"/rest/admin/vodTypes",//获取点播分类
					success: function (data) {

						var moduleObj = data;
						var moduleId;
						var moduleName
						var channelId;
						var channelName;
						var moduleId_flag = true;
						for (var i = 0; i < moduleObj.length; i++) {
							moduleId = moduleObj[i].id;
							moduleName = moduleObj[i].name;
							if(moduleName == "媒体库" || moduleId.indexOf("lu_") != "-1")
							{}
							else
							{
								var channel = moduleObj[i].subNames;
								if(channel != '')
								{
									for (var j = 0; j < channel.length; j++)
									{
										channelId = channel[j].id;
										channelName = channel[j].name;
										if (i == 2)
										{
											$("#channel_" + size).append("<option value='" + channelId + "' title='" + channelName + "'>" + channelName + "</option>");
										 	//moduleId_flag = false;
										}
									}
								}
								$("#module_" + size).append("<option value='" + moduleId + "' title='"+moduleName+"' >" + moduleName + "</option>");
							}
						}
					},
					error:function()
					{
						$("#category_div").hide();
						$("#addCategory_" + size).hide();
					}

				})
			}
			else
			{
				$("#addCategory_" + size).hide();
			}
		}


		function removeRecord(obj)
		{
			$(obj).parent().parent().remove();
		}

		function refresh()
		{
			window.location.reload();
		}

		function back()
		{
			if(timeRight == "1")
			{
				redirect('live_list.html');
			}
			else if(timeRight == "5")
			{
				redirect('live_guid_list.html');
			}
		}

		function uploadExcel()
		{
			window.top.art.dialog
			(
				{
					id:'upload',iframe:'/admin/live/record/uploadFile.jsp?liveId=${request.liveId}', title:UploadMedia, width:'400', height:'400', lock:true,window:'top'
				},
				function(){
					window.location.reload();
					window.top.art.dialog({id:'upload'}).close()
					},
				function()
				{
					window.location.reload();
					window.top.art.dialog({id:'upload'}).close()
				}
			);void(0);
		}

		function RecordInfo(liveId,name,startTime,endTime,daysOfWeek,recordName,m_moduleId,m_channelId)
		{
			this.liveId = liveId;
			this.name = name;
			this.startTime = startTime;
			this.endTime = endTime;
			this.daysOfWeek = daysOfWeek;
			this.recordName = recordName;
			this.m_moduleId = m_moduleId;
			this.m_channelId = m_channelId;
		}

		function subRecord() {
			var liveId = $.getUrlParam("id");
			var name = "";
			var startTime = "";
			var endTime = "";
			var daysOfWeek = "";
			var record = "";
			var recordName = "";
			var moduleSet;
			var channelSet;
			var array = new Array();
			$("#record_main_body").find("tr").each(function(f){
				$(this).find("input").each(function(e){
					if(e==0)
					{
						name = $(this).val();
					}
					if(e==1)
					{
						startTime = $(this).val();
					}
					if(e==2)
					{
						endTime = $(this).val();
					}
					if(e==3)
					{
						daysOfWeek = $(this).val();
					}
					if(e==4)
					{
						recordName = $(this).val();
						if(recordName == "")
						{
							var date = new Date();
							var year = date.getFullYear()+"";
							var month = date.getMonth()+1+"";
							if(month < 10)
							{
								month = 0+month;
							}
							var day = date.getDate()+"";
							var hours = date.getHours()+"";
							if(hours < 10)
							{
								hours = 0+hours;
							}
							var min = date.getMinutes()+"";
							var second = date.getSeconds()+"";
							date =year+month+day+hours+min+second;
							recordName = date;
						}
					}
				})
				$(this).find("select").each(function(e){
					if(e==0)
					{
						moduleSet = $(this).val();
					}
					else if(e==1)
					{
						channelSet = $(this).val();
					}
				})

				if(moduleSet == null)
				{
					moduleSet ="";
				}
				if(channelSet == null)
				{
					channelSet ="";
				}

				var recordInfo = new RecordInfo(liveId,name,startTime,endTime,daysOfWeek,recordName,moduleSet,channelSet);
				array[f] = recordInfo;
			})

			//alert(stringify(array));
			$.ajax({
				type: "PUT",
				url: locationHref+"/rest/admin/lives/"+liveId+"/timeRecord",//设置定时录像配置
				async: false,
				data:stringify(array),
				success: function(data)
				{
					refresh();
				},
				error: function()
				{
					alert("error");
				}
			})
		}



	</script>
<title>录像任务列表</title>
</head>
<body id="live_body_id" >
 <div class="pad-10">
  <div class="content-menu" > 
    <a href="javascript:;" id="back" onclick="back()" class="sp_but_cir sp_but_padding btn btn-info">返回</a>
 	<a href="javascript:;" id="addRecord" onclick="addRecord()" class="sp_but_cir sp_but_padding btn btn-primary">添加任务</a>
 	<a href="javascript:;" id="subRecord" onclick="subRecord()" class="sp_but_cir sp_but_padding btn btn-primary">提交更新</a>
 	<a href="javascript:;" id="refresh" onclick="refresh()" class="sp_but_cir sp_but_padding btn btn-primary">刷新状态</a>

  </div>
  <form name="myform" id="myform" action="" method="post" onsubmit="return check()">
  	<input type="hidden" id="liveId" name="id" value="">
    <div class="table-list">
		<table id="tblList" width="100%" border="0" cellpadding="8" cellspacing="0" class="table_link">
		 <thead>
		  <tr id="trHeader" valign="bottom" height="16">
		    <th align="center" id="td_1">序 号</th>
			<th align="center" id="td_2">状 态</th>
			<th align="center" width="150" id="td_3">任务名称</th>
			<th align="center" id="td_4">开始时间(00:00:00)</th>
	        <th align="center" id="td_5">结束时间(23:59:59)</th>
		    <th align="center" style="display: none;" id="category_div">分类模块</th>
			<th align="center" id="td_6">日期</th>
			<th align="center" id="td_7">操 作</th>
		  </tr>
		</thead>
		<tbody id="record_main_body">

		</tbody>  
		   <input type="button" class="dialog" value="" id="dosubmit" name="dosubmit">
	   </table>
    </div><!-- end table-list -->
 </form>
	
	 <div class="btncms" style="position:relative;padding:0px;" >
	 	<a href="javascript:;" id="back1" onclick="back()" class="sp_but_cir sp_but_padding btn btn-info">返回</a>
     	<a href="javascript:;" id="addRecord1" onclick="addRecord()" class="sp_but_cir sp_but_padding btn btn-primary">添加任务</a>
     	<a href="javascript:;" id="subRecord1" onclick="subRecord()" class="sp_but_cir sp_but_padding btn btn-primary">提交更新</a>
      </div> 

</div><!-- end pad-10 -->




</body>
</html>


