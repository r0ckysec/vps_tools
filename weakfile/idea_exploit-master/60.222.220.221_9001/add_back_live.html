<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="css/sp.css" rel="stylesheet" type="text/css" />
    <link href="css/reset.css" rel="stylesheet" type="text/css" />
    <link href="css/system.css" rel="stylesheet" type="text/css" />
    <link href="css/table_form.css" rel="stylesheet" type="text/css" />
    <link href="css/zh-cn-system.css" rel="stylesheet" type="text/css" />
    <link href="css/dialog.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="js/jquery.json-2.4.js"></script>
    <script type="text/javascript" src="js/jquery.corner.js"></script>
    <script type="text/javascript" src="js/admin_common.js"></script>
    <script type="text/javascript" src="js/dialog.js"></script>
    <script type="text/javascript" src="js/add_edit_live.js"></script>
    <script type="text/javascript" src="js/jbase64.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/json2.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
    <script type="text/javascript" src="js/bean.js"></script>
    <script type="text/javascript" src="js/changStatus.js"></script>
    <script type="text/javascript">
        var PleaseSelectTranscodingScheme;
        var addTransfer;
        $(function(){
            Init_license(authorization);
            var Languages = $.cookie('internationalization');
            if ( Languages == null || Languages == "" )
            {
                Languages = 'zh' ;
            }
            jQuery.i18n.properties({
                name : 'strings', //资源文件名称
                path : '/i18n/', //资源文件路径
                mode : 'map', //用Map的方式使用资源文件中的值
                language : Languages,
                encoding : 'UTF-8', // 必须写 否则中文乱码
                callback : function() {//加载成功后设置显示内容
                    $('#tab_setting_1').html($.i18n.prop('BasicConfiguration'));
                    $('#tab_setting_2').html($.i18n.prop('AdvancedConfiguration'));
                    $('#tab_setting_3').html($.i18n.prop('VideoConfiguration'));

                    $('#td_1').html($.i18n.prop('ApplyName')+":");
                    $('#td_2').html($.i18n.prop('LiveChannelName')+":");
                    $('#td_3').html($.i18n.prop('Alias'));
                    $('#td_5').html($.i18n.prop('VideoStoragePath')+":("+$.i18n.prop('FormatSuchAs')+":e:/data)");
                    $('#td_5_1').html($.i18n.prop('FormattingTips'));
                    $('#dataPathSelect').val($.i18n.prop('SelectPath'));
                    $('#td_7').html($.i18n.prop('ReturnDays'));
                    $('#td_9').html($.i18n.prop('FlowMode'));
                    $('#td_9_1').html($.i18n.prop('PushMode'));
                    $('#td_9_2').html($.i18n.prop('PullMode'));
                    $('#td_11').html($.i18n.prop('PullFlowAutomaticallyClosed'));
                    $('#td_11_1').html($.i18n.prop('Open'));
                    $('#td_11_2').html($.i18n.prop('Close'));
                    $('#td_12').html($.i18n.prop('ConnectionStreamAddress'));
                    $('#url').attr("title",$.i18n.prop('FlowAddressCanBe')+"&#10; rtmp://192.168.1.1:1935/live/live1&#10;rtsp://192.168.1.23&#10;udp://@234.5.6.7:9000&#10;mms://192.168.1.12/live");
                    $('#td_21').html($.i18n.prop('Enable')+" HLS");
                    $('#td_21_1').html($.i18n.prop('Disable'));
                    $('#td_21_2').html($.i18n.prop('Enable'));
                    $('#td_22').html($.i18n.prop('Enable')+" TS");
                    $('#td_22_1').html($.i18n.prop('Disable'));
                    $('#td_22_2').html($.i18n.prop('Enable'));
                    $('#td_23').html("TS " + $.i18n.prop('Address'));
                    $('#td_23_1').html($.i18n.prop('FormatSuchAs')+": 234.2.5.7:9000");
                    $("#td_33").html($.i18n.prop('DelaySeconds'));
                    $("#td_40").html($.i18n.prop('PullStream'));
                    $("#td_40_2").html($.i18n.prop('StartNowPull'));
                    $("#td_40_1").html($.i18n.prop('ClientAccessStartsPull'));
                    $("#td_50").html($.i18n.prop('PushStream'));
                    $("#td_50_2").html($.i18n.prop('StartNowPush'));
                    $("#td_50_1").html($.i18n.prop('ClientAccessStartsPush'));
                    $("#transcodingScheme").html($.i18n.prop('TranscodingScheme'));

                    addTransfer = $.i18n.prop('AddTransfer') ;
                    PleaseSelectTranscodingScheme = $.i18n.prop('PleaseSelectTranscodingScheme') ;
                }
            });
            createTfServerSelect("tfServerOuter");
        });



        function addBackLive()
        {
            var appName = $("#appName").val();
            var name = $("#liveName").val();
            var dataPath = $("#dataPath").val();
            var right = 3;
            var alias = $("#alias").val();
            var keepPlaybackDays = parseInt($("#keepPlaybackDays").val());
            var pullStream = "";
            var lazyPush;
            var lazyPull;
            var autoClosePull;
            var push = $("#isPush").val();
            if(push == "true")
            {
                push  = true;
                pullStream = null;
                lazyPush = $("#lazyPush").val();
                if(lazyPush == "true")
                {
                    lazyPush = true;
                    autoClosePull = $("#autoClosePull").val();
                    if(autoClosePull == "true")
                    {
                        autoClosePull = true;
                    }
                    else
                    {
                        autoClosePull = false;
                    }
                }
                else
                {
                    lazyPush = false;
                    autoClosePull = false;
                }
            }
            else
            {
                push = false;
                lazyPull = $("#lazyPull").val();
                if(lazyPull == "true")
                {
                    lazyPull = true;
                    autoClosePull = $("#autoClosePull").val();
                    if(autoClosePull == "true")
                    {
                        autoClosePull = true;
                    }
                    else
                    {
                        autoClosePull = false;
                    }
                }
                else
                {
                    lazyPull = false;
                    autoClosePull = false;
                }

                var tf_se = $("#tf_select").val();
                if(tf_se == "-1" || tf_se == undefined)
                {
                    tf_se = "";
                }
                var engineId = $("#engineId").val();
                if(engineId == undefined)
                {
                    engineId = "";
                }
                var url,urls;
                var arr = new Array();
                $("#main_body").find(".item").each(function(e) {
                    $(this).find("input").each(function (f) {
                        if(e == 0)
                        {
                            url = $(this).val();
                        }
                        urls = $(this).val();
                    })
                    var urlInfo = new Urls(urls);
                    arr[e] = urlInfo;
                })
                pullStream = new PullStream(url,arr,tf_se,engineId);

            }
            var playDeleay =  parseInt($("#playDeleay").val());
            var hlsStatus = false;
            var tsStatus = false;
            var enableHLS = $("#enableHLS").val();
            if(enableHLS == "true")
            {
                enableHLS = true;
                hlsStatus = true;
            }
            else
            {
                enableHLS = false;
                hlsStatus = false;
            }
            var enableTS = $("#enableTS").val();
            if(enableTS == "true")
            {
                enableTS = true;
                tsStatus = true;
            }
            else
            {
                enableTS = false;
                tsStatus = false;
            }
            var tsAddress = $("#tsAddress").val();
            var delaySeconds = parseInt($("#delaySeconds").val());
            var playback = true;
            var publishStatus = true;
            var format = "flv";

            if(alias != null && appName != null && name != null && alias != "" && appName != "" && name != ""  && dataPath != "")
            {
                var live = new LiveChannelInfoBack(alias,appName,autoClosePull,dataPath,delaySeconds,enableHLS,hlsStatus,enableTS,tsStatus,lazyPull,lazyPush,name,push,right,tsAddress,playback,keepPlaybackDays,pullStream,format,playDeleay,publishStatus);
                //alert(stringify(live));

                var flag = true;
                if(push != true)
                {
                    if(tf_se == undefined)
                    {
                        flag = false;
                        window.top.art.dialog({id:"mesg",content:PleaseSelectTranscodingScheme+"!",time:1});
                    }
                }
                if(flag)
                {
                    $.ajax({
                        type: "POST",
                        url: locationHref + "/rest/admin/lives",//添加直播频道
                        async: false,
                        data: stringify(live),
                        dataType: "json",
                        success: function (data) {
                            var appName = $("#appName").val();
                            var dataPath = $("#dataPath").val();
                            var dataPathStr = dataPath.replace(/\\/g, "/");
                            var dataPath1 = dataPathStr.substring(0, dataPathStr.indexOf("/") - 1);
                            var dataPath2 = dataPathStr.substring(dataPathStr.indexOf("/") + 1, dataPathStr.length);
                            var name = dataPath1 + dataPath2;
                            name = name.replaceAll("/", "");
                            var alias = name;
                            var vodInfo = new VodInfoBack(name, alias, dataPath, false, false);
                            $.ajax({
                                type: "POST",
                                url: locationHref + "/rest/admin/vodPaths",//添加虚拟目录
                                async: false,
                                data: stringify(vodInfo),
                                success: function (data) {

                                },
                                error: function (data) {
                                    var errorObj = data;
                                    var status = data.status;
                                    var statusText = data.statusText
                                    if (status == 401 || status == 400) {
                                        top.location.href = "login.html";
                                    }
                                }
                            });
                            window.top.art.dialog({id: 'addBack'}).close();
                        },
                        error: function (data) {
                            var errorObj = data;
                            var status = data.status;
                            var statusText = data.statusText
                            if (status == 401 || status == 400) {
                                top.location.href = "login.html";
                            }
                        }
                    });
                }
            }
        }

        String.prototype.replaceAll  = function(s1,s2){
            return this.replace(new RegExp(s1,"gm"),s2);
        }

        function m_add(obj)
        {
            var content = $("#main_body").find(".item").first().clone();
            $(content).find("input[type='text']").val("");
            $(obj).parent("div").after(content);
        }
        function m_remove(obj)
        {
            var id =  $(obj).parent("div").parent("div").attr("id");
            //if(id != "templ")
            {
                $(obj).parent("div").remove();
            }
        }
        function m_up(obj)
        {
            $(obj).parent("div").insertBefore($(obj).parent("div").prev());
            $(obj).parent("div").find("input").css("color","#990000")
            setTimeout(function(){
                $(obj).parent("div").find("input").css("color","#000")
            },800)
        }
        function m_down(obj)
        {
            $(obj).parent("div").insertAfter($(obj).parent("div").next());

            $(obj).parent("div").find("input").css("color","#990000")
            setTimeout(function(){
                $(obj).parent("div").find("input").css("color","#000")
            },800)
        }

        function checkStream(obj)
        {
            var checkVal = $(obj).parent("div").find("div").find("input").val();
            var array = new Array();
            var urls = new Urls(checkVal);
            array[0] = urls;
            $.ajax({
                type: "POST",
                url: locationHref+"/rest/admin/transfer/checkFile",//检查流是否可以
                async: false,
                data: stringify(array),
                success:function(data)
                {
                    window.top.art.dialog({id:"mesg",content:"流可正常连接!",time:1});
                },
                error:function(data)
                {
                    var errorObj = data;
                    var status = data.status;
                    var statusText = data.msg;
                    if(status == 401 || status == 400)
                    {
                        top.location.href = "login.html";
                    }
                    else if(status == 409)
                    {
                        window.top.art.dialog({id:"mesg",content:statusText+"!",time:1});
                    }
                }
            });
        }

        $(function(){
            $("input[@type=radio][name=transferStatus]").change(function(){
                var pushVal = $("#isPush").val();
                if(pushVal == "false")
                {
                    var id = $(this).attr("id");
                    if(id=="open")
                    {
                        $("#transferPlan").show();
                    }
                    else
                    {
                        $("#transferPlan").hide();
                        $("#tf_select").val("-1");
                    }
                }
                else
                {
                    $("#transferPlan").hide();
                    $("#tf_select").val("-1");
                }
            })
        })
    </script>
</head>
<body>

<form action="" method="post" onsubmit="return check()" >
    <!-- 隐藏字段 -->
    <input type="hidden" name="dialog" value="add">

    <div class="pad-10">
        <div class="col-tab">
            <ul class="tabBut cu-li">
                <li onclick="SwapTab('setting','on','',5,1);" class="on" id="tab_setting_1">基本配置</li>
            </ul>
            <div class="contentList pad-10" id="div_setting_1"><!-- 直播基本配置 -->
                <table width="100%" class="table_form ">
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_1">应用名称：</td>
                        <td align="left" ><input class="input-text lh25" type="text" id="appName" name="appName" size="56" ></td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_2">直播频道名称：</td>
                        <td align="left" ><input class="input-text" type="text" id="liveName" name="liveName" size="56"></td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_3">别名：</td>
                        <td align="left" ><input class="input-text" type="text" id="alias" name="alias" size="56" value=""></td>
                    </tr>

                    <tr valign="bottom" height="16">
                        <td align="left" id="td_5">录像存放路径:(格式如:e:/data)
                        <td align="left" >
                            <input class="input-text" type="text" id="dataPath" name="dataPath" readonly size="47" value="">
                            <input type="button" class="button" id="dataPathSelect" name="dataPathSelect" onclick="selectPath()" value="选择路径"/>
                            <!--<br/><span id="td_5_1">同一应用名称下(如:live)确保dataPath一致!</span>-->
                        </td>
                    </tr>

                    <tbody id="playbackDays_outer">
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_7">回播天数：</td>
                        <td align="left" >
                            <input class="input-text" type="text" id="keepPlaybackDays" name="keepPlaybackDays" size="56" value="7">
                        </td>
                    </tr>
                    </tbody>

                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_9">流方式：</td>
                        <td align="left" >
                            <select class="select" size="1" name="isPush" id="isPush" onchange="pull_select(this.value)">
                                <option value="true" id="td_9_1">推方式</option>
                                <option value="false" id="td_9_2">拉方式</option>
                            </select>
                        </td>
                    </tr>

                    <tbody id="pullBody"  style="display: none;">
                    <tr valign="bottom" height="16">
                        <td align="left"  id="td_40">拉流：</td>
                        <td align="left" >
                            <select class="select" size="1" name="lazyPull" id="lazyPull" onchange="select_take_pull(this.value)">
                                <option value="false" id="td_40_2">立刻启动(拉)</option>
                                <option value="true" id="td_40_1">客户端接入时启动(拉)</option>
                            </select>
                        </td>
                    </tr>
                    </tbody>
                    <tbody id="pushBody">
                    <tr valign="bottom" height="16">
                        <td align="left"  id="td_50">推流：</td>
                        <td align="left" >
                            <select class="select" size="1" name="lazyPush" id="lazyPush" onchange="select_take(this.value)">
                                <option value="false" id="td_50_2">立刻启动(推)</option>
                                <option value="true" id="td_50_1">客户端接入时启动(推)</option>
                            </select>
                        </td>
                    </tr>
                    </tbody>

                    <tbody id="take_body" style="display: none;">
                        <tr valign="bottom" height="16">
                            <td align="left" id="td_11">流自动关闭</td>
                            <td align="left" >
                                <select class="select" size="1" name="autoClosePull" id="autoClosePull">
                                    <option value="true" id="td_11_1">开启</option>
                                    <option value="false" id="td_11_2">关闭</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>

                    <tbody id="playDeleayTime" style="display: none;">
                        <tr  valign="bottom" height="16">
                            <td align="left" id="td_333">缓冲时间：</td>
                            <td align="left" ><input class="input-text" type="text" id="playDeleay" name="playDeleay" size="56" value="2"></td>
                        </tr>
                    </tbody>

                    <!-- 拉流额外设置 start -->
                    <tbody id="pull_body" style="background:#f7f7f7;display:none;">
                        <tr valign="bottom" height="16">
                            <td align="left" id="td_12">主流地址:</td>
                            <td align="left" >
                                <div id="main_body">
                                    <div class="item">
                                        <div class="mystyle" style="display: inline;">
                                            <input title="流地址可以是:
                                                rtmp://192.168.1.1:1935/live/live1
                                                rtsp://192.168.1.23
                                                udp://@234.5.6.7:9000
                                                mms://192.168.1.12/live" class="input-text" type="text" id="url" name="url" size="56" value="">
                                        </div>
                                            <a href='javascript:;' style="display: inline;" class="button" onclick='m_add(this)' title='添加' id="add">+</a>
                                            <a href='javascript:;' style="display: inline;" class="button" onclick='m_remove(this)' title='移除' id="Remove">-</a>
                                            <a href='javascript:;' style="display: inline;" class="button" onclick='m_up(this)' title='上移' id="Upward">U</a>
                                            <a href='javascript:;' style="display: inline;" class="button" onclick='m_down(this)' title='下移' id="down">D</a>
                                            <a href='javascript:;' style="display: inline;" class="button" onclick='checkStream(this)' title='流连接测试' id="check">流连接测试</a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td id="transStatus">转码状态</td>
                            <td>
                                <input type="radio" id="open" name="transferStatus" value="true">开启
                                <input type="radio" id="close" name="transferStatus" value="false" checked="checked">关闭
                            </td>
                        </tr>
                        <tbody id="transferPlan" style="background:#DDDDDD;display:none;">
                            <tr>
                                <td>
                                    <span id="transcodingScheme">转码方案 </span> :
                                </td>
                                <td>
                                    <div id="tfServerOuter" style="display:inline;"></div>
                                </td>
                            </tr>
                        </tbody>
                        <tbody id="engineIdBody" style="background:#DDDDDD;display: none;">
                            <tr valign="bottom" height="16">
                                <td align="left">插件：</td>
                                <td align="left" >
                                    <select class="select" size="1" name="engineId" id="engineId" >

                                    </select>
                                </td>
                            </tr>
                        </tbody>
                    </tbody>
                    <!-- 拉流额外设置 end -->

                    <tbody id="hls_oper">
                        <tr  valign="bottom" height="16">
                            <td align="left" id="td_21">启用HLS</td>
                            <td align="left" >
                                <select class="select" size="1" name="enableHLS" id="enableHLS">
                                    <option value="false" id="td_21_1">禁用</option>
                                    <option value="true" id="td_21_2">启用</option>
                                </select>
                            </td>
                        </tr>
                    </tbody>
                    <tbody id="ts_oper">
                        <tr  valign="bottom" height="16">
                            <td align="left" id="td_22">启用TS</td>
                            <td align="left" >
                                <select class="select" size="1" name="enableTS" id="enableTS">
                                    <option value="false" id="td_22_1">禁用</option>
                                    <option value="true" id="td_22_2">启用</option>
                                </select>
                            </td>
                        </tr>
                        <tr valign="bottom" height="16">
                            <td align="left" id="td_23">TS地址</td>
                            <td align="left" >
                                <input class="input-text" type="text" name="tsAddress" id="tsAddress" value="234.4.5.6:9000">
                                <span style="color:#990000" id="td_23_1">&nbsp;&nbsp;格式如:234.2.5.7:9000</span>
                            </td>
                        </tr>
                    </tbody>
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_33">延时直播</td>
                        <td align="left" >
                            <input class="input-text" type="text" name="delaySeconds" id="delaySeconds" value="0">
                        </td>
                    </tr>
                </table>
            </div>

            <div class="bk15"></div>
            <input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
        </div>
    </div>
</form>
<!--table_form_off-->


<script language="JavaScript">

    function SwapTab(name,cls_show,cls_hide,cnt,cur){
        for(i=1;i<=cnt;i++){
            if(i==cur){
                $('#div_'+name+'_'+i).show();
                $('#tab_'+name+'_'+i).attr('class',cls_show);
            }else{
                $('#div_'+name+'_'+i).hide();
                $('#tab_'+name+'_'+i).attr('class',cls_hide);
            }
        }
    }
    function load_file_list(id) {
        if(id=='') return false;
        $.getJSON('?m=admin&amp;c=category&amp;a=public_tpl_file_list&amp;style='+id+'&amp;catid=&amp;type=1', function(data){$('#page_template').html(data.page_template);});
    }
    //--&gt;
</script></body>


</html>
