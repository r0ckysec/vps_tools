<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>合并媒体</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/formvalidator.js"></script>
	<script type="text/javascript" src="js/formvalidatorregex.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script type="text/javascript" src="ckplayer/js/offlights.js"></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="ckplayer/ckplayer.js" charset="utf-8"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript" src="js/changStatus.js"></script>
	<script type="text/javascript">
		var SelectMedia ;
		var PleaseSelectTranscodingScheme ;
		var addTransfer;
		var PleaseInputVideoName;
		var DoNotSameName;
		var SelectDemandClassification;
		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');

			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#information_1').val($.i18n.prop('MergeVideoSelection'));
					$('#information_2').html($.i18n.prop('NewVideoInformation'));
					$('#th_1').html($.i18n.prop('MediaName'));
					$('#Choice').html($.i18n.prop('SelectVideo'));
					$('#td_1').html($.i18n.prop('NewVideoTitle'));
					$('#td_2').html($.i18n.prop('TranscodingScheme'));
					$('#td_3').html($.i18n.prop('VODCategory'));
					$('#Start').html($.i18n.prop('StartMerging'));
					$('#Close').html($.i18n.prop('Close'));

					SelectMedia = $.i18n.prop('SelectMedia') ;
					PleaseSelectTranscodingScheme = $.i18n.prop('PleaseSelectTranscodingScheme') ;
					addTransfer = $.i18n.prop('AddTransfer') ;
					PleaseInputVideoName = $.i18n.prop('PleaseInputVideoName') ;
					DoNotSameName = $.i18n.prop('DoNotSameName') ;
					SelectDemandClassification = $.i18n.prop('SelectDemandClassification') ;
				}
			});
		});

		(function($){
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			}
		})(jQuery);

		function getQueryString(key){
			var reg = new RegExp("(^|&)"+key+"=([^&]*)(&|$)");
			var result = window.location.search.substr(1).match(reg);
			return result?decodeURIComponent(result[2]):null;
		}

		var name = decodeURI(getQueryString("name"));
		var beforeName = decodeURI(getQueryString("name"));
		beforeName = beforeName.substr(0,beforeName.lastIndexOf("."));
		var datapath = decodeURI($.getUrlParam("url"));
		var id = "";
		var format = ".flv";
		$(function(){
			$.formValidator.initConfig({autotip:true,formid:"myform",onerror:function(msg){}});
			createTfServerSelect("tfServerOuter");
			createTfServerSelect_type("tfServerOuter_type");
			$("#concatname").val(name.substr(0,name.indexOf(".")));
			format = name.substr(name.indexOf("."),name.length);
			$("#datapath").val(datapath);
			$("#title").val(name.substr(0,name.indexOf(".")));
		});

		function contantMedia()
		{
			var tf_se = $("#tf_select").val();
			if(tf_se == "-1")
			{
				tf_se = "";
			}
			var tf_select_id = $("#tf_select_id").val();
			if(tf_select_id == "-1")
			{
				tf_select_id = "";
			}
			var auth = getcookie("AMS_SESSION_ID");
			var title = $("#title").val();
			var tf_select = $("#tf_select").val();
			var startTime = 0;
			var endTime = 0;
			var dataPathNew = datapath.substr(0,datapath.lastIndexOf("/")+1);
			var outFile1 = dataPathNew +title+ format;
			outFile1 = outFile1.replace("/","\\");
			var outFile = outFile1.replace("/","\\");
			var waterMark = "";
			var waterWidth = 0;
			var waterHeight = 0;
			var datapath1 = $("#datapath").val();
			var array = new Array();
			var item = new Items(0,0,datapath1);
			array[0] = item;
			var urlpath,item1;
			$("#main_tbody").find("tr").each(function(i){
				$(this).find("input").each(function(j){
					if(j==1)
					{
						urlpath = $(this).val();
					}
				})
				item1 = new Items(0,0,urlpath);
				array[i+1] = item1;
			})

			var contant = new Concat(tf_se,outFile,array,waterMark,waterWidth,waterHeight,tf_select_id);
			//alert(stringify(contant))

			if (title == "")
			{
				window.top.art.dialog({id: "mesg", content: PleaseInputVideoName+"!", time: 1});
			}
			else
			{
				if (title == beforeName)
				{
					window.top.art.dialog({id: "mesg", content: DoNotSameName+"!", time: 1});
				}
				else
				{
					$.ajax({
						type: "POST",
						url: locationHref+"/rest/admin/transfer/combine",//合并视频
						async: false,
						data: stringify(contant),
						success:function(data)
						{
							window.location.reload();
							window.top.art.dialog({id:'concat'}).close()
						},
						error:function(data)
						{
							var errorObj = data;
							var status = data.status;
							var statusText = data.statusText
							if(status == 401 || status == 400)
							{
								top.location.href = "login.html";
							}
						}

					});
				}
			}
		}

		/**
		 * 选择视频
		 */
		function m_add(obj)
		{
			var content = $(obj).parents("tr").clone(true);
			$("#main_tbody").append(content);
		}
		function m_remove(obj)
		{
			var len = $("#main_tbody").find("tr").length;
			if(len != 1)
			{
				$(obj).parents("tr").remove();
			}
		}
		function chooseDialog(obj)
		{
			window.top.art.dialog
			(
					{
						id:'24fsf5',iframe:"/media_choose.html", title:SelectMedia, width:'980', height:'520', lock:true
					},
					function()
					{
						var d = window.top.art.dialog({id:'24fsf5'}).data.iframe;
						var form = d.document.getElementById('dosubmit');
						form.click();
						var media_path = d.document.getElementById('media_path').value;
						var data_path1 = d.document.getElementById('data_path1').value;
						var media_name = "";
						media_name = media_path.substring(media_path.lastIndexOf("/")+1,media_path.lastIndexOf("."))
						$(obj).parents("tr").find("input[name='concatname']").val(media_name);
						$(obj).parents("tr").find("input[name='datapath']").val(media_path);
						window.top.art.dialog({id:'24fsf5'}).close()

						return false;
					},
					function()
					{
						window.top.art.dialog({id:'24fsf5'}).close()
					}
			);void(0);
		}


		function close_dialog()
		{
			window.top.art.dialog({id:"concat"}).close();
		}
		function click_sure()
		{
			var form = document.getElementById('dosubmit');
			form.click();
		}
	</script>
	<style type="text/css">
		.cutmedia{width:600px; height:390px;  margin:0 auto; padding-top:10px; }
		.cutmedia-item{width:450px; height:300px; float:left;  overflow:auto;position:relative}
		.iframe{float:left; width:900px;  margin-top:20px; }
		.tips{ height:20px; background:#FEFDE0; border:1px dashed #FED1A5; color:#691605; text-align:left; margin-top:0px; margin-bottom:10px; display:none}
		.warm{font-size:12px;  display: block;margin:0 auto; margin-top:10px;width:99%}
		.item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
		.item a:hover{text-decoration:none;}
		tr{ border:none;}
	</style>
</head>

<body>

<div class="cutmedia">
    <div class="common-form" style="position:relative; padding-bottom:50px;">
   		<form id="myform" method="post" action="" name="myform">
			<fieldset>&nbsp;
				<legend id="information_1">合并视频选择</legend>
					 <table width="100%" style="width:500px">
					  <thead>
						  <tr>
							  <th width="30" id="th_1">名称</th>
							  <th ></th>
						  </tr>
					  </thead>
					<tbody>
						<tr>
							 <td>
								 <input type="text" class="input-text" id="concatname" name="concatname" size="30" value="" />
								 <input type="hidden" class="input-text" name="datapath" id="datapath"  />
							 </td>
							<td></td>
						</tr>
					  </tbody>

					  <tbody id="main_tbody">
						  <tr>
							  <td>
								  <input type="text" class="input-text" name="concatname" size="30" />
								  <input type="hidden" class="input-text" name="datapath" size="30" />
							  </td>
							  <td>
								  <div style="width:150px; height:23px;" class="item">
									  <a href="javascript:;" onclick="chooseDialog(this)" style="width:80px; font-size:12px; font-weight:normal" id="Choice">选择</a>
									  <a href="javascript:;" onclick="m_add(this)">+</a>
									  <a href="javascript:;" onclick="m_remove(this)">-</a>
								  </div>
							  </td>
						  </tr>
					  </tbody>
					  <tr>
					</table>
			</fieldset>
			<fieldset style="margin-top:10px;">&nbsp;
				<legend id="information_2">新视频信息</legend>
				<table width="100%" style="width:500px;" >
					<tr >
						<td width="80" style="font-weight:bold" id="td_1">新视频标题:</td>
						<td>
							<input type="text" class="input-text"id="title" name="title" size="46" value="" />
						</td>
					</tr>
					<tr>
						<td width="80" id="td_2">转码方案</td>
						<td>
							<div id="tfServerOuter" style="display:inline;"></div>
						</td>
					</tr>
					<tr>
						<td width="80" id="td_3">点播目录</td>
						<td>
							<div id="tfServerOuter_type" style="display:inline;"></div>
						</td>
					</tr>
				</table>
			</fieldset>
		<div style="text-align:right; position: absolute; bottom:0px; right:30px;">
			<button style="margin-right:20px;" class="sp_but_cir sp_but_padding btn btn-primary" onclick="contantMedia()" id="Start">开始合并</button>
			<button class="sp_but_cir sp_but_padding btn btn-primary" value="关闭" onclick="close_dialog()" id="Close">关闭</button>
		</div>
		</form>
    </div>
</div>
</body>
</html>
