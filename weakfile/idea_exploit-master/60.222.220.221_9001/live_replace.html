<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>直播编排</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script src="js/time.js" ></script>
	<script type="text/javascript">
		var FailedToGetData ; // 获取数据失败
		var Choice ; // 选择视频
		var StartTimeIsNotAllowedToEmpty ; // 开始时间不允许为空 !
		var TheEndOfTimeShouldNotBeEmpty ; // 结束时间不允许为空 !
		var FLV_FileIsNotAllowedToEmpty ; // FLV 文件不允许为空 !
		var SelectMedia ; // 选择媒体

		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');
			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容

					$('#SpotsPrompt').html($.i18n.prop("SpotsPrompt"));
					$('#basic').html($.i18n.prop("EssentialInformation"));
					$('#td_1').html($.i18n.prop("LiveSpots")+"</br>"+$.i18n.prop("TimeFormat")+"  (00:00:00)");
					$('#ft_1').html($.i18n.prop("StartTime"));
					$('#ft_2').html($.i18n.prop("EndTime"));
					$('#ft_3').html($.i18n.prop("FLV_FilePath"));

					FailedToGetData = $.i18n.prop("FailedToGetData");
					Choice = $.i18n.prop("SelectVideo");
					$("#Choice").val(Choice);
					StartTimeIsNotAllowedToEmpty = $.i18n.prop("StartTimeIsNotAllowedToEmpty");
					TheEndOfTimeShouldNotBeEmpty = $.i18n.prop("TheEndOfTimeShouldNotBeEmpty");
					FLV_FileIsNotAllowedToEmpty = $.i18n.prop("FLV_FileIsNotAllowedToEmpty");
					SelectMedia = $.i18n.prop("SelectMedia");
				}
			});
		});

		//var objSub ="";
		(function($){
			$.ajaxSetup({ cache: false });
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			}
			var liveId = $.getUrlParam("id");
			$.ajax({
				type:"GET",
				url:locationHref+"/rest/admin/lives/"+liveId,
				success: function (data) {
					//objSub = data;
					init_whole_page(data);
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}

			})
		})(jQuery);

		function init_whole_page(obj)
		{
			var object = obj;
			var objReplace = "";
			try
			{
				objReplace = object.replaces;
			}
			catch(e)
			{
				window.top.art.dialog({id:"mesg",content:FailedToGetData+"!",time:1});
				return ;
			}
			if(objReplace != '' && objReplace.length >0)
			{
				$("#main_body").empty();
				for(var i=0;i<objReplace.length;i++)
				{
					var start_time = objReplace[i].startTime;
					var end_time = objReplace[i].endTime;
					var flv = objReplace[i].flv;

					var dom = ' <div class="item">';
					dom+= '<div class="f">';
					dom+= '<input type="text" class="input-text" value="'+start_time+'" id="startTime"  name="startTime[]" size="8" onclick="_SetTime(this)" readonly="readonly">';
					dom+= '</div>';
					dom+= '<div class="f">';
					dom+= '<input type="text" class="input-text" value="'+end_time+'" id="endTime"  name="endTime[]" size="8" onclick="_SetTime(this)" readonly="readonly">';
					dom+= '</div>';
					dom+= '<div class="f c">';
					dom+= '<input type="text" class="input-text" value="'+flv+'" id="flv" name="flv[]" size="50">';
					dom+= '&nbsp;<input type="button" class="button"  onclick="chooseDialog(this)" id="Choice"  value="'+Choice+'"/>';
					dom+= '</div>';
					dom+= '<a href="javascript:;" onclick="m_add(this)" >+</a>';
					dom+= '<a href="javascript:;" onclick="m_remove(this)">-</a>';
					dom+= '</div><!-- end item -->'

					$("#main_body").append(dom);
				}
			}
		}

		function check()
		{
			var flag = true;
			$("input[name=startTime]").each(function(){
				if($(this).val() == "")
				{
					window.top.art.dialog({id:'validate', content:StartTimeIsNotAllowedToEmpty + '!',time:1});
					flag = false;
					return false;//only break the for not return val for function
				}
			})
			if(!flag)
				return false;

			$("input[name=endTime]").each(function(){
				if($(this).val() == "")
				{
					window.top.art.dialog({id:'validate', content:TheEndOfTimeShouldNotBeEmpty+'!',time:1});
					flag = false;
					return false;//only break the for not return val for function
				}
			})
			if(!flag)
				return false;

			$("input[name=flv]").each(function(){

				if($(this).val() == "")
				{
					window.top.art.dialog({id:'validate', content:FLV_FileIsNotAllowedToEmpty+'!',time:1});
					flag = false;
					return false;//only break the for not return val for function
				}
			})

			if(!flag)
				return false;

			return true;
		}

		function addLiveReplace() {
			//var live = objSub;
			var liveId = $.getUrlParam("id");
			var arr = new Array();
			var rInfo, startTime, endTime, flv;
			$("#main_body").find(".item").each(function (e) {
				$(this).find("input").each(function (f) {
					if (f == 0) {
						startTime = $(this).val();
					}
					else if (f == 1) {
						endTime = $(this).val();
					}
					else if (f == 2) {
						flv = $(this).val();
					}
				})
				rInfo = new ReplaceFlvInfo(startTime, endTime, flv);
				arr[e] = rInfo;
			})

			$.ajax({
				type:"PUT",
				url:locationHref+"/rest/admin/lives/"+liveId+"/replace",
				async: false,
				data: stringify(arr),
				dataType:"json",
				success: function (data) {

				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}

			});
		}
		/**
		 * 选择视频
		 */
		function chooseDialog(obj)
		{
			window.top.art.dialog
			(
					{
						id:'choose',iframe:"/media_choose.html", title:SelectMedia, width:'800', height:'520', lock:true
					},
					function()
					{
						var d = window.top.art.dialog({id:'choose'}).data.iframe;
						var form = d.document.getElementById('dosubmit');
						form.click();

						var mediapath = d.document.getElementById('media_path').value;
						if(mediapath !=null && mediapath!="")
						{
							$(obj).prev("input").val(mediapath)
							window.top.art.dialog({id:'choose'}).close()
						}

						return false;
					},
					function()
					{
						window.top.art.dialog({id:'24fsf5'}).close()
					}
			);void(0);
		}
	</script>
</head>

<body>
<div class="pad-10">

	<p style="margin-bottom:10px;" id="SpotsPrompt">直播插播指的是可以使用点播文件或者是直播流替换掉指定时间内的直播内容</p>

	<div class="common-form">
		<form id="myform" method="post" action="" name="myform" onsubmit="return check()">
			<input type="hidden"  id="liveId" name="id" value="">
			<input type="hidden"  name="dialog" value="liveReplace">
			<fieldset>
				<legend id="basic">基本信息</legend>
				<table width="100%" class="table_form">
					<tbody>
					<tr>
						<td id="td_1">
							直播插播<br/>
							时间格式(00:00:00)
						</td>
						<td>
							<style type="text/css">
								.title{height:20px}
								.title .t{width: 70px;text-align: center;}
								.title .i{width:323px;text-align:center}
								.item{height:30px;}
								.item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
								.item a:hover{text-decoration:none;}
								.f{float: left;}
								.c{text-align: center}
							</style>
							<script type="text/javascript">
								function m_add(obj)
								{
									var content = $("#main_body").find(".item").first().clone();
									$(content).find("input[type='text']").val("");
									$(obj).parent("div").after(content);
								}
								function m_remove(obj)
								{
									var id =  $(obj).parent("div").parent("div").attr("id");
									var size = $("#main_body").find(".item").size();
									//if(size != 1)
									{
										$(obj).parent("div").remove();
									}
								}
							</script>
							<div class="title">
								<div class="f t"	id="ft_1">开始时间</div>
								<div class="f t"	id="ft_2">结束时间</div>
								<div class="f i"	id="ft_3">FLV文件路径</div>
							</div>


							<div id="items">
								<div id="main_body">
									<div class="item">
										<div class="f">
											<input type="text" class="input-text" value="" name="startTime" size="8" onclick="_SetTime(this)" readonly="readonly">
										</div>
										<div class="f">
											<input type="text" class="input-text" value="" name="endTime" size="8" onclick="_SetTime(this)" readonly="readonly">
										</div>
										<div class="f c">
											<input type="text" class="input-text" value="" name="flv" size="50">
											<input type="button" class="button"  onclick="chooseDialog(this)" id="Choice"  value="选择视频"/>
										</div>
										<a href="javascript:;" onclick="m_add(this)" >+</a>
										<a href="javascript:;" onclick="m_remove(this)">-</a>
									</div><!-- end item -->
								</div>
							</div> <!-- end items -->

						</td>

					</tr>

					</tbody></table>

			</fieldset>

			<input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
			<!--<a href="#" class=" sp_but_cir sp_but_padding btn btn-info" >取消</a>-->
		</form>
	</div>
</div>

</body>
</html>
