<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">
    <link rel="stylesheet" href="css/main.css">
    <link href="css/sp.css" rel="stylesheet" type="text/css" />
    <link href="css/reset.css" rel="stylesheet" type="text/css" />
    <link href="css/system.css" rel="stylesheet" type="text/css" />
    <link href="css/table_form.css" rel="stylesheet" type="text/css" />
    <link href="css/zh-cn-system.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="js/jquery.corner.js"></script>
    <script type="text/javascript" src="js/admin_common.js"></script>
    <script type="text/javascript" src="js/dialog.js"></script>
    <script type="text/javascript" src="js/add_edit_live.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/jbase64.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
    <script type="text/javascript" src="js/ref_encode.js"></script>
    <script type="text/javascript" src="js/jquery.form.js"></script>
    <script type="text/javascript" src="js/encoder.js" ></script>
    <script type="text/javascript" src="js/time.js" ></script>
    <script type="text/javascript" src="js/bean.js"></script>
    <script type="text/javascript" src="js/changStatus.js"></script>

    <style type="text/css">
        .title{height:20px}
        .title .t{width: 70px;text-align: center;}
        .title .i{width:323px;text-align:center}
        .item{height:30px;width:850px;}
        .item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
        .item a:hover{text-decoration:none;}
        .f{float: left;}
        .c{text-align: center}
        .fname{display:block;width:75px;height:25px;line-height:25px;float:left;margin-left:26px;text-align:center;}
        .ftstart{display:block;width:77px;height:25px;line-height:25px;float:left;margin-left:10px;text-align:center;}
        .id{display:block;width:77px;height:25px;line-height:25px;float:left;margin-left:10px;text-align:center;}
        .ftduration{display:block;width:77px;height:25px;line-height:25px;float:left;margin-left:10px;text-align:center;}
        .fpath{display:block;width:370px;height:25px;line-height:25px;float:left;margin-left:8px;text-align:center;}
        .ui-dialog-titlebar{
            background: rgba(0, 0, 0, 0) -moz-linear-gradient(center top , #3580cf, #85b2e3) repeat scroll 0 0;
            box-shadow: none;
            border:none;
            color:#fff;
            border-bottom-style: none;
            background:url('js/dialog/dialog/images/dialog_bar_bg.jpg') repeat-x;
        }
    </style>
    <script type="text/javascript">
        var PleaseSelectTranscodingScheme;
        var addTransfer;
        var objLive ="";
        var SelectVideo;
        var SelectMedia;
        var Open;
        var Close;
        var openStatus;
        var getresolution = "-1";
        var host = window.location.hostname;
        var port = window.location.port;
        var maxId = 0;
        var whileModeGet;
        var whileTypeGet;
        (function($){
            $.ajaxSetup({ cache: false });
            $.getUrlParam = function(name)
            {
                var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r!=null) return unescape(r[2]); return null;
            }
        })(jQuery);
        $(function(){
            Init_license(authorization);
            var Languages = $.cookie('internationalization');
            if ( Languages == null || Languages == "" )
            {
                Languages = 'zh' ;
            }
            jQuery.i18n.properties({
                name : 'strings', //资源文件名称
                path : '/i18n/', //资源文件路径
                mode : 'map', //用Map的方式使用资源文件中的值
                language : Languages,
                encoding : 'UTF-8', // 必须写 否则中文乱码
                callback : function() {//加载成功后设置显示内容
                    $('#tab_setting_1').html($.i18n.prop('BasicConfiguration'));
                    $('#td_1').html($.i18n.prop('ApplyName')+":");
                    $('#td_2').html($.i18n.prop('LiveChannelName')+":");
                    $('#td_3').html($.i18n.prop('Alias'));
                    $('#td_5').html($.i18n.prop('VideoStoragePath')+":("+$.i18n.prop('FormatSuchAs')+":e:/data)");
                    $('#td_5_1').html($.i18n.prop('FormattingTips'));
                    $('#td_21').html($.i18n.prop('Enable')+" HLS");
                    $('#td_21_1').html($.i18n.prop('Disable'));
                    $('#td_21_2').html($.i18n.prop('Enable'));
                    $('#td_22').html($.i18n.prop('Enable')+" TS");
                    $('#td_22_1').html($.i18n.prop('Disable'));
                    $('#td_22_2').html($.i18n.prop('Enable'));
                    $('#td_23').html("TS " + $.i18n.prop('Address'));
                    $('#td_23_1').html($.i18n.prop('FormatSuchAs')+": 234.2.5.7:9000");

                    $('#while_mode').html($.i18n.prop('WhileMode'));
                    $('#td_25_1').html($.i18n.prop('MoreList'));
                    $('#td_25_2').html($.i18n.prop('SimpleList'));
                    $('#while_type').html($.i18n.prop('WhileType'));
                    $('#td_24_1').html($.i18n.prop('DayLoop'));
                    $('#td_24_2').html($.i18n.prop('WeekLoop'));
                    $('#td_24_3').html($.i18n.prop('NoLoop'));

                    $('#open1').html($.i18n.prop('Open'));
                    $('#close1').html($.i18n.prop('Close'));
                    $('#transStatus').html($.i18n.prop('TranscodingState'));
                    $("#transcodingScheme").html($.i18n.prop('TranscodingScheme'));

                    SelectVideo = $.i18n.prop('SelectVideo') ;
                    SelectMedia =  $.i18n.prop('SelectMedia') ;
                    Open = $.i18n.prop('Open') ;
                    Close =  $.i18n.prop('Close') ;
                    addTransfer = $.i18n.prop('AddTransfer') ;
                    PleaseSelectTranscodingScheme = $.i18n.prop('PleaseSelectTranscodingScheme') ;
                }
            });
            createTfServerSelect("tfServerOuter");

            var liveId = $.getUrlParam("id");
            $.ajax({
                type:"GET",
                url:locationHref+"/rest/admin/lives/"+liveId,//获取一个直播频道
                success: function (data) {
                    objLive  = data;
                    var obj = data;
                    $("#appName").val(obj.appName);
                    $("#liveName").val(obj.name);
                    $("#dataPath").val(obj.dataPath);
                    $("#alias").val(obj.alias);
                    $("#enableHLS").val(obj.enableHLS+"");
                    $("#enableTS").val(obj.enableTS+"");
                    $("#tsAddress").val(obj.tsAddress);
                    if(obj.listItem != null)
                    {
                        //不能修改转码方案的
                        /* if(obj.listItem != null)
                         {
                         $("#tfServerOuter").html(obj.listItem.transfId);
                         }*/
                        //可以修改转码方案
                        if(obj.listItem != null)
                        {

                            $("#tf_select").val(obj.listItem.transfId);
                            if(obj.listItem.transfId == "")
                            {
                                $("input[type='radio'][value='false']").attr("checked",true);
                                $("#transferPlan").hide();
                            }
                            else
                            {
                                $("input[type='radio'][value='true']").attr("checked",true);
                                $("#transferPlan").show();
                            }
                            whileModeGet = parseInt(obj.listItem.mode);//单列表,多列表
                            whileTypeGet = parseInt(obj.listItem.type);//循环方式
                            if(whileModeGet == 1)
                            {
                                $("#td_24_2").show();
                                $("#td_24_3").show();
                            }
                            else
                            {
                                $("#td_24_2").hide();
                                $("#td_24_3").hide();
                            }
                            $("#whileType").val(whileTypeGet);
                            $("#whileMode").val(whileModeGet);
                        }
                    }
                    pull_select(obj.push+"");
                },
                error:function(data)
                {
                    var errorObj = data;
                    var status = data.status;
                    var statusText = data.statusText
                    if(status == 401 || status == 400)
                    {
                        top.location.href = "login.html";
                    }
                }
            })
        });
        var liveId = $.getUrlParam("id");

        function editWhileLive()
        {
            var tf_se = $("#tf_select").val();
            if(tf_se == "-1" || tf_se == undefined)
            {
                tf_se = "";
            }
            var live = objLive;
            var id = parseInt($.getUrlParam("id"));
            var itemsAll = live.listItem;
            var mvlist = itemsAll.mvlist;

            var whileType = parseInt($("#whileType").val());
            var whileMode = parseInt($("#whileMode").val());
            if(whileMode == 0)
            {
                whileType = 0;
            }
            if (whileModeGet != whileMode || whileTypeGet != whileType)
            {
                mvlist = '';
            }
            var pitems = new PlayWhileItem(mvlist,tf_se,whileType,whileMode);

            var appName = $("#appName").val();
            var name = $("#liveName").val();
            var dataPath = $("#dataPath").val();
            var right = 4;
            var alias = $("#alias").val();
            var outputMode = live.outputMode;
            var keepPlaybackDays = live.keepPlaybackDays;
            var liveProperty = live.liveProperty;
            var pullStream = live.pullStream;
            var push = live.isPush;
            var lazyPull = live.lazyPull;
            var tsStatus = live.tsStatus;
            var hlsStatus = live.hlsStatus;
            var enableHLS = $("#enableHLS").val();
            if(enableHLS == "true")
            {
                enableHLS = true;
                hlsStatus = true;
            }
            else
            {
                enableHLS = false;
                hlsStatus = false;
            }
            var enableTS = $("#enableTS").val();
            if(enableTS == "true")
            {
                enableTS = true;
                tsStatus = true;
            }
            else
            {
                enableTS = false;
                tsStatus = false;
            }
            var tsAddress = $("#tsAddress").val();
            var flvKeyframe = live.flvKeyframe;
            var recordEnabled = live.recordEnabled;
            var recordType = live.recordType;
            var recordAppend = live.recordAppend;
            var intervalTime = live.intervalTime;
            var splitFileSize = live.splitFileSize;
            var format = live.format;
            var autoClosePull = live.autoClosePull;
            var delaySeconds = live.delaySeconds;
            var enableRTP= live.enableRTP;
            var forwardUrls= live.forwardUrls;
            var ip = live.ip;
            var liveStatus = live.liveStatus;
            var outputs = live.outputs;
            var playback = live.playback;
            var publishStatus = live.publishStatus;
            var recordStatus = live.recordStatus;
            var replaces = live.replaces;
            var timeToApend = live.timeToApend;
            var type1 = live.type;
            var transferInfo = live.transferInfo;
            var items = pitems;

            var liveInfo = new LiveChannelInfoEditWhile(alias,appName,autoClosePull,dataPath,delaySeconds,enableHLS,enableRTP,enableTS,flvKeyframe,format,forwardUrls,hlsStatus,id,intervalTime,ip,keepPlaybackDays,lazyPull,liveProperty,liveStatus,
                    name,outputMode,outputs,playback,publishStatus,push,recordAppend,recordEnabled,recordStatus,recordType,replaces,right,splitFileSize,timeToApend,tsAddress,tsStatus,type1,items,pullStream,transferInfo);
           // alert(stringify(liveInfo));
            if(tf_se == undefined)
            {
                window.top.art.dialog({id:"mesg",content:PleaseSelectTranscodingScheme+"!",time:1});
            }
            else
            {
                $.ajax({
                    type: "PUT",
                    url: locationHref + "/rest/admin/lives/" + liveId,//编辑一个直播频道
                    async: false,
                    data: stringify(liveInfo),
                    dataType: "json",
                    success: function (data) {
                        window.top.art.dialog({id: 'editWhile'}).close();
                    },
                    error: function (data) {
                        var errorObj = data;
                        var status = data.status;
                        var statusText = data.statusText
                        if (status == 401 || status == 400) {
                            top.location.href = "login.html";
                        }
                    }
                });
            }
        }

        $(function(){
            $("input[@type=radio][name=transferStatus]").change(function(){
                var id = $(this).attr("id");
                if(id=="open")
                {
                    $("#transferPlan").show();
                }
                else
                {
                    $("#transferPlan").hide();
                    $("#tf_select").val("-1");
                }
            })
        })

        function select_list_mode(value)
        {
            if(value == "1")//单列表
            {
                $("#td_24_2").show();
                $("#td_24_3").show();
            }
            else//多列表
            {
                $("#td_24_2").hide();
                $("#td_24_3").hide();
            }
        }
    </script>
    <title></title>
</head>
<body>

<form action="" method="post" onsubmit="return check()" >
    <!-- 隐藏字段 -->
    <input type="hidden" id="id" name="id" value="" >
    <input type="hidden" name="dialog" value="edit">


    <div class="pad-10">
        <div class="col-tab">
            <ul class="tabBut cu-li">
                <li onclick="SwapTab('setting','on','',5,1);" class="on" id="tab_setting_1">基本配置</li>
            </ul>
            <div class="contentList pad-10" id="div_setting_1"><!-- 直播基本配置 -->
                <table width="100%" class="table_form ">
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_1">应用名称：</td>
                        <td align="left" ><input class="input-text" type="text" id="appName" name="appName" size="56" ></td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_2">直播频道名称：</td>
                        <td align="left" ><input class="input-text" type="text" id="liveName" name="liveName" size="56"></td>
                    </tr>
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_3">别名：</td>
                        <td align="left" ><input class="input-text" type="text" id="alias" name="alias" size="56" value=""></td>
                    </tr>
                    <!--<input type="hidden" name="right" id="right"/>-->
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_5">录像存放路径:(格式如:e:/data)
                        <td align="left" >
                            <input class="input-text" type="text" id="dataPath" name="dataPath" size="56" value="e:\data" readonly="readonly">
                            <br/><span id="td_5_1">同一应用名称下(如:live)确保dataPath一致!</span>
                        </td>
                    </tr>
                    <tbody id="hls_oper">
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_21">启用HLS</td>
                        <td align="left" >
                            <select class="select" size="1" name="enableHLS" id="enableHLS">
                                <option value="false" id="td_21_1">禁用</option>
                                <option value="true" id="td_21_2">启用</option>
                            </select>
                        </td>
                    </tr>
                    </tbody>
                    <tbody id="ts_oper">
                    <tr  valign="bottom" height="16">
                        <td align="left" id="td_22">启用TS</td>
                        <td align="left" >
                            <select class="select" size="1" name="enableTS" id="enableTS">
                                <option value="false" id="td_22_1">禁用</option>
                                <option value="true" id="td_22_2">启用</option>
                            </select>
                        </td>
                    </tr>
                    <tr valign="bottom" height="16">
                        <td align="left" id="td_23">TS地址</td>
                        <td align="left" >
                            <input class="input-text" type="text" name="tsAddress" id="tsAddress" value="234.4.5.6:9000">
                            <span style="color:#990000" id="td_23_1">&nbsp;&nbsp;格式如:234.2.5.7:9000</span>
                        </td>
                    </tr>
                    </tbody>
                    <tr>
                        <td id="transStatus">转码状态</td>
                        <td>
                            <input type="radio" id="open" name="transferStatus" value="true"><span id="open1">开启</span>
                            <input type="radio" id="close" name="transferStatus" value="false" checked="checked"><span id="close1">关闭</span>
                        </td>
                    </tr>
                    <tbody id="transferPlan" style="background:#DDDDDD;display:none;">
                        <tr>
                            <td>
                                <span id="transcodingScheme">转码方案 </span> :
                            </td>
                            <td>
                                <div id="tfServerOuter" style="display:inline;"></div>
                            </td>
                        </tr>
                    </tbody>
                    <tr>
                        <td id="while_mode">播出形式</td>
                        <td>
                            <select class="select" size="1" name="whileMode" id="whileMode" onchange="select_list_mode(this.value)">
                                <option value="0" id="td_25_1">多列表</option>
                                <option value="1" id="td_25_2">单列表</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td id="while_type">播出计划</td>
                        <td>
                            <select class="select" size="1" name="whileType" id="whileType">
                                <option value="0" id="td_24_1">按天循环</option>
                                <option value="1" style="display: none;" id="td_24_2">按周循环</option>
                                <option value="2" style="display: none;" id="td_24_3">不循环</option>
                            </select>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="bk15"></div>
            <input type="submit" class="dialog" value="确定" id="dosubmit" name="dosubmit">
        </div>
    </div>
</form>
<!--table_form_off-->

<script language="JavaScript">

    function SwapTab(name,cls_show,cls_hide,cnt,cur){
        for(i=1;i<=cnt;i++){
            if(i==cur){
                $('#div_'+name+'_'+i).show();
                $('#tab_'+name+'_'+i).attr('class',cls_show);
            }else{
                $('#div_'+name+'_'+i).hide();
                $('#tab_'+name+'_'+i).attr('class',cls_hide);
            }
        }
    }
    function load_file_list(id) {
        if(id=='') return false;
        $.getJSON('?m=admin&amp;c=category&amp;a=public_tpl_file_list&amp;style='+id+'&amp;catid=&amp;type=1', function(data){$('#page_template').html(data.page_template);});
    }
    //--&gt;
</script></body>
</html>
