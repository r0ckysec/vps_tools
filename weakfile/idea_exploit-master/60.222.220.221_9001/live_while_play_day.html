<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>直播编排</title>
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="js/dialog/jquery.ui.all.css"/>

	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.bgiframe-2.1.2.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.core.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.widget.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.mouse.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.draggable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.position.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.resizable.js"></script>
	<script type="text/javascript" src="js/dialog/jquery.ui.dialog.js"></script>
	<script type="text/javascript" src="js/ref_encode.js"></script>
	<script type="text/javascript" src="js/jquery.form.js"></script>
	<script type="text/javascript" src="js/encoder.js" ></script>
	<script type="text/javascript" src="js/time.js" ></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript" src="js/timeTrans.js"></script>
	<script type="text/javascript" src="js/excel.js"></script>
	<style type="text/css">
		.title{height:20px}
		.title .t{width: 70px;text-align: center;}
		.title .i{width:323px;text-align:center}
		.item{height:30px;width:1000px;}
		.item a{display:block;float:left;margin-right:5px; width:23px;height:23px;background:#ededed;border:1px solid #e0e0e0;cursor:pointer;text-align:center;line-height: 23px;font-size:18px;font-weight: bold;}
		.item a:hover{text-decoration:none;}
		.f{float: left;}
		.c{text-align: center}
		.fname{display:block;width:75px;height:25px;line-height:25px;float:left;margin-left:26px;text-align:center;}
		.ftstart{display:block;width:65px;height:25px;line-height:25px;float:left;text-align:center;}
		.id{display:block;width:185px;height:25px;line-height:25px;float:left;text-align:center;}
		.startTime{display:block;width:75px;height:25px;line-height:25px;float:left;text-align:center;}
		.stopTime{display:block;width:75px;height:25px;line-height:25px;float:left;text-align:center;}
		.fpath{display:block;width:300px;height:25px;line-height:25px;float:left;text-align:center;}
		.ftime{display:block;width:110px;height:25px;line-height:25px;float:left;text-align:center;}
		.item-name{width:200px;}
		.item-path{width:300px;}
		.item-time{width:110px;}
		.item-type{width:60px;}
		.item-startTime{width:60px;}
		.item-stopTime{width:60px;}
		.ui-dialog-titlebar{
			background: rgba(0, 0, 0, 0) -moz-linear-gradient(center top , #3580cf, #85b2e3) repeat scroll 0 0;
			box-shadow: none;
			border:none;
			color:#fff;
			border-bottom-style: none;
			background:url('js/dialog/dialog/images/dialog_bar_bg.jpg') repeat-x;
		}
	</style>
	<script type="text/javascript">
		var FLV_FileIsNotAllowedToEmpty ; //  FLV 文件不允许为空 !
		var VideoStartTimeFormatIsNotCorrect ; //  视频开始时间格式不正确
		var VideoDurationIsNotCorrect ; //  视频持续时间格式不正确
		var FailedToGetData ; // 获取数据失败
		var SelectVideo ; // 选择视频
		var Add ; // 添加
		var UpwardShift ; // 上移
		var DownwardMovement ; // 下移
		var Remove ; // 移除
		var SelectMedia ;// 选择媒体
		var objSub ="";
		var openStatus;
		var getresolution = "-1";
		var maxId = 0;
		var allItems;
		var host = window.location.hostname;
		var port = window.location.port;
		(function($){
			$.getUrlParam = function(name)
			{
				var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r!=null) return unescape(r[2]); return null;
			};
		})(jQuery);

		var whileLiveId = $.getUrlParam("id");
		var EditList;
		var AddList
		var Delete;
		var Edit;
		var PlayingNow;
		var Manualmode;
		var Timingmode;
		var Topplayer;
		var DataNotEmpty;
		$(function(){
			Init_license(authorization);
			$.ajaxSetup({ cache: false });
			var Languages = $.cookie('internationalization');
			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#OpenTranscoding').html($.i18n.prop('VideoTranscoding'));
					$('#open_Transfer').html($.i18n.prop('Open'));
					$('#close_1').html($.i18n.prop('Close'));
					$('#open_1').html($.i18n.prop('Open'));
					$('#close_Transfer').html($.i18n.prop('Close'));
					$('#transfer_button').val($.i18n.prop('CarouselConfiguration'));
					$('#cli_button').val($.i18n.prop('SliceConfiguration'));
					$('#video_path').html($.i18n.prop('VideoPath'));
					$('#video_start').html($.i18n.prop('Type'));
					$('#video_duration').html($.i18n.prop('VideoDuration'));
					$('#SelectVideo').val($.i18n.prop('VideoOnDemand'));
					$('#add').attr("title",$.i18n.prop('Add'));
					$('#Remove').attr("title",$.i18n.prop('Remove'));
					$('#Upward').attr("title",$.i18n.prop('UpwardShift'));
					$('#down').attr("title",$.i18n.prop('DownwardMovement'));
					$('#td_4').html($.i18n.prop('Name'));
					$('#td_5').html($.i18n.prop('StartTime'));
					$('#td_6').html($.i18n.prop('EndTime'));
					$("#addList").html($.i18n.prop('AddList'));
					$("#sort").val($.i18n.prop('Topplayer'))
					$("#mydialogform").val($.i18n.prop('Determine'));
					$("#mydialogform_1").val($.i18n.prop('Cancel'));
					$('#saveSimpleWhile').val($.i18n.prop('Save'));
					$('#tab_setting_1').html($.i18n.prop('TaskList'));

					FLV_FileIsNotAllowedToEmpty = $.i18n.prop('FLV_FileIsNotAllowedToEmpty') ;
					VideoStartTimeFormatIsNotCorrect = $.i18n.prop('VideoStartTimeFormatIsNotCorrect') ;
					VideoDurationIsNotCorrect = $.i18n.prop('VideoDurationIsNotCorrect') ;
					FailedToGetData = $.i18n.prop('FailedToGetData') ;
					SelectVideo = $.i18n.prop('SelectVideo') ;
					SelectMedia = $.i18n.prop('SelectMedia') ;
					Delete = $.i18n.prop('Delete') ;
					AddList = $.i18n.prop('AddList') ;
					EditList = $.i18n.prop('EditList') ;
					Edit = $.i18n.prop('Edit') ;
					PlayingNow = $.i18n.prop('PlayingNow') ;
					Manualmode = $.i18n.prop('Manualmode') ;
					Timingmode = $.i18n.prop('Timingmode') ;
					Topplayer =  $.i18n.prop('Topplayer') ;
					DataNotEmpty = $.i18n.prop('DataNotEmpty') ;

				}
			});
			var liveId = $.getUrlParam("id");
			$.ajax({
				type:"GET",
				url:locationHref+"/rest/admin/lives/"+liveId+"/lunbo/oneList",//获取一个直播频道
				success: function (data) {
					objSub = data;
					init_whole_page(data);
					//checkA(openStatus);
					if(objSub.transfId == "-1" || objSub.transfId == "")
					{
						openStatus = false;
					}
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
					else if(status == 409)
					{
						window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
					}
				}
			})
		});

		function checkA(status) {
			if (openStatus == "false") {
				$("#asize").hide();
			}
		}

		function init_whole_page(data)
		{
			$("#main_body").empty();
			var object = data;
			var tran = false;
			var transfId = object.transfId;
			if(transfId == "")
			{
				tran = false ;
			}
			else
			{
				tran = true ;
			}
			var live_type = object.type;
			var live_mode = object.mode;
			var mvlist = object.mvlist;
			if(mvlist != "")
			{
				for(var i=0;i<mvlist.length;i++)
				{
					var week = parseInt(mvlist[i].week);
					var dayLoop = mvlist[i].dayLoop;
					var date = mvlist[i].date;
					var items = mvlist[i].items;
					var dom = '';
					if(items != '')
					{
						allItems = items;
						for(var y=0;y<items.length;y++)
						{
							var status = items[y].status;
							var itemid = items[y].id;
							if(maxId < parseInt(itemid))
							{
								maxId = parseInt(itemid);
							}
							var itemname = items[y].name;
							var itemtype = items[y].type;
							var itemStartTime = items[y].startTime;
							var itemStopTime = items[y].stopTime;
							var itemvalue = items[y].value;
							var itemvalue_show = itemvalue.substr(itemvalue.lastIndexOf('/')+1,itemvalue.length);
							var itemTime = items[y].duration;
							dom+= '<div class="item">';
							dom+= '<div class="f c">';
							dom+= '<input type="hidden" id="itemid" value="'+itemid+'" size="10" class="input-text" readonly="readonly"/>';
							dom+= '<input type="text" id="itemname" value="'+itemname+'" size="30" class="input-text item-name"/>';
							dom+= '<input type="text" id="itemStartTime" value="'+itemStartTime+'" size="10" class="input-text item-startTime"/>';
							dom+= '<input type="text" id="itemStopTime" value="'+itemStopTime+'" size="10" class="input-text item-stopTime"/>';
							dom+= '<input type="text" id="type" name="type" value="'+itemtype+'" size="10" class="input-text item-type" readonly="readonly" style="background-color: #90a2bc;">';
							dom+= '<input type="text" id="flv" name="flv[]" class="input-text item-path" value="'+itemvalue_show+'" readonly size="50">';
							dom+= '<input type="hidden" id="flv1" name="flv1" class="input-text item-path" value="'+itemvalue+'" size="50">';
							dom+= '<input type="text" id="time" name="time" class="input-text item-time" value="'+itemTime+'" readonly size="15">';
							//dom+= '<input type="button" class="button"  onclick="chooseDialog(this,\''+tran+'\',\''+itemvalue+'\',1)" id="SelectVideo"  value="'+SelectVideo+'" style="margin-left:18px;"/><br/>';
							dom+= '<input type="button" class="button"  onclick="chooseDialog(this)" id="SelectVideo"  value="'+SelectVideo+'" style="margin-left:18px;"/><br/>';
							dom+= '</div>';
							dom+= '<a href="javascript:;" onclick="m_add(this)" name="add" title="添加" id="add">+</a>';
							dom+= '<a href="javascript:;" onclick="m_remove(this)" name="remove" title="移除" id="Remove">-</a>';
							dom+= '</div>';
						}
					}
					else
					{
						dom+= '<div class="item">';
						dom+= '<div class="f c">';
						dom+= '<input type="hidden" id="itemid" value="0" size="10" class="input-text" readonly="readonly"/>';
						dom+= '<input type="text" id="itemname" value="" size="30" class="input-text item-name"/>';
						dom+= '<input type="text" id="itemStartTime" value="00:00:00" size="10" class="input-text item-startTime"/>';
						dom+= '<input type="text" id="itemStopTime" value="" size="10" class="input-text item-stopTime"/>';
						dom+= '<input type="text" id="type" name="type" value="file" size="10" class="input-text item-type" readonly="readonly" style="background-color: #90a2bc;">';
						dom+= '<input type="text" id="flv" name="flv[]" class="input-text item-path" value="" readonly size="50">';
						dom+= '<input type="hidden" id="flv1" name="flv1" class="input-text item-path" value="" size="50">';
						dom+= '<input type="text" id="time" name="time" class="input-text item-time" value="" readonly size="15">';
						//dom+= '<input type="button" class="button"  onclick="chooseDialog(this,\''+tran+'\',\''+itemvalue+'\',0)" id="SelectVideo"  value="'+SelectVideo+'" style="margin-left:18px;"/><br/>';
						dom+= '<input type="button" class="button"  onclick="chooseDialog(this)" id="SelectVideo"  value="'+SelectVideo+'" style="margin-left:18px;"/><br/>';
						dom+= '</div>';
						dom+= '<a href="javascript:;" onclick="m_add(this)" name="add" title="添加" id="add">+</a>';
						dom+= '<a href="javascript:;" onclick="m_remove(this)" name="remove" title="移除" id="Remove">-</a>';
						dom+= '</div>';
					}
					$("#main_body").append(dom);
				}
			}
			else
			{
				var dom ='';
				dom+= '<div class="item">';
				dom+= '<div class="f c">';
				dom+= '<input type="hidden" id="itemid" value="0" size="10" class="input-text" readonly="readonly"/>';
				dom+= '<input type="text" id="itemname" value="" size="30" class="input-text item-name"/>';
				dom+= '<input type="text" id="itemStartTime" value="00:00:00" size="10" class="input-text item-startTime"/>';
				dom+= '<input type="text" id="itemStopTime" value="" size="10" class="input-text item-stopTime"/>';
				dom+= '<input type="text" id="type" name="type" value="file" size="10" class="input-text item-type" readonly="readonly" style="background-color: #90a2bc;">';
				dom+= '<input type="text" id="flv" name="flv[]" class="input-text item-path" value="" readonly size="50">';
				dom+= '<input type="hidden" id="flv1" name="flv1" class="input-text item-path" value="" size="50">';
				dom+= '<input type="text" id="time" name="time" class="input-text item-time" value="" readonly size="15">';
				//dom+= '<input type="button" class="button"  onclick="chooseDialog(this,\''+tran+'\',\''+itemvalue+'\')" id="SelectVideo"  value="'+SelectVideo+'" style="margin-left:18px;"/><br/>';
				dom+= '<input type="button" class="button"  onclick="chooseDialog(this)" id="SelectVideo"  value="'+SelectVideo+'" style="margin-left:18px;"/><br/>';
				dom+= '</div>';
				dom+= '<a href="javascript:;" onclick="m_add(this)" title="添加" name="add" id="add">+</a>';
				dom+= '<a href="javascript:;" onclick="m_remove(this)" name="remove" title="移除" id="Remove">-</a>';
				dom+= '</div>';
				$("#main_body").append(dom);
			}

			changeTimeForWhile();
		}

		function addSimpleWhile()
		{
			var flag = true;
			var listItem = objSub;
			var transfId = listItem.transfId;
			var whileType = listItem.type;
			var whileMode = listItem.mode;
			var mvlist = listItem.mvlist;
			var itemId,itemname,type,value,media_time,itemStartTime,itemStopTime,startTime_a,stopTime_a;
			var arr = new Array();
			$("#main_body").find(".item").each(function(e) {
				$(this).find("input").each(function (f) {
					if (f == 0) {
						itemId = $(this).val();
					}
					else if (f == 1) {
						itemname = $(this).val();
					}
					else if(f == 2){
						itemStartTime = $(this).val();
					}
					else if(f == 3){
						itemStopTime = $(this).val();
					}
					else if (f == 4) {
						type = $(this).val();
					}
					else if (f == 6) {
						value = $(this).val();
						if(value == "")
						{
							flag = false;
						}
					}
					else if(f == 7)
					{
						media_time = $(this).val();
					}
				})
				//var items = new ItemsWhilePlay(itemId,itemname,type,value,media_time);
				var items = new ItemsWhilePlayInfo(itemId,itemname,type,value,media_time,itemStartTime,itemStopTime);
				arr[e] = items;
			})

			var listId;
			if(mvlist != undefined && mvlist != "")
			{
				listId = mvlist[0].listId;
			}
			var mvlistInfo;
			if(arr != "")
			{
				mvlist = new Array();
				if(listId != undefined || listId != "")
				{
					mvlistInfo = new MvListTime(-1,'',false,arr,listId);
				}
				else
				{
					mvlistInfo = new MvListTime_noId(-1,'',false,arr);
				}
				mvlist[0] = mvlistInfo;
			}
			else
			{
				mvlist = new Array();
				mvlistInfo = new MvListTime(-1,'',false,arr,listId);
				mvlist[0] = mvlistInfo;

			}
			var listItemSub = new PlayWhileItem(mvlist,transfId,whileType,whileMode);
			//alert(stringify(listItemSub))//TODO 删除alert

			if(arr == "")
			{
				$.ajax({
					type:"PUT",
					url:locationHref+"/rest/admin/lives/"+whileLiveId+'/lunbo/oneList',//编辑一个直播频道
					async: false,
					data: stringify(listItemSub),
					dataType:"json",
					success:function(data)
					{
						window.location.reload();
					},
					error:function(data)
					{
						var errorObj = data;
						var status = data.status;
						var statusText = data.statusText
						if(status == 401 || status == 400)
						{
							top.location.href = "login.html";
						}
						else if(status == 409)
						{
							window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
						}
					}

				});
			}
			else
			{
				if(flag == true && arr.length != 0)
				{
					$.ajax({
						type:"PUT",
						url:locationHref+"/rest/admin/lives/"+whileLiveId+'/lunbo/oneList',//编辑一个直播频道
						async: false,
						data: stringify(listItemSub),
						dataType:"json",
						success:function(data)
						{
							window.location.reload();
						},
						error:function(data)
						{
							var errorObj = data;
							var status = data.status;
							var statusText = data.statusText
							if(status == 401 || status == 400)
							{
								top.location.href = "login.html";
							}
							else if(status == 409)
							{
								window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
							}
						}

					});
				}
				else
				{
					window.top.art.dialog({id:"tishi",content:DataNotEmpty+"!",time:1});
				}
			}
		}

		function m_add(obj)
		{
			maxId += 1;
			var content = $("#main_body").find(".item").first().clone();
			$(content).find("input[type='text']").val("");
			$(content).find("input[name='type']").val("file");
			$(content).find("input[name='time']").val("");
			$(content).find("input[type='button']").show();
			$(content).find("input[id='itemid']").val(maxId);
			$(obj).parent("div").after(content);
			/*var stopTime_flag = 0;
			$("#main_body").find(".item").each(function(i){
				var stopTime = parseSecond($(this).find("div").find(".item-stopTime").val());
				if(!isNaN(stopTime))
				{
					if(stopTime> stopTime_flag)
					{
						stopTime_flag = stopTime;
					}
				}
				if(stopTime_flag > 86399)
				{
					$("#main_body").find(".item").each(function(i){
						$(this).find("a[name='add']").hide();
					})
				}
			})*/
		}
		function m_remove(obj)
		{
			var id =  $(obj).parent("div").parent("div").attr("id");
			//if(id != "templ")
			{
				$(obj).parent("div").remove();
			}
		}

		function changeTimeForWhile()
		{
			$("#main_body").find(".item").each(function(i){
				var startTime = $(this).find("div").find(".item-startTime").val();
				var mediaTime= $(this).find("div").find(".item-time").val();
				if(mediaTime != null && mediaTime != "")
				{
					var stopTime = formatSecond(parseSecond(startTime) + parseSecond(mediaTime));
					$(this).find("div").find(".item-stopTime").val(stopTime);
					$(this).next(".item").find("div").find(".item-startTime").val(stopTime);
				}
			})

			var stopTime_flag = 0;
			$("#main_body").find(".item").each(function(i){
				var stopTime = parseSecond($(this).find("div").find(".item-stopTime").val());
				if(!isNaN(stopTime))
				{
					if(stopTime> stopTime_flag)
					{
						stopTime_flag = stopTime;
					}
				}
				if(stopTime_flag > 86399)
				{
					$("#main_body").find(".item").each(function(i){
						$(this).find("a[name='add']").hide();
					})
					$(this).find("div").find(".item-stopTime").val("23:59:59");
				}
				else
				{
					$("#main_body").find(".item").each(function(i){
						$(this).find("a[name='add']").show();
					})
				}
			})
		}

		var path_url = "";
		//选择视频
		function chooseDialog(obj)
		{
			choose_status = true;
			window.top.art.dialog
			(
					{
						id:'choose',iframe:"/media_while_choose.html?type="+openStatus+"&path="+encodeURI(encodeURI(path_url)), title:SelectVideo, width:'800', height:'520', lock:true
						//id:'choose',iframe:"/media_while_choose.html?type="+openStatus, title:'选择视频', width:'800', height:'520', lock:true
					},
					function()
					{
						var d = window.top.art.dialog({id:'choose'}).data.iframe;
						var form = d.document.getElementById('dosubmit');
						form.click();
						var mediapath = d.document.getElementById('media_path').value;
						var check_flag = d.document.getElementById('check_flag').value;
						var mediatime = d.document.getElementById('media_time').value;
						if(mediapath !=null && mediapath!="" && check_flag == "true")
						{
							path_url = mediapath;
							var itemvalue_show = mediapath.substr(mediapath.lastIndexOf('/')+1,mediapath.length);
							var itemname_show = itemvalue_show.substr(0,itemvalue_show.lastIndexOf('.'))
							$(obj).prev("input").prev("input").prev("input").prev("input").prev("input").prev("input").prev('input').val(itemname_show);//别名显是
							$(obj).prev("input").prev("input").prev("input").val(itemvalue_show);//显示视频路径赋值
							$(obj).prev("input").prev("input").val(mediapath);//视频全路径赋值
							$(obj).prev("input").val(mediatime);//视频时间
							changeTimeForWhile();
							window.top.art.dialog({id:'choose'}).close();
						}

						return false;
					},
					function()
					{
						window.top.art.dialog({id:'24fsf5'}).close()
					}
			);void(0);
		}

		function exportWhile()
		{
			//excel 表格输出顺序及标题
			var title=[{name:'名称'},{startTime:'开始时间'},{stopTime:'结束时间'}];
			toExcel("Export", allItems, title);
		}
	</script>
</head>

<body>
<div class="pad-10">
	<div class="col-tab">
		<ul class="tabBut cu-li">
			<li class="on" onclick="SwapTab('setting','on','',1,1);" id="tab_setting_1">任务列表</li>
		</ul>
		<div class="contentList pad-10" id="div_setting_1">
			<table width="100%" class="table_form">
				<tbody>
				<tr>
					<td colspan="2">
						<div style="float: left">
							<span class="id" id="td_4">名称</span>
							<span class="startTime" id="td_5">开始时间</span>
							<span class="stopTime" id="td_6">结束时间</span>
							<span class="ftstart" id="video_start">类型</span>
							<span class="fpath" id="video_path">视频路径</span>
							<span class="ftime" id="video_duration">视频时长</span>
						</div>
						<div id="items">
							<div id="main_body">

							</div>
						</div>
					</td>
				</tr>
				</tbody>
			</table>
			<div>
				<input type="button" class="button" id="saveSimpleWhile" onclick="addSimpleWhile()" value="保存任务" style="margin-left:820px;"/>
				<input type="button" class="button"  onclick="exportWhile()" value="导出" style="margin-left:10px;"/>
			</div>
		</div>
	</div>
</div>
</body>
</html>
