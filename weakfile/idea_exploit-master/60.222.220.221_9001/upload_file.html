<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-CN">
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <style type="text/css">
        #upimg{
            text-align: center;
            font: 8px/10px '微软雅黑','黑体',sans-serif;
            width: 300px;
            height: 10px;
            border: 1px solid green;
        }
        #load{
            width: 0%;
            height: 100%;
            background: green;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="css/main.css">
    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>

</head>
<body>
<form enctype="multipart/form-data" id="form1" action="" method="post">
    <div id="upimg">
        <div id="load"></div>
    </div>
    <input type="file" name="mof" multiple="multiple" id="moffile" style="filter: Alpha(opacity=0);opacity:10" onchange="fileChange(this)" accept=".avi,.mp4,.flv,.rmvb,.wmv,.asf,.mov,.m4v,.mkv,.m3u8"/>
    <div><div id="dianbomulu" style="display: inline;color: red;">点播目录:</div><div id="tfServerOuter" style="display: inline;"></div></div>
    <div><div id="dianbofenlei" style="display: inline;color: red;">点播分类:</div><div id="tfServerOuterTypeId" style="display: inline;"></div></div>
    <input type="button" value="上    传" class="ext_btn ext_btn_success" onclick="upfile();" style="float:right;padding-right:20px;" id="upload" />
</form>
<script type="text/javascript">
    var PleaseSelect_A_File ;
    var FileAlreadyExist ;
    var UploadPrompt ;
    var PleaseSelectUploadPath ;
    var PleaseUploadPath;
    var SelectDemandClassification;
    var OnlyOne;
    $(function(){
        Init_license(authorization);
        var Languages = $.cookie('internationalization');

        if ( Languages == null || Languages == "" )
        {
            Languages = 'zh' ;
        }
        jQuery.i18n.properties({
            name : 'strings', //资源文件名称
            path : '/i18n/', //资源文件路径
            mode : 'map', //用Map的方式使用资源文件中的值
            language : Languages,
            encoding : 'UTF-8', // 必须写 否则中文乱码
            callback : function() {//加载成功后设置显示内容
                $('#upload').val($.i18n.prop('Upload'));
                $('#Search').val($.i18n.prop('Search'));
                $('#th_1').html($.i18n.prop('SerialNumber')+'(<font color="#990000" id="total_count">0</font>)');
                $('#th_2').html($.i18n.prop('MediaName'));
                $('#th_3').html($.i18n.prop('Type'));
                $('#dianbomulu').html($.i18n.prop('VODDirectory'));
                $('#dianbofenlei').html($.i18n.prop('VODCategory'));

                PleaseSelect_A_File = $.i18n.prop('PleaseSelect_A_File') ;
                FileAlreadyExist = $.i18n.prop('FileAlreadyExist') ;
                UploadPrompt = $.i18n.prop('UploadPrompt') ;
                PleaseSelectUploadPath　=　$.i18n.prop('PleaseSelectUploadPath') ;
                PleaseUploadPath = $.i18n.prop('PleaseUploadPath') ;
                SelectDemandClassification = $.i18n.prop('SelectDemandClassification') ;
                OnlyOne = $.i18n.prop('OnlyOne') ;
            }
        });
    });

    $(function(){
        createTfServerSelect("tfServerOuter");
        createTfServerSelectTypeId('tfServerOuterTypeId');
    });

    var dom=document.getElementsByTagName('form')[0];
    var xhr = new XMLHttpRequest();
    var fd;
    var des=document.getElementById('load');
    var num=document.getElementById('upimg');
    var file;
    var LENGTH=1*1024*1024;
    var start;
    var end;
    var Body;
    var pecent;
    var filename;
    var pending;
    var id;
    var dataPath;
    var appName;
    var existence = false ;

    var fileSize_global;
    var strFileName;
    function fileChange(target)
    {
        if(navigator.userAgent.indexOf("MSIE")>0)
        {
            var filePath = target.value;
            filePath = filePath.replaceAll('\\\\','/');
            strFileName = filePath.substring(filePath.lastIndexOf('/')+1,filePath.length);
            file = new ActiveXObject("Scripting.FileSystemObject");
            var file_path = file.GetFile(filePath);
            fileSize_global = file_path.size;    // 文件大小，单位：b
        }
    }

    String.prototype.replaceAll  = function(s1,s2){
        return this.replace(new RegExp(s1,"gm"),s2);
    }

    /* function upfile()
    {
        var url;
        var tf_select = $("#tf_select").val();
        if(tf_select != "-1")
        {
            url = locationHref + "/rest/admin/upDownload/" + tf_select + "/" + strFileName + "/getFileSize";//获取远程文件大小
        }

        $.ajaxFileUpload
        (
            {
                url: url, //用于文件上传的服务器端请求地址
                secureuri: false, //一般设置为false
                fileElementId: 'moffile', //文件上传空间的id属性  <input type="file" id="file" name="file" />
                //dataType: 'json', //返回值类型 一般设置为json
                success: function (data, status)  //服务器成功响应处理函数
                {
                    alert(stringify(data))
                    /!*$("#img1").attr("src", data.imgurl);
                    if (typeof (data.error) != 'undefined') {
                        if (data.error != '') {
                            alert(data.error);
                        } else {
                            alert(data.msg);
                        }
                    }*!/
                },
                error: function (data, status, e)//服务器响应失败处理函数
                {
                    alert(e);
                }
            }
        )
    }*/

    function upfile()
    {
        var flag = true;
        if(navigator.userAgent.indexOf("MSIE")>0)
        {
            alert("暂不支持ie上传!!!")
            flag = false;
            window.top.art.dialog({id:'upload'}).close();
        }
        else
        {
            file=document.getElementsByName('mof')[0].files[0];
            fileSize_global = file.size;
            if(document.getElementsByName('mof')[0].files.length > 1)
            {
                alert(OnlyOne)
                flag = false;
            }
        }
        if(flag)
        {
            if(!file){
                alert(PleaseSelect_A_File);
                return;
            }

            var tf_select = $("#tf_select").val();
            if(tf_select != "-1")
            {
                $.ajax({
                    type:"GET",
                    url: locationHref+"/rest/admin/upDownload/"+tf_select+"/"+file.name+"/getFileSize",//获取远程文件大小
                    success: function (data) {
                        var obj = data;
                        if(obj != '')
                        {
                            var fileSize = obj.fileSize;
                            if ( fileSize >= 0 )
                            {
                                start = fileSize ;
                                if ( start == fileSize_global )
                                {
                                    existence = true ;
                                }
                                if ( existence )
                                {
                                    des.style.width=100+'%';
                                    des.innerHTML = parseInt(100)+'%'
                                    alert(FileAlreadyExist) ;
                                }
                                else
                                {
                                    up();
                                }
                            }
                        }
                    },
                    error:function(data)
                    {
                        var errorObj = data;
                        var status = data.status;
                        var statusText = data.statusText
                        if(status == 401 || status == 400)
                        {
                            top.location.href = "login.html";
                        }
                    }
                });
            }
            else
            {
                window.top.art.dialog({id:"mesg",content:PleaseUploadPath+"!",time:1});
            }
        }
    }

    function up() {
        var tf_select = $("#tf_select").val();
        var tf_select_id = $("#tf_select_id").val();
        if(tf_select_id == "-1")
        {
            tf_select_id = "";
        }
        if (start < fileSize_global)
        {
            var length = end-start;
            end = LENGTH+start;
            if(navigator.userAgent.indexOf("MSIE")>0)
            {
                Body = file.slice(start, end);
            }
            else
            {
                Body = file.slice(start, end);
            }
            $.ajax({
                type:"POST",
                processData : false,
                url: locationHref+"/rest/admin/upDownload/"+tf_select+"/"+file.name+"/"+tf_select_id+"/upload",//上传文件
                beforeSend : function(req) {
                    //req.setRequestHeader('Content-Type', "application/octet-stream");
                    req.setRequestHeader("Range","bytes="+start+"-"+end);
                    //req.setRequestHeader("Content-Length",length);
                    req.setRequestHeader("FILE_SIZE",fileSize_global);
                    req.upload.onprogress=function(ev){
                        if(ev.lengthComputable){
                            pecent=100*(ev.loaded+start)/fileSize_global;
                            if(pecent>100){
                                pecent=100;
                            }
                            //num.innerHTML=parseInt(pecent)+'%';
                            des.style.width=pecent+'%';
                            des.innerHTML = parseInt(pecent)+'%'
                        }
                    }
                    req.send(Body);
                },
                complete:function(XMLHttpRequest, textStatus)
                {
                    if(XMLHttpRequest.readyState==4){
                        if(XMLHttpRequest.status>=200&&XMLHttpRequest.status<300)
                        {
                            if (XMLHttpRequest.status == 200 )
                            {
                                start=end;
                                end=start+LENGTH;
                                //alert(start+"===="+end)
                                setTimeout('up()',1000);
                            }
                            else
                            {
                                //alert("不等于201")
                                setTimeout('up()',1000);
                            }
                        }
                        else
                        {
                            alert(UploadPrompt);
                            des.style.width='0%';
                        }
                    }

                },
                success: function (data)
                {
                    if(pecent == 100)
                    {
                        window.top.art.dialog({id:"mesg",content:"上传成功!",time:2});
                        window.top.art.dialog({id:'upload'}).close();
                        window.location.reload();
                    }
                }
            });
        }
    }
    function change(){
        des.style.width='0%';
    }

    function createTfServerSelect(div_id)
    {
        $.ajax({
            type : "GET" ,
            url : locationHref+"/rest/admin/vodPaths",//获取虚拟目录
            success: function (data)
            {
                //解析JSON
                var obj = data;
                if(obj != '' )
                {
                    var select_begin = "<select id='tf_select' name='server' class='select' ></select>"
                    $("#"+div_id).append(select_begin);
                    $("#tf_select").append("<option value='-1'>"+PleaseSelectUploadPath+"</option>");
                    for(var i=0;i<obj.length;i++)
                    {
                        id = obj[i].id;
                        dataPath = obj[i].dataPath;
                        appName = obj[i].appName;
                        var option = "<option value='"+appName+"'>"+dataPath+"</option>"
                        $("#tf_select").append(option);
                    }
                }
                $("#tf_select").change(function(){
                    var id = $(this).val();
                    for(var i=0;i<obj.length;i++)
                    {
                        if(id == obj[i].id)
                        {
                            dataPath = obj[i].dataPath;
                            appName = obj[i].appName;
                        }
                    }
                });
            }
        });
    }


    function createTfServerSelectTypeId(div_id)
    {
        $.ajax({
            type: "GET",
            url: locationHref+"/rest/admin/vodTypes",
            success: function(data)
            {
                var obj = data;
                if(obj != '')
                {
                    var select_begin = "<select id='tf_select_id' name='server' class='select' ></select>"
                    $("#"+div_id).append(select_begin);
                    $("#tf_select_id").append("<option value='-1'>"+SelectDemandClassification+"</option>");
                    for(var i=0;i<obj.length;i++)
                    {
                        var id = obj[i].id;
                        var name = obj[i].name;
                        var visible = obj[i].visible;
                        var bPublic = obj[i].bPublic;
                        var vipLevel = obj[i].vipLevel;
                        var subNames = obj[i].subNames;
                        if(id != "" && id.indexOf("lu_") == -1)
                        {
                            var option = "<option value='"+id+"'>"+name+"</option>";
                            if(subNames != '')
                            {
                                for(var j=0;j<subNames.length;j++)
                                {
                                    var subid = subNames[j].id;
                                    var subName = subNames[j].name;
                                    var subvisible = subNames[j].visible;
                                    var subBPublic = subNames[j].bPublic;
                                    var subVipLevel = subNames[j].vipLevel;
                                    option += "<option value='"+subid+"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;├─"+subName+"</option>";
                                }
                            }
                            $("#tf_select_id").append(option);
                        }
                    }
                }
            },
            error:function(data)
            {
                var errorObj = data;
                var status = data.status;
                var statusText = data.statusText
                if(status == 401 || status == 400)
                {
                    top.location.href = "login.html";
                }
                else if(status == 409)
                {
                    window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
                }
            }
        })
    }
</script>
</body>
</html>