<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" type="text/css" href="css/dialog.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/table_form.css" />

    <script type="text/javascript" src="js/jquery-1.4.1.js"></script>
    <script type="text/javascript" src="js/cookie.js"></script>
    <script type="text/javascript" src="js/bean.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
    <script type="text/javascript" src="js/dialog.js"></script>
    <script type="text/javascript" src="js/echarts.common.min.js"></script>
    <style type="text/css">
        .explain-col{ border:1px solid #ffbe7a;zoom:1; background: #fffced; padding:8px 10px; line-height:20px}
    </style>

    <script type="text/javascript">
        $(function(){
            Init_license(authorization);
            var Languages = $.cookie('internationalization');

            if ( Languages == null || Languages == "" )
            {
                Languages = 'zh' ;
            }
            jQuery.i18n.properties({
                name : 'strings', //资源文件名称
                path : '/i18n/', //资源文件路径
                mode : 'map', //用Map的方式使用资源文件中的值
                language : Languages,
                encoding : 'UTF-8', // 必须写 否则中文乱码
                callback : function() {//加载成功后设置显示内容
                    $('#timeFrame').html($.i18n.prop('TimeFrame'));
                    $('#search').val($.i18n.prop('Search'));
                }
            });
        });

    </script>
</head>

<body>
    <div class="explain-col">
        <span id="timeFrame">时间范围:</span>
        <link href="js/calendar/jscal2.css" rel="stylesheet" type="text/css" />
        <link href="js/calendar/border-radius.css" type="text/css" rel="stylesheet">
        <link href="js/calendar/win2k.css" type="text/css" rel="stylesheet">
        <script src="js/calendar/calendar.js" type="text/javascript"></script>
        <script src="js/calendar/lang/en.js" charset="utf-8" type="text/javascript"  ></script>
        <input type="text" readonly="" class="date input-text" size="20" value="" id="startTime" name="startTime">&nbsp;<script type="text/javascript">
        Calendar.setup({
            weekNumbers: true,
            inputField : "startTime",
            trigger    : "startTime",
            dateFormat: "%Y-%m-%d %H:%M:%S",
            showTime: true,
            minuteStep: 1,
            onSelect   : function() {this.hide();}
        });
    </script>-
        <input type="text" readonly="" class="date input-text" size="20" value="" id="endTime" name="endTime">&nbsp;<script type="text/javascript">
        Calendar.setup({
            weekNumbers: true,
            inputField : "endTime",
            trigger    : "endTime",
            dateFormat: "%Y-%m-%d %H:%M:%S",
            showTime: true,
            minuteStep: 1,
            onSelect   : function() {this.hide();}
        });
    </script>
        <input id="search" type="button" class="ext_btn_red ext_btn_size" value="搜索" onclick="init_whole_chart();"/>
    </div>

    <div id="main" style="width: 600px;height:400px;"></div>
    <script type="text/javascript">
        (function($){
            $.ajaxSetup({ cache: false });
            $.getUrlParam = function(name)
            {
                var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
                var r = window.location.search.substr(1).match(reg);
                if (r!=null) return unescape(r[2]); return null;
            };
        })(jQuery);
        var beforeLiveId = $.getUrlParam("id");
        var beforeProtocol = $.getUrlParam("protocol");
        var beforeVodProtocol = $.getUrlParam("vodProtocol");

        var stopTime = new Date().Format("yyyy-MM-dd HH:mm:ss");
        var startTime = new Date(new Date()-24*60*60*1000).Format("yyyy-MM-dd HH:mm:ss");;//取前一天的时间

        var zNodes = new Array();
        $(function(){
            Init_license(auth,authorization);
            $.ajaxSetup({ cache: false });
            init_whole_chart();
        })

        function init_whole_chart()
        {
            var startTime_get = $("#startTime").val();
            if(startTime_get != '')
            {
                startTime = startTime_get;
            }
            var stopTime_get = $("#endTime").val();
            if(stopTime_get != '')
            {
                stopTime = stopTime_get;
            }
            if(beforeVodProtocol == null)
            {
                $.ajax({
                    type: "GET",
                    async: false,
                    url:locationHref+"/rest/admin/flowMonitor/record/"+beforeLiveId+"/"+beforeProtocol+"/"+startTime+"/"+stopTime,//获取一个直播频道流量状态
                    success: function(data)
                    {
                        var obj = data;
                        var count = 1;
                        if(obj != '')
                        {
                            for(var i=0;i<obj.length;i++)
                            {
                                var id = obj[i].id;
                                var userCount = obj[i].userCount;//int
                                var upBitRate = obj[i].upBitRate;
                                var downBitRate = obj[i].downBitRate;
                                var upByteCount = obj[i].upByteCount;
                                var downByteCount = obj[i].downByteCount;
                                var time = obj[i].time;
                                var liveId = obj[i].liveId;
                                var protocol = obj[i].protocol;

                                var chartInfo = new Array(time,userCount);
                                zNodes[i] = chartInfo;
                            }
                            init_chart(zNodes);
                        }
                    },
                    error:function(data)
                    {
                        var errorObj = data;
                        var status = data.status;
                        var statusText = data.statusText
                        if(status == 401 || status == 400)
                        {
                            top.location.href = "login.html";
                        }
                        else if(status == 409)
                        {
                            window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
                        }
                    }
                })
            }
            else
            {
                $.ajax({
                    type: "GET",
                    async: false,
                    url:locationHref+"/rest/admin/flowMonitor/record/"+beforeVodProtocol+"/"+startTime+"/"+stopTime,//获取一个直播频道流量状态
                    success: function(data)
                    {
                        var obj = data;
                        var count = 1;
                        if(obj != '')
                        {
                            for(var i=0;i<obj.length;i++)
                            {
                                var id = obj[i].id;
                                var userCount = obj[i].userCount;//int
                                var upBitRate = obj[i].upBitRate;
                                var downBitRate = obj[i].downBitRate;
                                var upByteCount = obj[i].upByteCount;
                                var downByteCount = obj[i].downByteCount;
                                var time = obj[i].time;
                                var protocol = obj[i].protocol;

                                var chartInfo = new Array(time,userCount);
                                zNodes[i] = chartInfo;
                            }
                            init_chart(zNodes);
                        }
                    },
                    error:function(data)
                    {
                        var errorObj = data;
                        var status = data.status;
                        var statusText = data.statusText
                        if(status == 401 || status == 400)
                        {
                            top.location.href = "login.html";
                        }
                        else if(status == 409)
                        {
                            window.top.art.dialog({id:"mesg",content:statusText+"!",time:2});
                        }
                    }
                })
            }
        }


        setInterval(function ()
        {
            init_whole_chart();
        }, 3000);

        function init_chart(znodes)
        {
            echarts.init(document.getElementById('main')).setOption({
                title: {text: 'Record Chart'},
                tooltip: {},
                toolbox: {
                    feature: {
                        dataView: {}
                    }
                },
                xAxis: {
                    type: 'time',
                    splitLine:
                    {
                        show: false
                    },
                    axisLabel:{
                        interval:0//横轴信息全部显示
                    }
                },
                yAxis: {},
                series: [{
                    type: 'line',
                    smooth: true,
                    data: znodes//[[12, 5], [24, 20], [36, 36], [48, 10], [60, 10], [72, 20],[80,50],[90,100]]
                }]
            });
        }
    </script>
</body>
</html>