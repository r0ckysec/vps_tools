<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=8">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="cache-control" content="no-cache">

	<link rel="stylesheet" href="css/common.css">
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/main.css">
	<link href="css/sp.css" rel="stylesheet" type="text/css" />
	<link href="css/reset.css" rel="stylesheet" type="text/css" />
	<link href="css/system.css" rel="stylesheet" type="text/css" />
	<link href="css/table_form.css" rel="stylesheet" type="text/css" />
	<link href="css/dialog.css" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="js/jquery-1.4.1.js"></script>
	<script type="text/javascript" src="js/jquery.corner.js"></script>
	<script type="text/javascript" src="js/admin_common.js"></script>
	<script type="text/javascript" src="js/dialog.js"></script>
	<script type="text/javascript" src="js/cookie.js"></script>
	<script type="text/javascript" src="js/jquery.cookie.js"></script>
	<script type="text/javascript" src="js/jquery.i18n.properties-1.0.9.js"></script>
	<script type="text/javascript" src="js/add_edit_live.js"></script>
	<script type="text/javascript" src="js/bean.js"></script>
	<script type="text/javascript">
		var BuildingPage ;
		var Encoder ;
		var　Client ;
		var Second ;
		var Minute_1 ;
		var Hour_1 ;
		var Day ;
		var RTMPPlayClient;
		var RTMPEncoder;
		var RTSPPlayClient;
		var FLVOverHttpPlayClient;
		var TSOverHttpPlayClient;
		var FLVHttpClient;
		var MP4HttpClient;
		var HLSHttpClient;
		var OtherClient;
		var PullClient;
		var DisConnectUser;
		$(function(){
			Init_license(authorization);
			var Languages = $.cookie('internationalization');

			if ( Languages == null || Languages == "" )
			{
				Languages = 'zh' ;
			}
			jQuery.i18n.properties({
				name : 'strings', //资源文件名称
				path : '/i18n/', //资源文件路径
				mode : 'map', //用Map的方式使用资源文件中的值
				language : Languages,
				encoding : 'UTF-8', // 必须写 否则中文乱码
				callback : function() {//加载成功后设置显示内容
					$('#state').html($.i18n.prop('RefreshStatus'));
					$('#th_1').html($.i18n.prop('SerialNumber'));
					$('#th_2').html($.i18n.prop('Type'));
					$('#th_4').html($.i18n.prop('DurationOfConnection')+"("+$.i18n.prop('Second')+")");
					$('#th_5').html($.i18n.prop('LiveChannel'));
					$('#th_6').html($.i18n.prop('Operation'));

					Encoder = $.i18n.prop('Encoder') ;
					Client = $.i18n.prop('Client') ;
					BuildingPage = $.i18n.prop('BuildingPage') ;
					Second = $.i18n.prop('Second') ;
					Minute_1 = $.i18n.prop('Minute_1') ;
					Hour_1 = $.i18n.prop('Hour_1') ;
					Day = $.i18n.prop('Day') ;
					RTMPPlayClient = $.i18n.prop('RTMPPlayClient') ;
					RTMPEncoder = $.i18n.prop('RTMPEncoder') ;
					PullClient = $.i18n.prop('PullClient') ;
					RTSPPlayClient = $.i18n.prop('RTSPPlayClient') ;
					FLVOverHttpPlayClient = $.i18n.prop('FLVOverHttpPlayClient') ;
					TSOverHttpPlayClient = $.i18n.prop('TSOverHttpPlayClient') ;
					FLVHttpClient = $.i18n.prop('FLVHttpClient') ;
					MP4HttpClient = $.i18n.prop('MP4HttpClient') ;
					HLSHttpClient = $.i18n.prop('HLSHttpClient') ;
					OtherClient = $.i18n.prop('OtherClient') ;
					DisConnectUser = $.i18n.prop('DisConnectUser') ;
				}
			});
		});



		$(function(){

			init_whole_page();
		})

		function init_whole_page()
		{
			window.top.art.dialog({id:"wait",content:BuildingPage+"...<img width=20 src='images/loading.gif'>"});
			$.ajax({
				type: "GET",
				url: locationHref+"/rest/admin/system/connectionInfos",//获取在线用户
				success: function(data)
				{
					var obj = null;
					var count = 0;
					try
					{
						obj = data;
						$("#total_count").text(obj.length);
					}
					catch(e)
					{
						window.top.art.dialog({id:"wait"}).close();
						return ;
					}
					if(obj != '' && obj.length >0)
					{
						$("#main_body").empty();
						for(var i=0;i<obj.length;i++)
						{
							var ip = obj[i].ip;
							var id = obj[i].id;
							var appname = obj[i].appname;
							var livename = obj[i].livename;
							var name = appname +"/"+livename;
							var startTime = obj[i].startTime;
							var type = obj[i].type;
							//var show_img = "";
							if(type == 0)
							{
								type = RTMPPlayClient;
							}
							else if(type == 1)
							{
								type = RTMPEncoder;
							}
							else if(type == 2)
							{
								type = RTSPPlayClient;
							}
							else if(type == 3)
							{
								type = FLVOverHttpPlayClient;
							}
							else if(type == 4)
							{
								type = TSOverHttpPlayClient;
							}
							else if(type == 7)
							{
								type = HLSHttpClient;
							}
							else if(type == 8)
							{
								type = PullClient;
							}
							else if (type == 9)
							{
								type = OtherClient;
							}
							if(type != 5 && type != 6 && type != 10)
							{
								count++;
								var format_time = parseSecond(startTime);
								var del = '<a href="javascript:;" onclick="delDialog(\''+id+'\')" title="'+DisConnectUser+'" class="ext_btn_red ext_btn_size">'+DisConnectUser+'</a>&nbsp';
								var dom ='<tr >';
								dom+='<td align="center">'+count+'</td>';
								dom+='<td align="center">'+name+'</td>';
								dom+='<td align="center" >'+type+'</td>';
								dom+='<td align="center">'+id+'</td>';
								dom+='<td align="center">'+format_time+'</td>';
								dom+='<td align="center">'+del+'</td>';
								dom+='</tr>';
								$("#main_body").append(dom);
							}
					}
					}
					window.top.art.dialog({id:"wait"}).close();
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}

			})
		}

		function delDialog(id)
		{
			var info  = new DisConnectUserInfo(id);
			$.ajax({
				type: "POST",
				url: locationHref+"/rest/admin/system/disconnectUser",//断开用户
				async: false,
				data: stringify(info),
				success: function (data)
				{
					window.location.href='/live_conn_list.html';
				},
				error:function(data)
				{
					var errorObj = data;
					var status = data.status;
					var statusText = data.statusText
					if(status == 401 || status == 400)
					{
						top.location.href = "login.html";
					}
				}

			})
		}

		function refresh()
		{
			window.location.reload();
		}

		function parseSecond(seconds)
		{
			 var parseTime = seconds;
			 //seconde
			 if(parseTime<60)
				 parseTime +=Second;
			 //minute
			 else if(parseTime >= 60 && parseTime<3600)
			 {
				  var minute = parseTime/60+"";
				  if(minute.indexOf(".") != -1)
				  {
					 minute = minute.substr(0,minute.indexOf("."));
				  }
				  var second = parseTime - 60*parseInt(minute);
				  parseTime = minute+Minute_1;
				  parseTime += second+Second;

			 }
			 //hour
			 else if(parseTime>=3600 && parseTime<3600*24)
			 {
				   var hour = parseTime/3600+"";
				   if(hour.indexOf(".") != -1)
				   {
					 hour = hour.substr(0,hour.indexOf("."));
				   }
				   var minute = parseTime - 3600*parseInt(hour);
					   minute = (parseTime - 3600*parseInt(hour))/60+"";
				  if(minute.indexOf(".")!=-1)
				  {
					   minute = minute.substr(0,minute.indexOf("."));
				  }

				   var second = ((parseTime - 3600*parseInt(hour))) - 60*parseInt(minute);

				   parseTime = hour+Hour_1;
				   parseTime += minute+Minute_1;
				   parseTime += second+Second;

			  }
			  //days
			  else if(parseTime>=(3600 * 24))
			  {

				   var days = parseTime/ (3600 * 24) + "";
				   if(days.indexOf(".") != -1)
				   {
					 days = days.substr(0,days.indexOf("."));
				   }

				   var hour = (parseTime - 3600 * parseInt(days) * 24)/3600+"";
				   if(hour.indexOf(".") != -1)
				   {
					 hour = hour.substr(0,hour.indexOf("."));
				   }

				  var minute = (parseTime - 3600*parseInt(days)*24 - 3600*parseInt(hour))/60+"";
				  if(minute.indexOf(".")!=-1)
				  {
					   minute = minute.substr(0,minute.indexOf("."));
				  }

				   var second = parseTime - 3600*parseInt(days)*24 - 3600*parseInt(hour) - 60*parseInt(minute);
				   parseTime = days+Day;
				   parseTime += hour+Hour_1;
				   parseTime += minute+Minute_1;
				   parseTime += second+Second;
			  }

			   return parseTime;
		}

	</script>

	<title></title>
</head>
<body scroll="yes" style="overflow-y: scroll;">

<div class="pad-10">
  <div class="content-menu" > 
 	<a href="javascript:;" onclick="refresh()" class="ext_btn ext_btn_success" id="state">刷新状态</a>
  </div>
  <form name="myform" id="myform" action="" method="post" class="">
    <div class="table-list">
		<table id="tblList" width="100%" border="0" cellpadding="8" cellspacing="0" class="list_table">
			 <thead>
			  <tr>
			    <th align="center" width="200px" id="th_1">序 号</th>
			    <th align="center" id="th_5">频道</th>
			    <th align="center" id="th_2">类型</th>
				<th align="center" id="th_3">ID</th>
				<th align="center" id="th_4" >连接持续时间(秒)</th>
				<th align="center" id="th_6">操作</th>
			  </tr>
			</thead>
			<tbody id="main_body">

			</tbody>
		  </table>
      
    </div><!-- end table-list -->
  
 </form>
</div><!-- end pad-10 -->


</body>
</html>


